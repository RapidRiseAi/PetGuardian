<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetGuardian Care | Pricing Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* PetGuardian Care palette: Forest + Champagne + Brass */
      --pg-forest: #0B2A1E;
      --pg-pine:   #123629;
      --pg-champ:  #F3E7D3;
      --pg-stone:  #CBBFAE;
      --pg-brass:  #B08D57;
      --pg-border: rgba(176,141,87,0.26);
    }

    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1, h2, .font-display{ font-family: Sora, Inter, system-ui, sans-serif; }

    input[type="range"]{
      height: 24px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 6px;
      border-radius: 999px;
      background: rgba(243,231,211,0.20);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid var(--pg-champ);
      margin-top: -7px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }
    input[type="range"]::-moz-range-track{
      height: 6px;
      border-radius: 999px;
      background: rgba(243,231,211,0.20);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid var(--pg-champ);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    .glass{
      background: rgba(18,54,41,0.72);
      border: 1px solid var(--pg-border);
      backdrop-filter: blur(10px);
    }

    .card{
      background: rgba(18,54,41,0.55);
      border: 1px solid var(--pg-border);
    }

    .input{
      background: rgba(11,42,30,0.65);
      border: 1px solid rgba(176,141,87,0.22);
      color: var(--pg-champ);
      border-radius: 16px;
      padding: 10px 12px;
      outline: none;
    }

    /* Carousel scroll */
    .scroll-x{
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }
    .scroll-x::-webkit-scrollbar{ height: 8px; }
    .scroll-x::-webkit-scrollbar-thumb{ background: rgba(243,231,211,0.15); border-radius: 999px; }
    .snap{ scroll-snap-align: start; }
  </style>
</head>

<body class="min-h-screen"
  style="background:
    radial-gradient(1200px 700px at 20% 0%, rgba(176,141,87,0.18), transparent 60%),
    radial-gradient(900px 700px at 95% 20%, rgba(243,231,211,0.10), transparent 55%),
    var(--pg-forest);
    color: var(--pg-champ);">

  <div class="max-w-3xl mx-auto p-4 sm:p-8">
    <div class="rounded-3xl p-6 sm:p-7 shadow-2xl glass">

      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs"
               style="border: 1px solid rgba(176,141,87,0.35); background: rgba(11,42,30,0.65); color: var(--pg-stone);">
            PetGuardian Care <span style="color: var(--pg-brass);">•</span> Premium Pricing
          </div>
          <h1 class="text-2xl sm:text-3xl font-semibold font-display mt-3">Estimate your booking</h1>
          <p class="mt-2" style="color: rgba(203,191,174,0.95);">
            Choose a base stay type, then add only what you need.
          </p>
        </div>

        <div class="flex gap-2">
          <button id="copyBtn"
            class="px-4 py-2 rounded-2xl font-semibold transition"
            style="background: rgba(243,231,211,0.92); color: var(--pg-forest); border: 1px solid rgba(176,141,87,0.45);">
            Copy Quote
          </button>
          <button id="requestBtn"
            class="px-4 py-2 rounded-2xl font-semibold transition"
            style="background: transparent; color: var(--pg-champ); border: 1px solid rgba(176,141,87,0.55);">
            Request Booking
          </button>
        </div>
      </div>

      <!-- Package selection -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-6">
        <button class="pkgBtn rounded-2xl p-3 border transition" data-pkg="day">
          <div class="font-semibold">Day-only</div>
          <div class="text-xs mt-1" style="color: var(--pg-stone);">Hourly base</div>
        </button>
        <button class="pkgBtn rounded-2xl p-3 border transition" data-pkg="night">
          <div class="font-semibold">Overnight</div>
          <div class="text-xs mt-1" style="color: var(--pg-stone);">6pm to 6am</div>
        </button>
        <button class="pkgBtn rounded-2xl p-3 border transition" data-pkg="full">
          <div class="font-semibold">Full-time</div>
          <div class="text-xs mt-1" style="color: var(--pg-stone);">24h presence</div>
        </button>
      </div>

      <!-- Inputs -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
        <div class="rounded-3xl p-4 card">
          <h2 class="font-semibold font-display">Dates and Zone</h2>

          <label class="block mt-3 text-sm" style="color: var(--pg-stone);">Start date</label>
          <input id="startDate" type="date" class="w-full mt-1 input">

          <label class="block mt-3 text-sm" style="color: var(--pg-stone);">End date</label>
          <input id="endDate" type="date" class="w-full mt-1 input">

          <div class="mt-3 text-sm" style="color: var(--pg-stone);">
            Days: <span id="daysOut" class="font-semibold" style="color: var(--pg-champ);">1</span>
          </div>

          <label class="block mt-3 text-sm" style="color: var(--pg-stone);">Zone</label>
          <select id="zone" class="w-full mt-1 input">
            <option value="sabie">Sabie (Zone A)</option>
            <option value="wr">White River (Zone B)</option>
            <option value="nel">Nelspruit (Zone C)</option>
          </select>

          <div class="mt-3 flex items-center justify-between text-sm">
            <span style="color: var(--pg-stone);">Peak dates?</span>
            <label class="inline-flex items-center gap-2 cursor-pointer">
              <input id="peak" type="checkbox" class="accent-white">
              <span style="color: var(--pg-champ);">Yes</span>
            </label>
          </div>

          <div class="mt-3 flex items-center justify-between text-sm">
            <span style="color: var(--pg-stone);">Long-stay discount?</span>
            <label class="inline-flex items-center gap-2 cursor-pointer">
              <input id="longStay" type="checkbox" class="accent-white" checked>
              <span style="color: var(--pg-champ);">Yes</span>
            </label>
          </div>

          <div class="mt-3 text-xs leading-relaxed" style="color: rgba(203,191,174,0.9);">
            Discount compounds every 10 days (10 percent less per block).
          </div>
        </div>

        <div class="rounded-3xl p-4 card">
          <h2 class="font-semibold font-display">Pets and Options</h2>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-sm" style="color: var(--pg-stone);">Dogs</label>
              <input id="dogs" type="number" min="0" value="1" class="w-full mt-1 input">
            </div>
            <div>
              <label class="block text-sm" style="color: var(--pg-stone);">Cats</label>
              <input id="cats" type="number" min="0" value="0" class="w-full mt-1 input">
            </div>
          </div>

          <div id="hoursWrap" class="mt-4 hidden">
            <label class="block text-sm" style="color: var(--pg-stone);">Hours per day (Day-only)</label>
            <input id="hours" type="range" min="1" max="12" value="4" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">
              Hours: <span id="hoursOut" class="font-semibold" style="color: var(--pg-champ);">4</span>
            </div>
          </div>

          <!-- Food supplies option -->
          <div class="mt-4 rounded-2xl p-3 border"
               style="border-color: rgba(176,141,87,0.22); background: rgba(11,42,30,0.40);">
            <div class="flex items-center justify-between gap-3 text-sm">
              <div>
                <div class="font-semibold" style="color: var(--pg-champ);">Food supplies for sitter use?</div>
                <div class="text-xs mt-1" style="color: rgba(203,191,174,0.9);">
                  If allowed, deduct R50 per day.
                </div>
              </div>
              <label class="inline-flex items-center gap-2 cursor-pointer">
                <input id="foodSupplies" type="checkbox" class="accent-white">
                <span style="color: var(--pg-champ);">Allowed</span>
              </label>
            </div>

            <div id="foodNote" class="mt-2 text-xs leading-relaxed hidden"
                 style="color: rgba(203,191,174,0.95);">
              Client must store off-limits food separately or clearly mark containers and cupboards. Send photos before the booking starts.
            </div>
          </div>
        </div>
      </div>

      <!-- Add-ons -->
      <div class="rounded-3xl p-4 border mt-4"
           style="background: rgba(18,54,41,0.55); border-color: var(--pg-border);">
        <h2 class="font-semibold font-display">Add-ons</h2>
        <div class="text-xs mt-1" style="color: rgba(203,191,174,0.9);">
          All add-ons apply on top of the base stay price.
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Update packs (0 to 2 per day)</label>
            <input id="updates" type="range" min="0" max="2" value="0" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">Qty:
              <span id="updatesOut" class="font-semibold" style="color: var(--pg-champ);">0</span>
            </div>
          </div>

          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Check-ins (0 to 3 per day)</label>
            <input id="checkins" type="range" min="0" max="3" value="0" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">Qty:
              <span id="checkinsOut" class="font-semibold" style="color: var(--pg-champ);">0</span>
            </div>
            <div class="text-xs mt-1" style="color: rgba(203,191,174,0.9);">
              Fuel rule: if zone has travel fee, each check-in adds that fuel cost.
            </div>
          </div>

          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Walks 15 min (0 to 3 per day)</label>
            <input id="walk15" type="range" min="0" max="3" value="0" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">Qty:
              <span id="walk15Out" class="font-semibold" style="color: var(--pg-champ);">0</span>
            </div>
          </div>

          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Walks 30 min (0 to 3 per day)</label>
            <input id="walk30" type="range" min="0" max="3" value="0" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">Qty:
              <span id="walk30Out" class="font-semibold" style="color: var(--pg-champ);">0</span>
            </div>
          </div>

          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Walks 60 min (0 to 3 per day)</label>
            <input id="walk60" type="range" min="0" max="3" value="0" class="w-full mt-2">
            <div class="text-sm" style="color: var(--pg-stone);">Qty:
              <span id="walk60Out" class="font-semibold" style="color: var(--pg-champ);">0</span>
            </div>
          </div>

          <div class="space-y-2">
            <label class="flex items-center justify-between text-sm">
              <span style="color: var(--pg-stone);">Oral meds</span>
              <input id="meds" type="checkbox" class="accent-white">
            </label>
            <label class="flex items-center justify-between text-sm">
              <span style="color: var(--pg-stone);">High-care routine</span>
              <input id="highcare" type="checkbox" class="accent-white">
            </label>
            <label class="flex items-center justify-between text-sm">
              <span style="color: var(--pg-stone);">Home care pack</span>
              <input id="homecare" type="checkbox" class="accent-white">
            </label>

            <div class="grid grid-cols-2 gap-3 pt-2">
              <div>
                <label class="block text-sm" style="color: var(--pg-stone);">Key trips (one-time)</label>
                <input id="keys" type="number" min="0" value="0" class="w-full mt-1 input">
              </div>
              <div>
                <label class="block text-sm" style="color: var(--pg-stone);">Pet taxi (one-time)</label>
                <input id="taxi" type="number" min="0" value="0" class="w-full mt-1 input">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Staff availability carousel -->
      <div class="rounded-3xl p-4 card mt-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="font-semibold font-display">Available sitters</h2>
            <div class="text-xs mt-1" style="color: rgba(203,191,174,0.9);">
              Select who you want. Availability updates based on your dates and stay type.
            </div>
          </div>
          <div id="staffStatus" class="text-xs" style="color: rgba(203,191,174,0.95);">Loading…</div>
        </div>

        <div id="staffCarousel" class="scroll-x mt-4"></div>

        <div id="staffEmpty" class="mt-3 hidden text-sm" style="color: rgba(203,191,174,0.95);">
          No staff available for these dates. Try different dates or stay type.
        </div>
      </div>

      <!-- Outputs -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="rounded-3xl p-4 border"
             style="background: rgba(11,42,30,0.45); border-color: var(--pg-border);">
          <div class="text-sm" style="color: var(--pg-stone);">Total estimate</div>
          <div id="totalOut" class="text-2xl font-black mt-1 font-display">R0</div>
          <div class="text-xs mt-2" style="color: rgba(11,42,30,0.65); background: rgba(243,231,211,0.85); padding: 8px 10px; border-radius: 14px;">
            Deposit required: <span id="depositOut" class="font-semibold">R0</span><br>
            Balance after: <span id="balanceOut" class="font-semibold">R0</span>
          </div>
        </div>

        <div class="rounded-3xl p-4 border"
             style="background: rgba(11,42,30,0.45); border-color: var(--pg-border);">
          <div class="text-sm" style="color: var(--pg-stone);">Breakdown</div>
          <div class="text-sm mt-2" style="color: rgba(203,191,174,0.95);">
            Base stay: <span id="baseOut" class="font-semibold" style="color: var(--pg-champ);">R0</span><br>
            Add-ons + travel: <span id="addonsOut" class="font-semibold" style="color: var(--pg-champ);">R0</span><br>
            One-time fees: <span id="oneTimeOut" class="font-semibold" style="color: var(--pg-champ);">R0</span>
          </div>
          <div id="discountOut" class="text-xs mt-2" style="color: rgba(203,191,174,0.9);"></div>
        </div>

        <div class="rounded-3xl p-4 border"
             style="background: rgba(18,54,41,0.55); border-color: var(--pg-border);">
          <div class="text-sm" style="color: var(--pg-stone);">Deposit terms</div>
          <div class="text-sm mt-2" style="color: rgba(203,191,174,0.95); line-height: 1.5;">
            50% deposit to secure booking.<br>
            Remaining 50% due after service.
          </div>
          <div class="text-xs mt-3" style="color: rgba(203,191,174,0.9);">
            Final price confirmed after screening and availability.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Booking Modal -->
  <div id="modalWrap" class="fixed inset-0 hidden" style="background: rgba(0,0,0,0.65);">
    <div class="max-w-xl mx-auto p-4 sm:p-8">
      <div class="rounded-3xl p-5 sm:p-6 glass">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs" style="color: var(--pg-stone);">Request Booking</div>
            <div class="text-xl font-display font-semibold mt-1">Your details</div>
            <div class="text-xs mt-2" style="color: rgba(203,191,174,0.95);">
              We will email an invoice/estimate. Deposit required is 50%.
            </div>
          </div>
          <button id="closeModal" class="px-3 py-2 rounded-2xl"
            style="border: 1px solid rgba(176,141,87,0.35); color: var(--pg-champ);">Close</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Full name</label>
            <input id="custName" class="w-full mt-1 input" placeholder="Your name">
          </div>
          <div>
            <label class="block text-sm" style="color: var(--pg-stone);">Phone</label>
            <input id="custPhone" class="w-full mt-1 input" placeholder="e.g. 081 532 8774">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm" style="color: var(--pg-stone);">Email</label>
            <input id="custEmail" class="w-full mt-1 input" placeholder="you@example.com">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm" style="color: var(--pg-stone);">Address or area</label>
            <input id="custAddress" class="w-full mt-1 input" placeholder="Street or area">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm" style="color: var(--pg-stone);">Notes</label>
            <textarea id="custNotes" rows="3" class="w-full mt-1 input" placeholder="Routine, meds, temperament, gate access, etc."></textarea>
          </div>

          <!-- Honeypot (spam trap) -->
          <div class="hidden">
            <label>Website</label>
            <input id="hpField" class="w-full mt-1 input" placeholder="Leave blank">
          </div>
        </div>

        <div class="rounded-2xl p-3 mt-4" style="background: rgba(11,42,30,0.45); border: 1px solid rgba(176,141,87,0.20);">
          <div class="text-xs" style="color: var(--pg-stone);">Summary</div>
          <div id="modalSummary" class="text-sm mt-2" style="color: rgba(203,191,174,0.95);"></div>
        </div>

        <div class="flex items-center justify-between gap-3 mt-4">
          <div class="text-xs" style="color: rgba(203,191,174,0.9);">
            By requesting, you agree to deposit terms.
          </div>
          <button id="submitBooking"
            class="px-4 py-2 rounded-2xl font-semibold"
            style="background: rgba(243,231,211,0.92); color: var(--pg-forest); border: 1px solid rgba(176,141,87,0.45);">
            Send Request
          </button>
        </div>

        <div id="submitStatus" class="text-xs mt-3" style="color: rgba(203,191,174,0.95);"></div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const CONFIG = {
    businessName: "PetGuardian Care",
    depositPercent: 0.50,

    // Paste your Apps Script Web App URL here (after you deploy it)
    apiBaseUrl: "https://script.google.com/macros/s/AKfycbzfqeIQFLpa155Gf-454kbaSQUEw9RpiqISwnPbSkfYPV-aU6LZlbTbkG5jv-sHe6jp/exec",

    // If you implement the script "apiKey" check, paste it here. Note: public pages cannot hide secrets.
    apiKey: ""
  };

  // Pricing constants (client-side estimate)
  const PRICES = {
    base: { dayHourly: 40, night: 150, fullDay: 320 },
    travelPerDay: { sabie: 0, wr: 30, nel: 60 },
    peakMultiplier: 1.15,

    add: {
      updatePackPerDay: 50,
      checkin: 50,
      walk15: 30,
      walk30: 50,
      walk60: 90,
      medsPerDay: 50,
      highcarePerDay: 100,
      homecarePerDay: 30,
      foodSuppliesCreditPerDay: 50,
      extraDogPerDay: 50,
      extraCatPerDay: 30,
      keyTrip: 50,
      petTaxi: 150
    },

    longStay: { blockDays: 10, factor: 0.9 }
  };

  // =========================
  // Helpers
  // =========================
  let pkg = "day";
  let selectedStaff = null; // {id,name,email,...} from availability endpoint
  let lastAvailabilityReqId = 0;

  const el = (id) => document.getElementById(id);
  const money = (n) => "R" + Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  function daysBetween(start, end) {
    if (!start || !end) return 1;
    const s = new Date(start);
    const e = new Date(end);
    const diff = Math.round((e - s) / (1000*60*60*24)) + 1;
    return Math.max(1, diff);
  }

  function weightedDays(days) {
    const { blockDays, factor } = PRICES.longStay;
    const blocks = Math.floor(days / blockDays);
    const rem = days % blockDays;
    if (blocks === 0) return days;
    return blockDays * (1 - Math.pow(factor, blocks)) / (1 - factor) + rem * Math.pow(factor, blocks);
  }

  function includedPetCount(dogs, cats) {
    if (dogs > 0) return { incDogs: 1, incCats: 0 };
    if (cats > 0) return { incDogs: 0, incCats: 1 };
    return { incDogs: 0, incCats: 0 };
  }

  function pkgLabel() {
    if (pkg === "day") return "Day-only";
    if (pkg === "night") return "Overnight";
    return "Full-time";
  }

  function zoneLabel() {
    return el("zone").selectedOptions[0].textContent;
  }

  // =========================
  // UI states
  // =========================
  function setPkgUI() {
    document.querySelectorAll(".pkgBtn").forEach(b => {
      const active = b.dataset.pkg === pkg;

      // Active: slightly transparent white (champagne), black text
      b.style.background = active ? "rgba(243,231,211,0.86)" : "rgba(11,42,30,0.55)";
      b.style.borderColor = active ? "rgba(176,141,87,0.70)" : "rgba(176,141,87,0.28)";
      b.style.color = active ? "#0B2A1E" : "var(--pg-champ)";
      b.style.backdropFilter = active ? "blur(8px)" : "none";
    });

    el("hoursWrap").classList.toggle("hidden", pkg !== "day");
  }

  // =========================
  // Availability (JSONP to avoid CORS headaches)
  // =========================
  window.pgAvailabilityCallback = function(payload) {
    // Ignore stale responses
    if (!payload || payload.reqId !== lastAvailabilityReqId) return;

    const list = payload.staff || [];
    renderStaffCarousel(list);

    el("staffStatus").textContent = list.length ? "Select a sitter" : "None available";
    el("staffEmpty").classList.toggle("hidden", list.length !== 0);
  };

  function fetchAvailability() {
    if (!CONFIG.apiBaseUrl || CONFIG.apiBaseUrl.startsWith("PASTE_")) {
      el("staffStatus").textContent = "API not connected yet";
      return;
    }

    el("staffStatus").textContent = "Checking…";

    const start = el("startDate").value;
    const end = el("endDate").value;
    const zone = el("zone").value;

    lastAvailabilityReqId += 1;
    const reqId = lastAvailabilityReqId;

    // Remove any previous JSONP script tag
    const old = document.getElementById("jsonpAvail");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    url.searchParams.set("action", "availability");
    url.searchParams.set("start", start);
    url.searchParams.set("end", end);
    url.searchParams.set("pkg", pkg);
    url.searchParams.set("zone", zone);
    url.searchParams.set("reqId", String(reqId));
    url.searchParams.set("callback", "pgAvailabilityCallback");

    const script = document.createElement("script");
    script.id = "jsonpAvail";
    script.src = url.toString();
    script.onerror = () => {
      el("staffStatus").textContent = "Could not load availability";
    };
    document.body.appendChild(script);
  }

  function renderStaffCarousel(staffList) {
    const wrap = el("staffCarousel");
    wrap.innerHTML = "";
    selectedStaff = null;

    staffList.forEach((s) => {
      const card = document.createElement("button");
      card.type = "button";
      card.className = "snap rounded-3xl p-3 border text-left min-w-[260px] transition";
      card.style.background = "rgba(11,42,30,0.55)";
      card.style.borderColor = "rgba(176,141,87,0.24)";
      card.style.color = "var(--pg-champ)";

      card.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${escapeHtml(s.photoUrl || '')}" alt="${escapeHtml(s.name || 'Sitter')}"
               class="w-14 h-14 rounded-2xl object-cover border"
               style="border-color: rgba(176,141,87,0.28); background: rgba(0,0,0,0.2);">
          <div class="min-w-0">
            <div class="font-semibold font-display truncate">${escapeHtml(s.name || "Sitter")}</div>
            <div class="text-xs mt-1" style="color: var(--pg-stone);">
              ${escapeHtml(s.title || "PetGuardian Care Sitter")}
            </div>
          </div>
        </div>

        <div class="text-sm mt-3" style="color: rgba(203,191,174,0.95); line-height: 1.45;">
          ${escapeHtml(s.bio || "Professional sitter")}
        </div>

        <div class="mt-3 flex items-center justify-between text-xs" style="color: rgba(203,191,174,0.95);">
          <div>Rating: <span class="font-semibold" style="color: var(--pg-champ);">${escapeHtml(String(s.rating || "5.0"))}</span></div>
          <div class="px-2 py-1 rounded-full"
               style="border: 1px solid rgba(176,141,87,0.22); background: rgba(18,54,41,0.55);">
            Select
          </div>
        </div>
      `;

      card.addEventListener("click", () => {
        // clear old selection styling
        [...wrap.children].forEach((c) => {
          c.style.background = "rgba(11,42,30,0.55)";
          c.style.borderColor = "rgba(176,141,87,0.24)";
          c.style.color = "var(--pg-champ)";
        });

        card.style.background = "rgba(243,231,211,0.86)";
        card.style.borderColor = "rgba(176,141,87,0.70)";
        card.style.color = "#0B2A1E";
        selectedStaff = s;
      });

      wrap.appendChild(card);
    });
  }

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // =========================
  // Pricing calculation
  // =========================
  function calc() {
    const start = el("startDate").value;
    const end = el("endDate").value;
    const days = daysBetween(start, end);
    el("daysOut").textContent = days;

    const zone = el("zone").value;
    const travel = PRICES.travelPerDay[zone];

    const peakMult = el("peak").checked ? PRICES.peakMultiplier : 1;

    const applyLong = el("longStay").checked;
    const wDays = applyLong ? weightedDays(days) : days;

    const dogs = Math.max(0, parseInt(el("dogs").value || "0", 10));
    const cats = Math.max(0, parseInt(el("cats").value || "0", 10));
    const { incDogs, incCats } = includedPetCount(dogs, cats);
    const extraDogs = Math.max(0, dogs - incDogs);
    const extraCats = Math.max(0, cats - incCats);

    const hours = parseInt(el("hours").value || "1", 10);
    el("hoursOut").textContent = hours;

    const updates = parseInt(el("updates").value || "0", 10); el("updatesOut").textContent = updates;
    const checkins = parseInt(el("checkins").value || "0", 10); el("checkinsOut").textContent = checkins;
    const w15 = parseInt(el("walk15").value || "0", 10); el("walk15Out").textContent = w15;
    const w30 = parseInt(el("walk30").value || "0", 10); el("walk30Out").textContent = w30;
    const w60 = parseInt(el("walk60").value || "0", 10); el("walk60Out").textContent = w60;

    const meds = el("meds").checked;
    const highcare = el("highcare").checked;
    const homecare = el("homecare").checked;

    const foodAllowed = el("foodSupplies").checked;
    el("foodNote").classList.toggle("hidden", !foodAllowed);

    const keys = Math.max(0, parseInt(el("keys").value || "0", 10));
    const taxi = Math.max(0, parseInt(el("taxi").value || "0", 10));

    let basePerDay = 0;
    if (pkg === "day") basePerDay = hours * PRICES.base.dayHourly;
    if (pkg === "night") basePerDay = PRICES.base.night;
    if (pkg === "full") basePerDay = PRICES.base.fullDay;

    // Check-in fuel rule
    const checkinUnit = PRICES.add.checkin + (travel > 0 ? travel : 0);

    const addOnsPerDay =
      (updates * PRICES.add.updatePackPerDay) +
      (checkins * checkinUnit) +
      (w15 * PRICES.add.walk15) +
      (w30 * PRICES.add.walk30) +
      (w60 * PRICES.add.walk60) +
      (meds ? PRICES.add.medsPerDay : 0) +
      (highcare ? PRICES.add.highcarePerDay : 0) +
      (homecare ? PRICES.add.homecarePerDay : 0) +
      (foodAllowed ? -PRICES.add.foodSuppliesCreditPerDay : 0) +
      (extraDogs * PRICES.add.extraDogPerDay) +
      (extraCats * PRICES.add.extraCatPerDay) +
      travel;

    const oneTime = (keys * PRICES.add.keyTrip) + (taxi * PRICES.add.petTaxi);

    const dailyAfterPeak = (basePerDay + addOnsPerDay) * peakMult;
    const stayTotal = dailyAfterPeak * wDays;
    const total = stayTotal + oneTime;

    const noDiscountTotal = dailyAfterPeak * days + oneTime;
    const discountAmt = applyLong ? (noDiscountTotal - total) : 0;

    const deposit = total * CONFIG.depositPercent;
    const balance = total - deposit;

    // Display
    el("totalOut").textContent = money(total);
    el("depositOut").textContent = money(deposit);
    el("balanceOut").textContent = money(balance);

    el("baseOut").textContent = money((basePerDay * peakMult) * wDays);
    el("addonsOut").textContent = money((addOnsPerDay * peakMult) * wDays);
    el("oneTimeOut").textContent = money(oneTime);

    el("discountOut").textContent = applyLong
      ? `Long-stay discount applied: ${money(discountAmt)}`
      : "";

    return {
      total, deposit, balance, days, wDays, zone, travel, peakMult, basePerDay,
      addOnsPerDay, oneTime,
      inputs: {
        pkg,
        start, end,
        dogs, cats,
        hours,
        updates, checkins, w15, w30, w60,
        meds, highcare, homecare,
        foodAllowed,
        keys, taxi,
        longStay: applyLong,
        peak: el("peak").checked
      }
    };
  }

  // =========================
  // Modal and submission
  // =========================
  function openModal() {
    const pricing = calc();

    const staffText = selectedStaff ? `${selectedStaff.name} (selected)` : "Not selected yet";
    el("modalSummary").innerHTML =
      `Package: <b>${pkgLabel()}</b><br>` +
      `Dates: <b>${pricing.inputs.start}</b> to <b>${pricing.inputs.end}</b> (${pricing.days} days)<br>` +
      `Zone: <b>${zoneLabel()}</b><br>` +
      `Sitter: <b>${escapeHtml(staffText)}</b><br><br>` +
      `Total: <b>${money(pricing.total)}</b><br>` +
      `Deposit (50%): <b>${money(pricing.deposit)}</b><br>` +
      `Balance: <b>${money(pricing.balance)}</b>`;

    el("submitStatus").textContent = "";
    el("modalWrap").classList.remove("hidden");
  }

  function closeModal() {
    el("modalWrap").classList.add("hidden");
  }

  function validateBookingForm() {
    const name = el("custName").value.trim();
    const phone = el("custPhone").value.trim();
    const email = el("custEmail").value.trim();
    const hp = el("hpField").value.trim();

    if (hp) return { ok: false, msg: "Blocked." }; // bots
    if (!name) return { ok: false, msg: "Enter your name." };
    if (!phone) return { ok: false, msg: "Enter your phone number." };
    if (!email || !email.includes("@")) return { ok: false, msg: "Enter a valid email." };

    return { ok: true };
  }

  async function submitBooking() {
    const v = validateBookingForm();
    if (!v.ok) {
      el("submitStatus").textContent = v.msg;
      return;
    }

    // Require staff selection if any available staff is shown
    const hasCarouselOptions = el("staffCarousel").children.length > 0;
    if (hasCarouselOptions && !selectedStaff) {
      el("submitStatus").textContent = "Select a sitter before submitting.";
      return;
    }

    if (!CONFIG.apiBaseUrl || CONFIG.apiBaseUrl.startsWith("PASTE_")) {
      el("submitStatus").textContent = "API not connected yet. Deploy Apps Script and paste the URL into CONFIG.";
      return;
    }

    const pricing = calc();

    const payload = {
      action: "booking",
      apiKey: CONFIG.apiKey || "",
      ts: new Date().toISOString(),

      customerName: el("custName").value.trim(),
      customerPhone: el("custPhone").value.trim(),
      customerEmail: el("custEmail").value.trim(),
      customerAddress: el("custAddress").value.trim(),
      customerNotes: el("custNotes").value.trim(),

      sitterId: selectedStaff ? (selectedStaff.id || "") : "",
      sitterName: selectedStaff ? (selectedStaff.name || "") : "",

      zone: el("zone").value,
      zoneLabel: zoneLabel(),

      pkg: pricing.inputs.pkg,
      start: pricing.inputs.start,
      end: pricing.inputs.end,
      days: String(pricing.days),

      total: String(Math.round(pricing.total)),
      deposit: String(Math.round(pricing.deposit)),
      balance: String(Math.round(pricing.balance)),

      selectionsJson: JSON.stringify(pricing.inputs)
    };

    // URL-encoded send (no CORS reading required)
    const params = new URLSearchParams(payload);

    el("submitStatus").textContent = "Sending…";

    try {
      // Prefer sendBeacon
      const ok = navigator.sendBeacon && navigator.sendBeacon(CONFIG.apiBaseUrl, params);
      if (!ok) {
        await fetch(CONFIG.apiBaseUrl, { method: "POST", mode: "no-cors", body: params });
      }

      el("submitStatus").textContent =
        "Request sent. Check your email for the invoice/estimate. If you do not receive it, WhatsApp us with your name and dates.";

      // Auto close after short delay
      setTimeout(() => closeModal(), 1600);
    } catch (err) {
      el("submitStatus").textContent = "Could not send. Please try again or contact us.";
    }
  }

  // =========================
  // Quote copy
  // =========================
  async function copyQuote() {
    const pricing = calc();
    const staffLine = selectedStaff ? `Sitter: ${selectedStaff.name}` : `Sitter: Not selected`;
    const text =
`${CONFIG.businessName} Quote Estimate
Package: ${pkgLabel()}
Dates: ${pricing.inputs.start} to ${pricing.inputs.end} (${pricing.days} days)
Zone: ${zoneLabel()}
${staffLine}

Total: ${money(pricing.total)}
Deposit (50%): ${money(pricing.deposit)}
Balance: ${money(pricing.balance)}

Note: Final price confirmed after screening and availability.`;

    try {
      await navigator.clipboard.writeText(text);
      el("copyBtn").textContent = "Copied";
      setTimeout(()=> el("copyBtn").textContent="Copy Quote",1200);
    } catch {
      alert(text);
    }
  }

  // =========================
  // Attach listeners
  // =========================
  function attach() {
    // Date defaults
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    el("startDate").value = `${yyyy}-${mm}-${dd}`;
    el("endDate").value = `${yyyy}-${mm}-${dd}`;

    document.querySelectorAll(".pkgBtn").forEach(b => {
      b.addEventListener("click", () => {
        pkg = b.dataset.pkg;
        setPkgUI();
        calc();
        fetchAvailability();
      });
    });

    [
      "startDate","endDate","zone","dogs","cats","peak","longStay",
      "updates","checkins","walk15","walk30","walk60",
      "meds","highcare","homecare","keys","taxi","hours","foodSupplies"
    ].forEach(id => el(id).addEventListener("input", () => {
      calc();
      // Update availability when core booking details change
      if (["startDate","endDate","zone"].includes(id)) fetchAvailability();
    }));

    el("copyBtn").addEventListener("click", copyQuote);

    el("requestBtn").addEventListener("click", openModal);
    el("closeModal").addEventListener("click", closeModal);
    el("modalWrap").addEventListener("click", (e) => {
      if (e.target === el("modalWrap")) closeModal();
    });
    el("submitBooking").addEventListener("click", submitBooking);

    setPkgUI();
    calc();
    fetchAvailability();
  }

  attach();
</script>
</body>
</html>


