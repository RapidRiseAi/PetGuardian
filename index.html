<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetGuardian Care | Pricing Calculator</title>

  <!-- Tailwind (kept because your current file uses it in a few places) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================================
      CONFIG (EASY EDIT)
      Change only these values to adjust brand look quickly.
    ========================================================== */
    :root{
      /* Core palette (mockup) */
      --pg-forest:#0B2A1E;
      --pg-pine:#123629;
      --pg-champ:#F3E7D3;
      --pg-stone:#CBBFAE;
      --pg-brass:#B08D57;

      /* Tech accent (subtle, premium) */
      --pg-tech:#7FE7D5;

      /* Surfaces */
      --pg-glass: rgba(18,54,41,0.60);
      --pg-card: rgba(10,40,28,0.56);
      --pg-border: rgba(176,141,87,0.26);
      --pg-muted: rgba(203,191,174,0.92);

      /* Active states */
      --pg-active-bg: rgba(243,231,211,0.58);
      --pg-active-text: #0B2A1E;

      /* Layout targets */
      --pg-radius-xl: 28px;
      --pg-radius-lg: 24px;
      --pg-radius-md: 18px;
      --pg-shadow: 0 22px 70px rgba(0,0,0,0.45);

      /* Focus ring */
      --pg-focus: 0 0 0 3px rgba(127,231,213,0.18), 0 0 0 1px rgba(127,231,213,0.45);
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--pg-champ);
      background: var(--pg-forest);
      overflow-x: hidden;
    }

    .font-lux{
      font-family: Cinzel, Inter, system-ui, sans-serif;
      letter-spacing: 0.2px;
    }

    /* Premium background with subtle grain and vignette, no image needed */
    .bg-premium{
      position: relative;
      background:
        radial-gradient(1100px 680px at 18% 0%, rgba(176,141,87,0.22), transparent 60%),
        radial-gradient(980px 640px at 92% 18%, rgba(243,231,211,0.10), transparent 55%),
        radial-gradient(980px 980px at 50% 120%, rgba(18,54,41,0.60), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.28), rgba(0,0,0,0.58)),
        var(--pg-forest);
    }
    .bg-premium::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: 0.10;
      mix-blend-mode: overlay;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.22) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.18) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.16) 0 1px, transparent 2px);
      background-size: 120px 120px, 160px 160px, 200px 200px;
    }
    .bg-premium::after{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      background: radial-gradient(1200px 700px at 50% 20%, transparent 40%, rgba(0,0,0,0.65) 100%);
      opacity: 0.55;
    }

    /* Shell */
    .shell{
      position: relative;
      z-index: 1;
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px 16px;
    }
    @media (min-width: 640px){
      .shell{ padding: 28px 24px; }
    }

    /* Glass container */
    .glass{
      background: rgba(18,54,41,0.62);
      border: 1px solid var(--pg-border);
      backdrop-filter: blur(14px);
      box-shadow: var(--pg-shadow);
      border-radius: var(--pg-radius-xl);
    }

    .card{
      background: var(--pg-card);
      border: 1px solid var(--pg-border);
      border-radius: var(--pg-radius-lg);
    }

    .thin-line{ height:1px; background: rgba(176,141,87,0.22); }

    .muted{ color: var(--pg-muted); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      font-size: 12px;
      border: 1px solid rgba(176,141,87,0.35);
      background: rgba(11,42,30,0.55);
      color: var(--pg-stone);
      white-space: nowrap;
    }

    /* Inputs */
    .input{
      background: rgba(11,42,30,0.55);
      border: 1px solid rgba(176,141,87,0.22);
      color: var(--pg-champ);
      border-radius: 16px;
      padding: 10px 12px;
      outline: none;
      width: 100%;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
    }
    .input::placeholder{ color: rgba(203,191,174,0.65); }
    .input:focus{
      box-shadow: var(--pg-focus);
      border-color: rgba(127,231,213,0.55);
    }

    /* Checkbox accent */
    input[type="checkbox"]{
      accent-color: var(--pg-brass);
    }

    /* Buttons */
    .btn{
      border-radius: 16px;
      padding: 10px 14px;
      font-weight: 800;
      border: 1px solid rgba(176,141,87,0.45);
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .btn:focus{ outline: none; box-shadow: var(--pg-focus); }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary{
      background: rgba(243,231,211,0.92);
      color: var(--pg-active-text);
    }
    .btn-ghost{
      background: rgba(11,42,30,0.22);
      color: var(--pg-champ);
      border-color: rgba(176,141,87,0.55);
    }
    .btn-dark{
      background: rgba(11,42,30,0.40);
      color: var(--pg-champ);
      border-color: rgba(176,141,87,0.32);
    }

    /* Segmented cards */
    .seg{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    .seg-btn{
      border: 1px solid rgba(176,141,87,0.28);
      background: rgba(11,42,30,0.45);
      border-radius: 18px;
      padding: 14px 14px;
      text-align: left;
      transition: all .18s ease;
      color: var(--pg-champ);
      position: relative;
      overflow: hidden;
    }
    .seg-btn:focus{ outline:none; box-shadow: var(--pg-focus); }
    .seg-btn .sub{ color: var(--pg-muted); font-size: 12px; margin-top: 3px; }
    .seg-btn.active{
      background: var(--pg-active-bg);
      border-color: rgba(176,141,87,0.70);
      color: var(--pg-active-text);
    }
    .seg-btn.active .sub{ color: rgba(11,42,30,0.82); }

    /* Range slider */
    input[type="range"]{
      height: 26px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      width: 100%;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 7px;
      border-radius: 999px;
      background: rgba(243,231,211,0.16);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid rgba(243,231,211,0.95);
      margin-top: -7px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
    }
    input[type="range"]::-moz-range-track{
      height: 7px;
      border-radius: 999px;
      background: rgba(243,231,211,0.16);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid rgba(243,231,211,0.95);
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
    }

    /* Desktop fit (reduce vertical bloat while staying premium) */
    @media (min-width: 1024px){
      .tight-pad{ padding: 14px; }
      .tight-gap{ gap: 14px; }
      .title-xl{ font-size: 34px; line-height: 1.1; }
    }

    /* Sticky quote panel */
    .sticky-panel{
      position: sticky;
      top: 18px;
    }

    /* Modals */
    .overlay{
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(6px);
    }
    .modal{
      border-radius: var(--pg-radius-xl);
      background: rgba(18,54,41,0.72);
      border: 1px solid rgba(176,141,87,0.30);
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
    }
    .modal-scroll{
      max-height: calc(100vh - 90px);
      overflow-y: auto;
    }

    /* Sitter cards in modal */
    .sitter-grid{
      display:grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 12px;
    }
    @media (min-width: 640px){
      .sitter-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px){
      .sitter-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .sitter-tile{
      border-radius: 22px;
      border: 1px solid rgba(176,141,87,0.24);
      background: rgba(11,42,30,0.52);
      padding: 12px;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
      text-align:left;
    }
    .sitter-tile:hover{
      transform: translateY(-2px);
      border-color: rgba(176,141,87,0.55);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .sitter-tile.selected{
      background: var(--pg-active-bg);
      border-color: rgba(176,141,87,0.75);
      color: var(--pg-active-text);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(176,141,87,0.30);
      background: rgba(11,42,30,0.45);
      color: rgba(203,191,174,0.95);
    }
    .sitter-tile.selected .badge{
      border-color: rgba(11,42,30,0.20);
      background: rgba(11,42,30,0.10);
      color: rgba(11,42,30,0.82);
    }

    /* Hide the old carousel visually (we keep it in DOM for functionality checks) */
    #staffCarousel{ display:none; }
  </style>
</head>

<body class="min-h-screen bg-premium">
  <div class="shell">
    <div class="glass p-5 sm:p-7">

      <!-- Top bar -->
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl flex items-center justify-center"
               style="border:1px solid rgba(176,141,87,0.35); background: rgba(11,42,30,0.55); overflow:hidden;">
            <img src="logo.png" alt="PetGuardian Care" class="w-full h-full object-cover" onerror="this.style.display='none'">
          </div>

          <div>
            <div class="pill">
              PetGuardian Care
              <span style="color: var(--pg-brass);">‚Ä¢</span>
              Care Estimate
            </div>
            <div class="title-xl text-2xl sm:text-3xl font-lux mt-2">Get a care cost estimate</div>
            <div class="text-sm mt-1 muted">Transparent pricing, verified sitters, secure booking.</div>
            <div id="pricingStatus" class="text-xs mt-2 muted">Pricing: loading from sheet‚Ä¶</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="howBtn" class="btn btn-dark">How pricing works</button>
          <button id="copyBtn" class="btn btn-primary">Copy Quote</button>
          <button id="requestBtn" class="btn btn-ghost">Request Booking</button>
        </div>
      </div>

      <div class="mt-5 thin-line"></div>

      <!-- Main grid -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-5 tight-gap">

        <!-- Left -->
        <div class="lg:col-span-8 space-y-4">

          <!-- Stay type -->
          <div class="card p-4 tight-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">1) Choose your stay type</div>
                <div class="text-xs muted mt-1">Base cost starts here. Add-ons apply on top.</div>
              </div>
              <div class="text-xs muted mt-1">Luxury-grade transparency</div>
            </div>

            <div class="seg mt-3">
              <button class="seg-btn" data-pkg="day" type="button">
                <div class="flex items-center gap-2">
                  <span>üïí</span><span class="font-semibold">Day Visits</span>
                </div>
                <div class="sub">Hourly care</div>
              </button>

              <button class="seg-btn" data-pkg="night" type="button">
                <div class="flex items-center gap-2">
                  <span>üåô</span><span class="font-semibold">Overnight</span>
                </div>
                <div class="sub">6pm to 6am</div>
              </button>

              <button class="seg-btn" data-pkg="full" type="button">
                <div class="flex items-center gap-2">
                  <span>üè†</span><span class="font-semibold">Full-time</span>
                </div>
                <div class="sub">24h presence</div>
              </button>
            </div>

            <div id="hoursWrap" class="mt-4 hidden">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-semibold">Hours per day</div>
                  <div class="text-xs muted">Day visits only.</div>
                </div>
                <div class="text-sm"><span class="muted">Hours:</span> <span id="hoursOut" class="font-semibold">4</span></div>
              </div>
              <input id="hours" type="range" min="1" max="12" value="4" class="mt-2">
            </div>
          </div>

          <!-- 2x2 card grid -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 tight-gap">

            <!-- Dates -->
            <div class="card p-4 tight-pad">
              <div class="text-sm font-semibold">2) When and where</div>
              <div class="text-xs muted mt-1">Peak dates and long-stay discounts apply automatically.</div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs muted">Start date</label>
                  <input id="startDate" type="date" class="input mt-1">
                </div>
                <div>
                  <label class="block text-xs muted">End date</label>
                  <input id="endDate" type="date" class="input mt-1">
                </div>
              </div>

              <div class="mt-3 text-sm">
                <span class="muted">Days:</span> <span id="daysOut" class="font-semibold">1</span>
                <span id="peakNote" class="ml-2 text-xs muted"></span>
              </div>

              <label class="block mt-3 text-xs muted">Zone</label>
              <select id="zone" class="input mt-1">
                <option value="sabie">Sabie (Zone A)</option>
                <option value="wr">White River (Zone B)</option>
                <option value="nel">Nelspruit (Zone C)</option>
              </select>

              <div class="mt-3 text-xs muted leading-relaxed">
                Travel is included where applicable. If your zone has travel fees, each check-in includes fuel cost.
              </div>
            </div>

            <!-- Pets -->
            <div class="card p-4 tight-pad">
              <div class="text-sm font-semibold">3) Pets and care options</div>
              <div class="text-xs muted mt-1">First pet included. Extra pets add a daily fee.</div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs muted">Dogs</label>
                  <input id="dogs" type="number" min="0" value="1" class="input mt-1">
                </div>
                <div>
                  <label class="block text-xs muted">Cats</label>
                  <input id="cats" type="number" min="0" value="0" class="input mt-1">
                </div>
              </div>

              <div class="mt-3 rounded-2xl p-3"
                   style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="text-sm font-semibold">Food supplies allowed</div>
                    <div class="text-xs muted mt-1">Deduct <b>R50</b> per day if allowed.</div>
                  </div>
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input id="foodSupplies" type="checkbox">
                    <span>Allowed</span>
                  </label>
                </div>

                <div id="foodNote" class="mt-2 text-xs muted leading-relaxed hidden">
                  Store off-limits items separately or label cupboards. Send photos before the booking starts.
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="flex items-start justify-between gap-3 rounded-2xl p-3"
                       style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
                  <div>
                    <div class="text-sm font-semibold">Puppy care</div>
                    <div class="text-xs muted mt-1">Extra supervision and cleanup.</div>
                  </div>
                  <input id="puppy" type="checkbox" class="mt-1">
                </label>

                <label class="flex items-start justify-between gap-3 rounded-2xl p-3"
                       style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
                  <div>
                    <div class="text-sm font-semibold">Oral meds</div>
                    <div class="text-xs muted mt-1">We follow your instructions.</div>
                  </div>
                  <input id="meds" type="checkbox" class="mt-1">
                </label>
              </div>
            </div>

            <!-- Add-ons -->
            <div class="card p-4 tight-pad">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">4) Add-ons</div>
                  <div class="text-xs muted mt-1">Only what you need. Calculated per day unless stated.</div>
                </div>
                <div class="text-xs muted mt-1">Transparent totals</div>
              </div>

              <div class="grid grid-cols-2 gap-4 mt-3">
                <div>
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="text-sm font-semibold">Daily updates</div>
                      <div class="text-xs muted">Photos + short log</div>
                    </div>
                    <div class="text-sm"><span class="muted">Qty:</span> <span id="updatesOut" class="font-semibold">0</span></div>
                  </div>
                  <input id="updates" type="range" min="0" max="2" step="1" value="0" class="mt-2">
                </div>

                <div>
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="text-sm font-semibold">Check-ins/day</div>
                      <div class="text-xs muted">Short visit</div>
                    </div>
                    <div class="text-sm"><span class="muted">Qty:</span> <span id="checkinsOut" class="font-semibold">0</span></div>
                  </div>
                  <input id="checkins" type="range" min="0" max="3" step="1" value="0" class="mt-2">
                </div>

                <div class="col-span-2">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="text-sm font-semibold">Walk time/day</div>
                      <div class="text-xs muted">R60 per hour (R5 per 5 min)</div>
                    </div>
                    <div class="text-sm">
                      <span class="muted">Min:</span> <span id="walkMinOut" class="font-semibold">0</span>
                      <span class="muted ml-3">Cost/day:</span> <span id="walkCostOut" class="font-semibold">R0</span>
                    </div>
                  </div>
                  <input id="walkMinutes" type="range" min="0" max="180" step="5" value="0" class="mt-2">
                </div>

                <label class="col-span-2 flex items-start justify-between gap-3 rounded-2xl p-3"
                       style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
                  <div>
                    <div class="text-sm font-semibold">Home care pack</div>
                    <div class="text-xs muted mt-1">Bins, lights, tidy, quick checks</div>
                  </div>
                  <input id="homecare" type="checkbox" class="mt-1">
                </label>

                <div class="grid grid-cols-2 gap-3 col-span-2">
                  <div>
                    <label class="block text-xs muted">Key trips (one-time)</label>
                    <input id="keys" type="number" min="0" value="0" class="input mt-1">
                  </div>
                  <div>
                    <label class="block text-xs muted">Pet taxi (one-time)</label>
                    <input id="taxi" type="number" min="0" value="0" class="input mt-1">
                  </div>
                </div>
              </div>
            </div>

            <!-- Sitter selection (replaces the scroll list, now luxury modal) -->
            <div class="card p-4 tight-pad">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">5) Select your sitter</div>
                  <div class="text-xs muted mt-1">Verified selection required to submit a request.</div>
                </div>
                <div id="staffStatus" class="text-xs muted mt-1">Loading‚Ä¶</div>
              </div>

              <div id="selectedSitterPanel" class="mt-3 rounded-2xl p-3"
                   style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
                <div class="flex items-center justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-sm font-semibold">No sitter selected</div>
                    <div class="text-xs muted mt-1">Choose a sitter to continue.</div>
                  </div>
                  <button id="chooseSitterBtn" class="btn btn-primary">Choose sitter</button>
                </div>
              </div>

              <div id="staffEmpty" class="mt-3 hidden text-sm muted">
                No sitters available for these dates. Try different dates or stay type.
              </div>

              <!-- Keep this in DOM (your existing JS checks children length). Hidden by CSS. -->
              <div id="staffCarousel" class="mt-3"></div>
            </div>

          </div>
        </div>

        <!-- Right -->
        <div class="lg:col-span-4">
          <div class="card p-5 sticky-panel">
            <div class="text-sm font-semibold">Your care quote</div>
            <div id="totalOut" class="text-4xl font-lux mt-2">R0</div>

            <div class="mt-4 thin-line"></div>

            <div class="mt-4 space-y-2 text-sm">
              <div class="flex items-center justify-between"><span class="muted">Base stay</span><span id="baseOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">Add-ons + travel</span><span id="addonsOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">Long-stay discount</span><span id="discountOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">One-time fees</span><span id="oneTimeOut" class="font-semibold">R0</span></div>
            </div>

            <div id="peakAppliedOut" class="text-xs muted mt-3"></div>

            <div class="mt-4 rounded-2xl p-3"
                 style="background: rgba(243,231,211,0.18); border: 1px solid rgba(176,141,87,0.20);">
              <div class="text-xs muted">Deposit required</div>
              <div class="text-xl font-semibold mt-1" id="depositOut">R0</div>
              <div class="text-xs muted mt-2">Balance after service</div>
              <div class="text-xl font-semibold mt-1" id="balanceOut">R0</div>
              <div class="text-xs muted mt-3">
                50% deposit secures booking. Remaining 50% due after service.
              </div>
            </div>

            <div class="mt-4 text-xs muted leading-relaxed">
              Final price is confirmed after screening and sitter availability.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SITTER MODAL -->
  <div id="sitterModalWrap" class="fixed inset-0 hidden overlay">
    <div class="max-w-6xl mx-auto p-4 sm:p-8">
      <div class="modal modal-scroll p-5 sm:p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">Select your sitter</div>
            <div class="text-xl font-lux font-semibold mt-1">Available sitters</div>
            <div class="text-xs mt-2 muted">Larger profiles, clearer trust, better choice.</div>
          </div>
          <button id="closeSitterModal" class="btn btn-ghost">Close</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div class="md:col-span-2">
            <input id="sitterSearch" class="input" placeholder="Search sitter name...">
          </div>
          <div>
            <select id="sitterSort" class="input">
              <option value="rating">Sort: Highest rated</option>
              <option value="name">Sort: Name A-Z</option>
            </select>
          </div>
        </div>

        <div id="sitterGrid" class="sitter-grid mt-4"></div>

        <div id="sitterModalEmpty" class="hidden mt-4 text-sm muted">
          No sitters found for these dates.
        </div>
      </div>
    </div>
  </div>

  <!-- PRICING RULES MODAL -->
  <div id="howModalWrap" class="fixed inset-0 hidden overlay">
    <div class="max-w-2xl mx-auto p-4 sm:p-8">
      <div class="modal modal-scroll p-5 sm:p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">Pricing transparency</div>
            <div class="text-xl font-lux font-semibold mt-1">How pricing works</div>
            <div class="text-xs mt-2 muted">No surprises. Your total is calculated from these rules.</div>
          </div>
          <button id="closeHowModal" class="btn btn-ghost">Close</button>
        </div>

        <div class="mt-4 space-y-3 text-sm">
          <div class="rounded-2xl p-3" style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
            <div class="font-semibold">Peak dates</div>
            <div class="text-xs muted mt-1">Peak multiplier applies if any day falls in peak range.</div>
            <ul class="mt-2 text-xs muted list-disc pl-5">
              <li>June 1 to July 31</li>
              <li>December 1 to January 15</li>
            </ul>
          </div>

          <div class="rounded-2xl p-3" style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
            <div class="font-semibold">Long-stay discount</div>
            <div class="text-xs muted mt-1">Applied automatically in blocks (compounds per block).</div>
            <div class="text-xs muted mt-2">
              Example: 10 days at 100%, next 10 days at 90%, next 10 days at 81%, and so on.
            </div>
          </div>

          <div class="rounded-2xl p-3" style="border:1px solid rgba(176,141,87,0.20); background: rgba(11,42,30,0.35);">
            <div class="font-semibold">Deposit</div>
            <div class="text-xs muted mt-1">50% deposit secures your booking. Remaining 50% due after service.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Modal (your existing one, kept the same) -->
  <div id="modalWrap" class="fixed inset-0 hidden overflow-y-auto overlay">
    <div class="max-w-xl mx-auto p-4 sm:p-8 pb-24">
      <div class="modal p-5 sm:p-6 modal-scroll">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">Request Booking</div>
            <div class="text-xl font-lux font-semibold mt-1">Your details</div>
            <div class="text-xs mt-2 muted">
              We will email an invoice or estimate. Deposit required is 50%.
            </div>
          </div>
          <button id="closeModal" class="btn btn-ghost">Close</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block text-xs muted">Full name</label>
            <input id="custName" class="input mt-1" placeholder="Your name">
          </div>
          <div>
            <label class="block text-xs muted">Phone</label>
            <input id="custPhone" class="input mt-1" placeholder="e.g. 081 532 8774">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Email</label>
            <input id="custEmail" class="input mt-1" placeholder="you@example.com">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Address or area</label>
            <input id="custAddress" class="input mt-1" placeholder="Street or area">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Notes</label>
            <textarea id="custNotes" rows="3" class="input mt-1" placeholder="Routine, meds, temperament, gate access, etc."></textarea>
          </div>

          <div class="hidden">
            <label>Website</label>
            <input id="hpField" class="input mt-1" placeholder="Leave blank">
          </div>
        </div>

        <div class="rounded-2xl p-3 mt-4"
             style="background: rgba(11,42,30,0.35); border: 1px solid rgba(176,141,87,0.20);">
          <div class="text-xs muted">Summary</div>
          <div id="modalSummary" class="text-sm mt-2" style="color: rgba(203,191,174,0.95);"></div>
        </div>

        <div class="flex items-center justify-between gap-3 mt-4">
          <div class="text-xs muted">By requesting, you agree to deposit terms.</div>
          <button id="submitBooking" class="btn btn-primary">Send Request</button>
        </div>

        <div id="submitStatus" class="text-xs mt-3 muted"></div>
      </div>
    </div>
  </div>

<script>
  /* =========================================================
    CONFIG (EASY EDIT)
  ========================================================== */
  const CONFIG = {
    businessName: "PetGuardian Care",
    depositPercent: 0.50,

    // IMPORTANT: keep your live Apps Script URL here
    apiBaseUrl: "https://script.google.com/macros/s/AKfycbzfqeIQFLpa155Gf-454kbaSQUEw9RpiqISwnPbSkfYPV-aU6LZlbTbkG5jv-sHe6jp/exec",
    apiKey: ""
  };

  // Defaults (will be overridden by Pricing tab values if present)
  const PRICES = {
    base: { dayHourly: 60, night: 150, fullDay: 320 },
    travelPerDay: { sabie: 0, wr: 30, nel: 60 },
    peakMultiplier: 1.15,

    add: {
      updatePackPerDay: 50,
      checkin: 50,

      // Walks derived from minutes: R5 per 5 minutes => R1 per minute
      walkPerMinute: 1,

      medsPerDay: 50,
      puppyCarePerDay: 100,
      homecarePerDay: 30,
      foodSuppliesCreditPerDay: 50,
      extraDogPerDay: 50,
      extraCatPerDay: 30,
      keyTrip: 50,
      petTaxi: 150
    },

    longStay: { blockDays: 10, factor: 0.9 } // compounding every block
  };

  let pkg = "day";
  let selectedStaff = null;
  let lastAvailabilityReqId = 0;
  let staffListCache = [];

  const el = (id) => document.getElementById(id);

  function money(n){
    const v = Math.round(Number(n) || 0);
    return "R" + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function daysBetween(start, end) {
    if (!start || !end) return 1;
    const s = new Date(start);
    const e = new Date(end);
    const diff = Math.round((e - s) / (1000*60*60*24)) + 1;
    return Math.max(1, diff);
  }

  function isPeakDate(dateObj){
    // Peak: June 1 to July 31, and Dec 1 to Jan 15 (cross-year)
    const m = dateObj.getMonth(); // 0=Jan
    const d = dateObj.getDate();
    if (m === 5 || m === 6) return true; // Jun, Jul
    if (m === 11) return true;           // Dec
    if (m === 0 && d <= 15) return true; // Jan 1-15
    return false;
  }

  function bookingHasPeak(startStr, endStr){
    if (!startStr || !endStr) return false;
    const s = new Date(startStr);
    const e = new Date(endStr);
    s.setHours(0,0,0,0);
    e.setHours(0,0,0,0);
    for (let dt = new Date(s); dt <= e; dt.setDate(dt.getDate()+1)){
      if (isPeakDate(dt)) return true;
    }
    return false;
  }

  function weightedDays(days) {
    const { blockDays, factor } = PRICES.longStay;
    const blocks = Math.floor(days / blockDays);
    const rem = days % blockDays;
    if (blocks === 0) return days;

    // geometric series: blockDays + blockDays*factor + ... + blockDays*factor^(blocks-1)
    const series = blockDays * (1 - Math.pow(factor, blocks)) / (1 - factor);
    return series + rem * Math.pow(factor, blocks);
  }

  function includedPetCount(dogs, cats) {
    if (dogs > 0) return { incDogs: 1, incCats: 0 };
    if (cats > 0) return { incDogs: 0, incCats: 1 };
    return { incDogs: 0, incCats: 0 };
  }

  function pkgLabel() {
    if (pkg === "day") return "Day Visits";
    if (pkg === "night") return "Overnight";
    return "Full-time";
  }

  function zoneLabel() {
    return el("zone").selectedOptions[0].textContent;
  }

  function setPkgUI() {
    document.querySelectorAll(".seg-btn").forEach(b => {
      const active = b.dataset.pkg === pkg;
      b.classList.toggle("active", active);
    });
    el("hoursWrap").classList.toggle("hidden", pkg !== "day");
  }

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  /* =========================================================
    SITTER UI (MODAL + SELECTED PANEL)
  ========================================================== */
  function openSitterModal(){
    el("sitterModalWrap").classList.remove("hidden");
    el("sitterSearch").focus();
  }
  function closeSitterModal(){
    el("sitterModalWrap").classList.add("hidden");
  }

  function updateSelectedSitterPanel(){
    const panel = el("selectedSitterPanel");

    if (!staffListCache.length){
      panel.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">No sitters available</div>
            <div class="text-xs muted mt-1">Try different dates or stay type.</div>
          </div>
          <button id="chooseSitterBtn" class="btn btn-ghost" type="button">Choose sitter</button>
        </div>
      `;
      const btn = document.getElementById("chooseSitterBtn");
      if (btn) btn.addEventListener("click", openSitterModal);
      return;
    }

    if (!selectedStaff){
      panel.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">No sitter selected</div>
            <div class="text-xs muted mt-1">Choose a sitter to continue.</div>
          </div>
          <button id="chooseSitterBtn" class="btn btn-primary" type="button">Choose sitter</button>
        </div>
      `;
      const btn = document.getElementById("chooseSitterBtn");
      if (btn) btn.addEventListener("click", openSitterModal);
      return;
    }

    panel.innerHTML = `
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <img src="${escapeHtml(selectedStaff.photoUrl || "")}" alt="${escapeHtml(selectedStaff.name || "Sitter")}"
               class="w-14 h-14 rounded-2xl object-cover border"
               style="border-color: rgba(176,141,87,0.28); background: rgba(0,0,0,0.2);">
          <div class="min-w-0">
            <div class="text-sm font-semibold font-lux truncate">${escapeHtml(selectedStaff.name || "Sitter")}</div>
            <div class="text-xs muted truncate">${escapeHtml(selectedStaff.title || "PetGuardian Care Sitter")}</div>
            <div class="text-xs mt-1" style="color: rgba(203,191,174,0.95);">
              Rating: <span class="font-semibold">${escapeHtml(String(selectedStaff.rating || "5.0"))}</span>
            </div>
          </div>
        </div>
        <button id="changeSitterBtn" class="btn btn-ghost" type="button">Change</button>
      </div>
      <div class="text-xs muted mt-3 leading-relaxed">${escapeHtml(selectedStaff.bio || "")}</div>
    `;

    const btn = document.getElementById("changeSitterBtn");
    if (btn) btn.addEventListener("click", openSitterModal);
  }

  function selectSitterById(id){
    const found = staffListCache.find(s => String(s.id) === String(id));
    if (!found) return;
    selectedStaff = found;
    renderSitterModal(staffListCache);
    updateSelectedSitterPanel();
  }

  function renderSitterModal(list){
    const grid = el("sitterGrid");
    const empty = el("sitterModalEmpty");
    const q = (el("sitterSearch").value || "").trim().toLowerCase();
    const sort = el("sitterSort").value;

    let filtered = list.filter(s => {
      const name = String(s.name || "").toLowerCase();
      return !q || name.includes(q);
    });

    if (sort === "name"){
      filtered.sort((a,b) => String(a.name||"").localeCompare(String(b.name||"")));
    } else {
      filtered.sort((a,b) => (parseFloat(b.rating)||0) - (parseFloat(a.rating)||0));
    }

    grid.innerHTML = "";
    empty.classList.toggle("hidden", filtered.length !== 0);

    filtered.forEach((s) => {
      const tile = document.createElement("button");
      tile.type = "button";
      tile.className = "sitter-tile";
      if (selectedStaff && String(selectedStaff.id) === String(s.id)) tile.classList.add("selected");

      tile.innerHTML = `
        <div class="aspect-[4/5] rounded-2xl overflow-hidden border"
             style="border-color: rgba(176,141,87,0.22); background: rgba(0,0,0,0.2);">
          <img src="${escapeHtml(s.photoUrl || "")}" alt="${escapeHtml(s.name || "Sitter")}"
               class="w-full h-full object-cover">
        </div>

        <div class="mt-3">
          <div class="font-lux font-semibold truncate">${escapeHtml(s.name || "Sitter")}</div>
          <div class="text-xs muted truncate mt-1">${escapeHtml(s.title || "PetGuardian Care Sitter")}</div>
          <div class="text-xs mt-2" style="color: rgba(203,191,174,0.95);">
            Rating: <span class="font-semibold">${escapeHtml(String(s.rating || "5.0"))}</span>
          </div>
          <div class="text-xs muted mt-2 leading-relaxed" style="min-height: 48px;">
            ${escapeHtml(s.bio || "Professional sitter")}
          </div>

          <div class="mt-3 flex items-center justify-between">
            <span class="badge">Verified</span>
            <span class="badge">Select</span>
          </div>
        </div>
      `;

      tile.addEventListener("click", () => {
        selectedStaff = s;
        updateSelectedSitterPanel();
        renderSitterModal(staffListCache);
        closeSitterModal();
      });

      grid.appendChild(tile);
    });
  }

  /* =========================================================
    JSONP callbacks (unchanged functionality)
  ========================================================== */
  window.pgAvailabilityCallback = function(payload) {
    if (!payload || payload.reqId != lastAvailabilityReqId) return;
    const list = payload.staff || [];

    staffListCache = list.slice();

    // preserve selection if still available
    if (selectedStaff) {
      const stillThere = staffListCache.find(s => String(s.id) === String(selectedStaff.id));
      if (!stillThere) selectedStaff = null;
    }

    renderStaffCarousel(list);   // kept for internal checks
    renderSitterModal(list);
    updateSelectedSitterPanel();

    el("staffStatus").textContent = list.length ? "Select a sitter" : "None available";
    el("staffEmpty").classList.toggle("hidden", list.length !== 0);
  };

  window.pgBookingCallback = function(payload) {
    if (!payload || payload.ok !== true) {
      el("submitStatus").textContent = (payload && payload.error) ? payload.error : "Booking failed. Please try again.";
      return;
    }
    el("submitStatus").textContent =
      "Request sent. Check your email for the invoice or estimate. If you do not receive it, WhatsApp us with your name and dates.";
    setTimeout(() => closeModal(), 1600);
  };

  window.pgPricingCallback = function(payload){
    if (!payload || payload.ok !== true) {
      el("pricingStatus").textContent = "Pricing: using defaults (Pricing tab not found)";
      calc();
      return;
    }
    const p = payload.pricing || {};
    applyPricingFromSheet(p);
    el("pricingStatus").textContent = "Pricing: loaded from sheet";
    calc();
  };

  function applyPricingFromSheet(p){
    const num = (v, fallback) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };

    PRICES.base.dayHourly = num(p.BASE_DAY_HOURLY, PRICES.base.dayHourly);
    PRICES.base.night = num(p.BASE_NIGHT, PRICES.base.night);
    PRICES.base.fullDay = num(p.BASE_FULLDAY, PRICES.base.fullDay);

    PRICES.travelPerDay.sabie = num(p.TRAVEL_SABIE, PRICES.travelPerDay.sabie);
    PRICES.travelPerDay.wr = num(p.TRAVEL_WR, PRICES.travelPerDay.wr);
    PRICES.travelPerDay.nel = num(p.TRAVEL_NEL, PRICES.travelPerDay.nel);

    PRICES.peakMultiplier = num(p.PEAK_MULTIPLIER, PRICES.peakMultiplier);

    PRICES.longStay.blockDays = num(p.DISCOUNT_BLOCK_DAYS, PRICES.longStay.blockDays);
    PRICES.longStay.factor = num(p.DISCOUNT_FACTOR, PRICES.longStay.factor);

    PRICES.add.updatePackPerDay = num(p.ADD_UPDATE_PACK_PER_DAY, PRICES.add.updatePackPerDay);
    PRICES.add.checkin = num(p.ADD_CHECKIN, PRICES.add.checkin);

    PRICES.add.medsPerDay = num(p.ADD_ORAL_MEDS_PER_DAY, PRICES.add.medsPerDay);
    PRICES.add.puppyCarePerDay = num(p.ADD_PUPPY_CARE_PER_DAY, PRICES.add.puppyCarePerDay);
    PRICES.add.homecarePerDay = num(p.ADD_HOMECARE_PER_DAY, PRICES.add.homecarePerDay);
    PRICES.add.foodSuppliesCreditPerDay = num(p.ADD_FOOD_SUPPLIES_CREDIT_PER_DAY, PRICES.add.foodSuppliesCreditPerDay);

    PRICES.add.extraDogPerDay = num(p.ADD_EXTRA_DOG_PER_DAY, PRICES.add.extraDogPerDay);
    PRICES.add.extraCatPerDay = num(p.ADD_EXTRA_CAT_PER_DAY, PRICES.add.extraCatPerDay);

    PRICES.add.keyTrip = num(p.ADD_KEYTRIP_ONE_TIME, PRICES.add.keyTrip);
    PRICES.add.petTaxi = num(p.ADD_PETTAXI_ONE_TIME, PRICES.add.petTaxi);
  }

  function fetchPricing(){
    if (!CONFIG.apiBaseUrl) return;
    const old = document.getElementById("jsonpPricing");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    url.searchParams.set("action", "pricing");
    url.searchParams.set("reqId", String(Date.now()));
    url.searchParams.set("callback", "pgPricingCallback");
    if (CONFIG.apiKey) url.searchParams.set("apiKey", CONFIG.apiKey);

    const script = document.createElement("script");
    script.id = "jsonpPricing";
    script.src = url.toString();
    script.onerror = () => { el("pricingStatus").textContent = "Pricing: using defaults (could not load)"; calc(); };
    document.body.appendChild(script);
  }

  function fetchAvailability() {
    if (!CONFIG.apiBaseUrl) {
      el("staffStatus").textContent = "API not connected";
      return;
    }
    el("staffStatus").textContent = "Checking‚Ä¶";

    const start = el("startDate").value;
    const end = el("endDate").value;
    const zone = el("zone").value;

    lastAvailabilityReqId += 1;
    const reqId = lastAvailabilityReqId;

    const old = document.getElementById("jsonpAvail");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    url.searchParams.set("action", "availability");
    url.searchParams.set("start", start);
    url.searchParams.set("end", end);
    url.searchParams.set("pkg", pkg);
    url.searchParams.set("zone", zone);
    url.searchParams.set("reqId", String(reqId));
    url.searchParams.set("callback", "pgAvailabilityCallback");
    if (CONFIG.apiKey) url.searchParams.set("apiKey", CONFIG.apiKey);

    const script = document.createElement("script");
    script.id = "jsonpAvail";
    script.src = url.toString();
    script.onerror = () => el("staffStatus").textContent = "Could not load availability";
    document.body.appendChild(script);
  }

  /* Keep this for your existing logic checks, hidden in UI */
  function renderStaffCarousel(staffList) {
    const wrap = el("staffCarousel");
    wrap.innerHTML = "";
    staffList.forEach((s) => {
      const card = document.createElement("div");
      card.innerHTML = `<span>${escapeHtml(s.name || "")}</span>`;
      wrap.appendChild(card);
    });
  }

  function calc() {
    const start = el("startDate").value;
    const end = el("endDate").value;
    const days = daysBetween(start, end);
    el("daysOut").textContent = days;

    const zone = el("zone").value;
    const travel = Number(PRICES.travelPerDay[zone] || 0);

    const peakApplied = bookingHasPeak(start, end);
    const peakMult = peakApplied ? PRICES.peakMultiplier : 1;

    el("peakNote").textContent = peakApplied ? `(peak pricing applied)` : ``;
    el("peakAppliedOut").textContent = peakApplied
      ? `Peak dates detected in your booking range (June-July or Dec to 15 Jan).`
      : `No peak dates detected in your booking range.`;

    const wDays = weightedDays(days);

    const dogs = Math.max(0, parseInt(el("dogs").value || "0", 10));
    const cats = Math.max(0, parseInt(el("cats").value || "0", 10));
    const { incDogs, incCats } = includedPetCount(dogs, cats);
    const extraDogs = Math.max(0, dogs - incDogs);
    const extraCats = Math.max(0, cats - incCats);

    const hours = parseInt(el("hours").value || "1", 10);
    el("hoursOut").textContent = hours;

    const updates = parseInt(el("updates").value || "0", 10);
    el("updatesOut").textContent = updates;

    const checkins = parseInt(el("checkins").value || "0", 10);
    el("checkinsOut").textContent = checkins;

    const walkMin = parseInt(el("walkMinutes").value || "0", 10);
    el("walkMinOut").textContent = walkMin;

    const walkCostPerDay = walkMin * PRICES.add.walkPerMinute;
    el("walkCostOut").textContent = money(walkCostPerDay);

    const meds = el("meds").checked;
    const puppy = el("puppy").checked;
    const homecare = el("homecare").checked;

    const foodAllowed = el("foodSupplies").checked;
    el("foodNote").classList.toggle("hidden", !foodAllowed);

    const keys = Math.max(0, parseInt(el("keys").value || "0", 10));
    const taxi = Math.max(0, parseInt(el("taxi").value || "0", 10));

    let basePerDay = 0;
    if (pkg === "day") basePerDay = hours * PRICES.base.dayHourly;
    if (pkg === "night") basePerDay = PRICES.base.night;
    if (pkg === "full") basePerDay = PRICES.base.fullDay;

    const checkinUnit = PRICES.add.checkin + (travel > 0 ? travel : 0);

    const addOnsPerDay =
      (updates * PRICES.add.updatePackPerDay) +
      (checkins * checkinUnit) +
      walkCostPerDay +
      (meds ? PRICES.add.medsPerDay : 0) +
      (puppy ? PRICES.add.puppyCarePerDay : 0) +
      (homecare ? PRICES.add.homecarePerDay : 0) +
      (foodAllowed ? -PRICES.add.foodSuppliesCreditPerDay : 0) +
      (extraDogs * PRICES.add.extraDogPerDay) +
      (extraCats * PRICES.add.extraCatPerDay) +
      travel;

    const oneTime = (keys * PRICES.add.keyTrip) + (taxi * PRICES.add.petTaxi);

    const dailyAfterPeak = (basePerDay + addOnsPerDay) * peakMult;
    const stayTotal = dailyAfterPeak * wDays;
    const total = stayTotal + oneTime;

    const noDiscountTotal = dailyAfterPeak * days + oneTime;
    const discountAmt = Math.max(0, noDiscountTotal - total);

    const deposit = total * CONFIG.depositPercent;
    const balance = total - deposit;

    el("totalOut").textContent = money(total);
    el("depositOut").textContent = money(deposit);
    el("balanceOut").textContent = money(balance);

    el("baseOut").textContent = money((basePerDay * peakMult) * wDays);
    el("addonsOut").textContent = money((addOnsPerDay * peakMult) * wDays);
    el("oneTimeOut").textContent = money(oneTime);
    el("discountOut").textContent = "-" + money(discountAmt);

    return {
      total, deposit, balance, days, wDays, peakApplied,
      inputs: {
        pkg, start, end, zone,
        dogs, cats,
        hours,
        updates,
        checkins,
        walkMinutes: walkMin,
        meds,
        puppy,
        homecare,
        foodAllowed,
        keys,
        taxi
      }
    };
  }

  function openModal() {
    const pricing = calc();
    const staffText = selectedStaff ? `${selectedStaff.name} (selected)` : "Not selected yet";

    el("modalSummary").innerHTML =
      `Package: <b>${escapeHtml(pkgLabel())}</b><br>` +
      `Dates: <b>${escapeHtml(pricing.inputs.start)}</b> to <b>${escapeHtml(pricing.inputs.end)}</b> (${pricing.days} days)<br>` +
      `Zone: <b>${escapeHtml(zoneLabel())}</b><br>` +
      `Sitter: <b>${escapeHtml(staffText)}</b><br>` +
      `Walk time/day: <b>${pricing.inputs.walkMinutes} min</b><br>` +
      `<br>` +
      `Total: <b>${money(pricing.total)}</b><br>` +
      `Deposit (50%): <b>${money(pricing.deposit)}</b><br>` +
      `Balance: <b>${money(pricing.balance)}</b>`;

    el("submitStatus").textContent = "";
    el("modalWrap").classList.remove("hidden");
  }

  function closeModal() {
    el("modalWrap").classList.add("hidden");
  }

  function validateBookingForm() {
    const name = el("custName").value.trim();
    const phone = el("custPhone").value.trim();
    const email = el("custEmail").value.trim();
    const hp = el("hpField").value.trim();
    if (hp) return { ok: false, msg: "Blocked." };
    if (!name) return { ok: false, msg: "Enter your name." };
    if (!phone) return { ok: false, msg: "Enter your phone number." };
    if (!email || !email.includes("@")) return { ok: false, msg: "Enter a valid email." };
    return { ok: true };
  }

  async function submitBooking() {
    const v = validateBookingForm();
    if (!v.ok) { el("submitStatus").textContent = v.msg; return; }

    const hasCarouselOptions = el("staffCarousel").children.length > 0;
    if (hasCarouselOptions && !selectedStaff) {
      el("submitStatus").textContent = "Select a sitter before submitting.";
      return;
    }

    const pricing = calc();
    const notes = el("custNotes").value.trim().slice(0, 800);

    el("submitStatus").textContent = "Sending‚Ä¶";

    const payload = {
      action: "booking",
      apiKey: CONFIG.apiKey || "",
      ts: new Date().toISOString(),

      customerName: el("custName").value.trim(),
      customerPhone: el("custPhone").value.trim(),
      customerEmail: el("custEmail").value.trim(),
      customerAddress: el("custAddress").value.trim(),
      customerNotes: notes,

      sitterId: selectedStaff ? (selectedStaff.id || "") : "",
      sitterName: selectedStaff ? (selectedStaff.name || "") : "",

      zone: el("zone").value,
      zoneLabel: zoneLabel(),

      pkg: pricing.inputs.pkg,
      start: pricing.inputs.start,
      end: pricing.inputs.end,
      days: String(pricing.days),

      total: String(Math.round(pricing.total)),
      deposit: String(Math.round(pricing.deposit)),
      balance: String(Math.round(pricing.balance)),

      selectionsJson: JSON.stringify(pricing.inputs)
    };

    const old = document.getElementById("jsonpBook");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    Object.entries(payload).forEach(([k, v]) => url.searchParams.set(k, String(v)));
    url.searchParams.set("reqId", String(Date.now()));
    url.searchParams.set("callback", "pgBookingCallback");

    const script = document.createElement("script");
    script.id = "jsonpBook";
    script.src = url.toString();
    script.onerror = () => el("submitStatus").textContent = "Could not send. Please try again.";
    document.body.appendChild(script);
  }

  async function copyQuote() {
    const pricing = calc();
    const staffLine = selectedStaff ? `Sitter: ${selectedStaff.name}` : `Sitter: Not selected`;
    const peakLine = pricing.peakApplied ? `Peak: Yes (auto)` : `Peak: No`;
    const text =
`${CONFIG.businessName} Quote Estimate
Package: ${pkgLabel()}
Dates: ${pricing.inputs.start} to ${pricing.inputs.end} (${pricing.days} days)
Zone: ${zoneLabel()}
${staffLine}
${peakLine}
Walk time/day: ${pricing.inputs.walkMinutes} min

Total: ${money(pricing.total)}
Deposit (50%): ${money(pricing.deposit)}
Balance: ${money(pricing.balance)}

Note: Final price confirmed after screening and availability.`;

    try {
      await navigator.clipboard.writeText(text);
      el("copyBtn").textContent = "Copied";
      setTimeout(()=> el("copyBtn").textContent="Copy Quote",1200);
    } catch {
      alert(text);
    }
  }

  function openHowModal(){ el("howModalWrap").classList.remove("hidden"); }
  function closeHowModal(){ el("howModalWrap").classList.add("hidden"); }

  function attach() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    el("startDate").value = `${yyyy}-${mm}-${dd}`;
    el("endDate").value = `${yyyy}-${mm}-${dd}`;

    document.querySelectorAll(".seg-btn").forEach(b => {
      b.addEventListener("click", () => {
        pkg = b.dataset.pkg;
        setPkgUI();
        calc();
        fetchAvailability();
      });
    });

    [
      "startDate","endDate","zone","dogs","cats",
      "updates","checkins","walkMinutes",
      "meds","puppy","homecare","keys","taxi","hours","foodSupplies"
    ].forEach(id => el(id).addEventListener("input", () => {
      calc();
      if (["startDate","endDate","zone"].includes(id)) fetchAvailability();
    }));

    el("copyBtn").addEventListener("click", copyQuote);
    el("requestBtn").addEventListener("click", openModal);
    el("closeModal").addEventListener("click", closeModal);
    el("modalWrap").addEventListener("click", (e) => { if (e.target === el("modalWrap")) closeModal(); });
    el("submitBooking").addEventListener("click", submitBooking);

    // Sitter modal events
    el("chooseSitterBtn").addEventListener("click", openSitterModal);
    el("closeSitterModal").addEventListener("click", closeSitterModal);
    el("sitterModalWrap").addEventListener("click", (e) => { if (e.target === el("sitterModalWrap")) closeSitterModal(); });
    el("sitterSearch").addEventListener("input", () => renderSitterModal(staffListCache));
    el("sitterSort").addEventListener("input", () => renderSitterModal(staffListCache));

    // Pricing rules modal events
    el("howBtn").addEventListener("click", openHowModal);
    el("closeHowModal").addEventListener("click", closeHowModal);
    el("howModalWrap").addEventListener("click", (e) => { if (e.target === el("howModalWrap")) closeHowModal(); });

    setPkgUI();
    fetchPricing();
    calc();
    fetchAvailability();
    updateSelectedSitterPanel();
  }

  attach();
</script>
</body>
</html>
