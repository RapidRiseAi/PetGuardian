<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetGuardian Care | Pricing Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --pg-forest:#0B2A1E;
      --pg-pine:#123629;
      --pg-champ:#F3E7D3;
      --pg-stone:#CBBFAE;
      --pg-brass:#B08D57;

      --pg-glass: rgba(18,54,41,0.60);
      --pg-card: rgba(10,40,28,0.56);
      --pg-border: rgba(176,141,87,0.26);
      --pg-muted: rgba(203,191,174,0.92);

      --pg-active-bg: rgba(243,231,211,0.58); /* transparent champagne */
      --pg-active-text: #0B2A1E;             /* black text */
    }

    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .font-lux{ font-family: Cinzel, Inter, system-ui, sans-serif; letter-spacing: 0.2px; }

    .bg-premium{
      background:
        radial-gradient(1000px 600px at 20% 0%, rgba(176,141,87,0.20), transparent 60%),
        radial-gradient(900px 600px at 95% 20%, rgba(243,231,211,0.10), transparent 55%),
        radial-gradient(900px 900px at 40% 120%, rgba(18,54,41,0.55), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55)),
        var(--pg-forest);
      color: var(--pg-champ);
    }

    .glass{
      background: rgba(18,54,41,0.62);
      border: 1px solid var(--pg-border);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    .card{
      background: var(--pg-card);
      border: 1px solid var(--pg-border);
    }

    .input{
      background: rgba(11,42,30,0.55);
      border: 1px solid rgba(176,141,87,0.22);
      color: var(--pg-champ);
      border-radius: 16px;
      padding: 10px 12px;
      outline: none;
      width: 100%;
    }
    .input::placeholder{ color: rgba(203,191,174,0.65); }

    .seg{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    .seg-btn{
      border: 1px solid rgba(176,141,87,0.28);
      background: rgba(11,42,30,0.45);
      border-radius: 18px;
      padding: 14px 14px;
      text-align: left;
      transition: all .18s ease;
      position: relative;
      overflow: hidden;
      color: var(--pg-champ);
    }
    .seg-btn .sub{ color: var(--pg-muted); font-size: 12px; margin-top: 3px; }
    .seg-btn.active{
      background: var(--pg-active-bg);
      border-color: rgba(176,141,87,0.70);
      color: var(--pg-active-text);
    }
    .seg-btn.active .sub{ color: rgba(11,42,30,0.82); }

    .btn{
      border-radius: 16px;
      padding: 10px 14px;
      font-weight: 700;
      border: 1px solid rgba(176,141,87,0.45);
      transition: all .18s ease;
    }
    .btn-primary{
      background: rgba(243,231,211,0.92);
      color: var(--pg-active-text);
    }
    .btn-ghost{
      background: rgba(11,42,30,0.22);
      color: var(--pg-champ);
      border-color: rgba(176,141,87,0.55);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity: 0.5; cursor: not-allowed; transform: none; }

    input[type="range"]{
      height: 26px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      width: 100%;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 7px;
      border-radius: 999px;
      background: rgba(243,231,211,0.16);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid rgba(243,231,211,0.95);
      margin-top: -7px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
    }
    input[type="range"]::-moz-range-track{
      height: 7px;
      border-radius: 999px;
      background: rgba(243,231,211,0.16);
      border: 1px solid rgba(176,141,87,0.30);
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--pg-brass);
      border: 2px solid rgba(243,231,211,0.95);
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      font-size: 12px;
      border: 1px solid rgba(176,141,87,0.35);
      background: rgba(11,42,30,0.55);
      color: var(--pg-stone);
    }

    .muted{ color: var(--pg-muted); }
    .thin-line{ height:1px; background: rgba(176,141,87,0.22); }

    #modalWrap, #staffModalWrap{ background: rgba(0,0,0,0.68); }
    .modal-box{ max-height: calc(100vh - 64px); overflow-y: auto; }

    /* Staff modal cards */
    .staff-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 640px){
      .staff-grid{ grid-template-columns: 1fr 1fr; }
    }
    .staff-modal-card{
      border-radius: 22px;
      border: 1px solid rgba(176,141,87,0.24);
      background: rgba(11,42,30,0.52);
      padding: 14px;
      text-align: left;
      transition: all .16s ease;
      color: var(--pg-champ);
    }
    .staff-modal-card:hover{
      border-color: rgba(176,141,87,0.55);
      transform: translateY(-1px);
    }
    .staff-modal-card.selected{
      background: var(--pg-active-bg);
      border-color: rgba(176,141,87,0.70);
      color: var(--pg-active-text);
    }
    .staff-modal-card.selected .muted{ color: rgba(11,42,30,0.82); }

    .lux-panel{
      background: rgba(11,42,30,0.38);
      border: 1px solid rgba(176,141,87,0.20);
      border-radius: 18px;
    }
  </style>
</head>

<body class="min-h-screen bg-premium">
  <div class="max-w-[1280px] mx-auto p-4 sm:p-8">
    <div class="rounded-[28px] p-5 sm:p-7 glass">

      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
               style="border:1px solid rgba(176,141,87,0.35); background: rgba(11,42,30,0.55);">
            <span style="color: var(--pg-brass); font-size:18px;">üêæ</span>
          </div>
          <div>
            <div class="pill">PetGuardian Care <span style="color: var(--pg-brass);">‚Ä¢</span> Premium Pricing</div>
            <div class="text-2xl sm:text-3xl font-lux mt-2">Get a care cost estimate</div>
            <div class="text-sm mt-1 muted">Start with a base stay, then select only what you need.</div>
            <div id="pricingStatus" class="text-xs mt-2 muted">Pricing: loading from sheet‚Ä¶</div>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="copyBtn" class="btn btn-primary">Copy Quote</button>
          <button id="requestBtn" class="btn btn-ghost">Request Booking</button>
        </div>
      </div>

      <div class="mt-5 thin-line"></div>

      <!-- PC LANDSCAPE LAYOUT -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-5">

        <!-- LEFT: Controls -->
        <div class="lg:col-span-8 space-y-4">

          <div class="card rounded-[24px] p-4">
            <div class="text-sm font-semibold">Base stay type</div>
            <div class="text-xs muted mt-1">This is the starting cost. Add-ons apply on top.</div>

            <div class="seg mt-3">
              <button class="seg-btn" data-pkg="day" type="button">
                <div class="flex items-center gap-2">
                  <span>üïí</span><span class="font-semibold">Day Visits</span>
                </div>
                <div class="sub">Hourly care (you set hours)</div>
              </button>

              <button class="seg-btn" data-pkg="night" type="button">
                <div class="flex items-center gap-2">
                  <span>üåô</span><span class="font-semibold">Overnight</span>
                </div>
                <div class="sub">6pm to 6am</div>
              </button>

              <button class="seg-btn" data-pkg="full" type="button">
                <div class="flex items-center gap-2">
                  <span>üè†</span><span class="font-semibold">Full-time</span>
                </div>
                <div class="sub">24h presence</div>
              </button>
            </div>

            <div id="hoursWrap" class="mt-4 hidden">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-semibold">Hours per day</div>
                  <div class="text-xs muted">Only used for Day Visits.</div>
                </div>
                <div class="text-sm"><span class="muted">Hours:</span> <span id="hoursOut" class="font-semibold">4</span></div>
              </div>
              <input id="hours" type="range" min="1" max="12" value="4" class="mt-2">
            </div>
          </div>

          <!-- Dates + Pets on desktop: side-by-side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="card rounded-[24px] p-4">
              <div class="text-sm font-semibold">Dates and zone</div>
              <div class="text-xs muted mt-1">Peak dates and long-stay discounts are calculated automatically.</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs muted">Start date</label>
                  <input id="startDate" type="date" class="input mt-1">
                </div>
                <div>
                  <label class="block text-xs muted">End date</label>
                  <input id="endDate" type="date" class="input mt-1">
                </div>
              </div>

              <div class="mt-3 text-sm">
                <span class="muted">Days:</span> <span id="daysOut" class="font-semibold">1</span>
                <span id="peakNote" class="ml-2 text-xs muted"></span>
              </div>

              <label class="block mt-3 text-xs muted">Zone</label>
              <select id="zone" class="input mt-1">
                <option value="sabie">Sabie (Zone A)</option>
                <option value="wr">White River (Zone B)</option>
                <option value="nel">Nelspruit (Zone C)</option>
              </select>

              <div class="mt-3 text-xs muted leading-relaxed">
                Travel is included where applicable. If your zone has travel fees, each check-in includes fuel cost.
              </div>
            </div>

            <div class="card rounded-[24px] p-4">
              <div class="text-sm font-semibold">Pets and options</div>
              <div class="text-xs muted mt-1">First pet is included. Extra pets add a daily care fee.</div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs muted">Dogs</label>
                  <input id="dogs" type="number" min="0" value="1" class="input mt-1">
                </div>
                <div>
                  <label class="block text-xs muted">Cats</label>
                  <input id="cats" type="number" min="0" value="0" class="input mt-1">
                </div>
              </div>

              <div class="mt-4 rounded-2xl p-3 lux-panel">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="text-sm font-semibold">Food supplies allowed for sitter use?</div>
                    <div class="text-xs muted mt-1">If allowed, deduct <b>R50</b> per day.</div>
                  </div>
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input id="foodSupplies" type="checkbox" class="accent-white">
                    <span>Allowed</span>
                  </label>
                </div>

                <div id="foodNote" class="mt-2 text-xs muted leading-relaxed hidden">
                  Please store off-limits items separately or clearly label containers/cupboards. Send photos before the booking starts.
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                <label class="flex items-start justify-between gap-3 rounded-2xl p-3 lux-panel">
                  <div>
                    <div class="text-sm font-semibold">Do you have a puppy?</div>
                    <div class="text-xs muted mt-1">Extra supervision, routine, and cleanup.</div>
                  </div>
                  <input id="puppy" type="checkbox" class="accent-white mt-1">
                </label>

                <label class="flex items-start justify-between gap-3 rounded-2xl p-3 lux-panel">
                  <div>
                    <div class="text-sm font-semibold">Oral meds needed?</div>
                    <div class="text-xs muted mt-1">We administer meds per your instructions.</div>
                  </div>
                  <input id="meds" type="checkbox" class="accent-white mt-1">
                </label>
              </div>

              <!-- Sitter selection lives here now -->
              <div class="mt-4 rounded-2xl p-3 lux-panel">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-semibold">Sitter selection</div>
                    <div id="staffStatus" class="text-xs muted mt-1">Checking availability‚Ä¶</div>
                  </div>
                  <button id="chooseSitterBtn" class="btn btn-primary" type="button" disabled>Choose sitter</button>
                </div>

                <div id="selectedSitterPreview" class="mt-3 hidden">
                  <div class="flex items-center gap-3">
                    <img id="selPhoto" class="w-14 h-14 rounded-2xl object-cover border"
                         style="border-color: rgba(176,141,87,0.28); background: rgba(0,0,0,0.2);"/>
                    <div class="min-w-0">
                      <div id="selName" class="font-semibold font-lux truncate"></div>
                      <div id="selTitle" class="text-xs muted mt-1"></div>
                      <div class="text-xs muted mt-1">Rating: <span id="selRating" class="font-semibold"></span></div>
                    </div>
                  </div>
                  <div id="selBio" class="text-xs muted mt-3 leading-relaxed"></div>
                </div>

                <div id="noSitterNote" class="text-xs muted mt-3">
                  If you do not select a sitter, your request cannot be submitted.
                </div>
              </div>

            </div>
          </div>

          <div class="card rounded-[24px] p-4">
            <div class="text-sm font-semibold">Add-ons</div>
            <div class="text-xs muted mt-1">Add only what you want. Everything is calculated per day unless stated otherwise.</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Daily update packs</div>
                    <div class="text-xs muted">Photos plus a short written log.</div>
                  </div>
                  <div class="text-sm"><span class="muted">Qty:</span> <span id="updatesOut" class="font-semibold">0</span></div>
                </div>
                <input id="updates" type="range" min="0" max="2" step="1" value="0" class="mt-2">
              </div>

              <div>
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Check-ins per day</div>
                    <div class="text-xs muted">Short visit for feed, water, toilet check, quick play.</div>
                  </div>
                  <div class="text-sm"><span class="muted">Qty:</span> <span id="checkinsOut" class="font-semibold">0</span></div>
                </div>
                <input id="checkins" type="range" min="0" max="3" step="1" value="0" class="mt-2">
                <div class="text-xs muted mt-1">If your zone has travel fees, each check-in includes fuel cost.</div>
              </div>

              <div class="md:col-span-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Walk time per day</div>
                    <div class="text-xs muted">Single slider in 5 minute steps. Priced at <b>R60 per hour</b>.</div>
                  </div>
                  <div class="text-sm">
                    <span class="muted">Minutes:</span> <span id="walkMinOut" class="font-semibold">0</span>
                    <span class="muted ml-3">Cost/day:</span> <span id="walkCostOut" class="font-semibold">R0</span>
                  </div>
                </div>
                <input id="walkMinutes" type="range" min="0" max="180" step="5" value="0" class="mt-2">
              </div>

              <label class="flex items-start justify-between gap-3 rounded-2xl p-3 lux-panel">
                <div>
                  <div class="text-sm font-semibold">Home care pack</div>
                  <div class="text-xs muted mt-1">Bins, lights, basic tidy, quick checks.</div>
                </div>
                <input id="homecare" type="checkbox" class="accent-white mt-1">
              </label>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs muted">Key trips (one-time)</label>
                  <input id="keys" type="number" min="0" value="0" class="input mt-1">
                  <div class="text-xs muted mt-1">Drop-off or pickup keys.</div>
                </div>
                <div>
                  <label class="block text-xs muted">Pet taxi (one-time)</label>
                  <input id="taxi" type="number" min="0" value="0" class="input mt-1">
                  <div class="text-xs muted mt-1">Vet run or transport.</div>
                </div>
              </div>

              <div class="md:col-span-2 text-xs muted leading-relaxed">
                You will receive the final invoice after screening and confirming sitter availability.
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: Totals, sticky on desktop -->
        <div class="lg:col-span-4">
          <div class="card rounded-[24px] p-5 lg:sticky lg:top-6">
            <div class="text-sm font-semibold">Total estimate</div>
            <div id="totalOut" class="text-4xl font-lux mt-2">R0</div>

            <div class="mt-4 thin-line"></div>

            <div class="mt-4 space-y-2 text-sm">
              <div class="flex items-center justify-between"><span class="muted">Base stay</span><span id="baseOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">Add-ons + travel</span><span id="addonsOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">Long-stay discount</span><span id="discountOut" class="font-semibold">R0</span></div>
              <div class="flex items-center justify-between"><span class="muted">One-time fees</span><span id="oneTimeOut" class="font-semibold">R0</span></div>
            </div>

            <div id="peakAppliedOut" class="text-xs muted mt-3"></div>

            <div class="mt-4 rounded-2xl p-3"
                 style="background: rgba(243,231,211,0.18); border: 1px solid rgba(176,141,87,0.20);">
              <div class="text-xs muted">Deposit required</div>
              <div class="text-xl font-semibold mt-1" id="depositOut">R0</div>
              <div class="text-xs muted mt-2">Balance after service</div>
              <div class="text-xl font-semibold mt-1" id="balanceOut">R0</div>
              <div class="text-xs muted mt-3">
                50% deposit secures booking. Remaining 50% due after service.
              </div>
            </div>

            <div class="mt-4 text-xs muted leading-relaxed">
              Final price is confirmed after screening and availability.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Booking Modal -->
  <div id="modalWrap" class="fixed inset-0 hidden overflow-y-auto">
    <div class="max-w-xl mx-auto p-4 sm:p-8 pb-24">
      <div class="rounded-[24px] p-5 sm:p-6 glass modal-box">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">Request Booking</div>
            <div class="text-xl font-lux font-semibold mt-1">Your details</div>
            <div class="text-xs mt-2 muted">
              We will email an invoice/estimate. Deposit required is 50%.
            </div>
          </div>
          <button id="closeModal" class="btn btn-ghost">Close</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block text-xs muted">Full name</label>
            <input id="custName" class="input mt-1" placeholder="Your name">
          </div>
          <div>
            <label class="block text-xs muted">Phone</label>
            <input id="custPhone" class="input mt-1" placeholder="e.g. 081 532 8774">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Email</label>
            <input id="custEmail" class="input mt-1" placeholder="you@example.com">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Address or area</label>
            <input id="custAddress" class="input mt-1" placeholder="Street or area">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs muted">Notes</label>
            <textarea id="custNotes" rows="3" class="input mt-1" placeholder="Routine, meds, temperament, gate access, etc."></textarea>
          </div>

          <div class="hidden">
            <label>Website</label>
            <input id="hpField" class="input mt-1" placeholder="Leave blank">
          </div>
        </div>

        <div class="rounded-2xl p-3 mt-4"
             style="background: rgba(11,42,30,0.35); border: 1px solid rgba(176,141,87,0.20);">
          <div class="text-xs muted">Summary</div>
          <div id="modalSummary" class="text-sm mt-2" style="color: rgba(203,191,174,0.95);"></div>
        </div>

        <div class="flex items-center justify-between gap-3 mt-4">
          <div class="text-xs muted">By requesting, you agree to deposit terms.</div>
          <button id="submitBooking" class="btn btn-primary">Send Request</button>
        </div>

        <div id="submitStatus" class="text-xs mt-3 muted"></div>
      </div>
    </div>
  </div>

  <!-- Staff Selection Modal -->
  <div id="staffModalWrap" class="fixed inset-0 hidden overflow-y-auto">
    <div class="max-w-4xl mx-auto p-4 sm:p-8 pb-24">
      <div class="rounded-[24px] p-5 sm:p-6 glass modal-box">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">Choose sitter</div>
            <div class="text-xl font-lux font-semibold mt-1">Available sitters</div>
            <div class="text-xs mt-2 muted">
              Pick who you want for these dates. Once you submit, that sitter is blocked for your date range.
            </div>
          </div>
          <button id="closeStaffModal" class="btn btn-ghost">Close</button>
        </div>

        <div class="mt-4 thin-line"></div>

        <div id="staffModalStatus" class="text-xs muted mt-4">Loading‚Ä¶</div>
        <div id="staffGrid" class="staff-grid mt-3"></div>

        <div id="staffModalEmpty" class="hidden text-sm muted mt-4">
          No sitters available for these dates. Try different dates or a different stay type.
        </div>
      </div>
    </div>
  </div>

<script>
  const CONFIG = {
    businessName: "PetGuardian Care",
    depositPercent: 0.50,

    // Keep your Apps Script URL here
    apiBaseUrl: "https://script.google.com/macros/s/AKfycbzfqeIQFLpa155Gf-454kbaSQUEw9RpiqISwnPbSkfYPV-aU6LZlbTbkG5jv-sHe6jp/exec",
    apiKey: ""
  };

  // Defaults (will be overridden by Pricing tab values if present)
  const PRICES = {
    base: { dayHourly: 60, night: 150, fullDay: 320 },
    travelPerDay: { sabie: 0, wr: 30, nel: 60 },
    peakMultiplier: 1.15,

    add: {
      updatePackPerDay: 50,
      checkin: 50,
      // Walks derived from minutes: R60 per hour => R1 per minute
      walkPerMinute: 1,

      medsPerDay: 50,
      puppyCarePerDay: 100,
      homecarePerDay: 30,
      foodSuppliesCreditPerDay: 50,
      extraDogPerDay: 50,
      extraCatPerDay: 30,
      keyTrip: 50,
      petTaxi: 150
    },

    longStay: { blockDays: 10, factor: 0.9 }
  };

  let pkg = "day";
  let selectedStaff = null;
  let availableStaff = [];
  let lastAvailabilityReqId = 0;

  const el = (id) => document.getElementById(id);

  function money(n){
    const v = Math.round(Number(n) || 0);
    return "R" + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function daysBetween(start, end) {
    if (!start || !end) return 1;
    const s = new Date(start);
    const e = new Date(end);
    const diff = Math.round((e - s) / (1000*60*60*24)) + 1;
    return Math.max(1, diff);
  }

  function isPeakDate(dateObj){
    const m = dateObj.getMonth(); // 0 Jan
    const d = dateObj.getDate();
    if (m === 5 || m === 6) return true; // Jun, Jul
    if (m === 11) return true;           // Dec
    if (m === 0 && d <= 15) return true; // Jan 1-15
    return false;
  }

  function bookingHasPeak(startStr, endStr){
    if (!startStr || !endStr) return false;
    const s = new Date(startStr);
    const e = new Date(endStr);
    s.setHours(0,0,0,0);
    e.setHours(0,0,0,0);
    for (let dt = new Date(s); dt <= e; dt.setDate(dt.getDate()+1)){
      if (isPeakDate(dt)) return true;
    }
    return false;
  }

  function weightedDays(days) {
    const { blockDays, factor } = PRICES.longStay;
    const blocks = Math.floor(days / blockDays);
    const rem = days % blockDays;
    if (blocks === 0) return days;
    const series = blockDays * (1 - Math.pow(factor, blocks)) / (1 - factor);
    return series + rem * Math.pow(factor, blocks);
  }

  function includedPetCount(dogs, cats) {
    if (dogs > 0) return { incDogs: 1, incCats: 0 };
    if (cats > 0) return { incDogs: 0, incCats: 1 };
    return { incDogs: 0, incCats: 0 };
  }

  function pkgLabel() {
    if (pkg === "day") return "Day Visits";
    if (pkg === "night") return "Overnight";
    return "Full-time";
  }

  function zoneLabel() {
    return el("zone").selectedOptions[0].textContent;
  }

  function setPkgUI() {
    document.querySelectorAll(".seg-btn").forEach(b => {
      const active = b.dataset.pkg === pkg;
      b.classList.toggle("active", active);
    });
    el("hoursWrap").classList.toggle("hidden", pkg !== "day");
  }

  // JSONP callbacks
  window.pgAvailabilityCallback = function(payload) {
    if (!payload || payload.reqId != lastAvailabilityReqId) return;

    availableStaff = payload.staff || [];

    if (!availableStaff.length) {
      el("staffStatus").textContent = "No sitters available for these dates";
      el("chooseSitterBtn").disabled = true;
      // Clear selection if it is no longer valid
      selectedStaff = null;
      renderSelectedSitterPreview();
      return;
    }

    el("staffStatus").textContent = "Sitters available. Choose your sitter.";
    el("chooseSitterBtn").disabled = false;

    // If selected sitter is not in list anymore, clear it
    if (selectedStaff && !availableStaff.some(s => String(s.id) === String(selectedStaff.id))) {
      selectedStaff = null;
    }
    renderSelectedSitterPreview();
  };

  window.pgBookingCallback = function(payload) {
    if (!payload || payload.ok !== true) {
      el("submitStatus").textContent = (payload && payload.error) ? payload.error : "Booking failed. Please try again.";
      return;
    }
    el("submitStatus").textContent =
      "Request sent. Check your email for the invoice/estimate. If you do not receive it, WhatsApp us with your name and dates.";
    setTimeout(() => closeModal(), 1600);
  };

  window.pgPricingCallback = function(payload){
    if (!payload || payload.ok !== true) {
      el("pricingStatus").textContent = "Pricing: using defaults (Pricing tab not found)";
      calc();
      return;
    }
    const p = payload.pricing || {};
    applyPricingFromSheet(p);
    el("pricingStatus").textContent = "Pricing: loaded from sheet";
    calc();
  };

  function applyPricingFromSheet(p){
    const num = (v, fallback) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };

    PRICES.base.dayHourly = num(p.BASE_DAY_HOURLY, PRICES.base.dayHourly);
    PRICES.base.night = num(p.BASE_NIGHT, PRICES.base.night);
    PRICES.base.fullDay = num(p.BASE_FULLDAY, PRICES.base.fullDay);

    PRICES.travelPerDay.sabie = num(p.TRAVEL_SABIE, PRICES.travelPerDay.sabie);
    PRICES.travelPerDay.wr = num(p.TRAVEL_WR, PRICES.travelPerDay.wr);
    PRICES.travelPerDay.nel = num(p.TRAVEL_NEL, PRICES.travelPerDay.nel);

    PRICES.peakMultiplier = num(p.PEAK_MULTIPLIER, PRICES.peakMultiplier);

    PRICES.longStay.blockDays = num(p.DISCOUNT_BLOCK_DAYS, PRICES.longStay.blockDays);
    PRICES.longStay.factor = num(p.DISCOUNT_FACTOR, PRICES.longStay.factor);

    PRICES.add.updatePackPerDay = num(p.ADD_UPDATE_PACK_PER_DAY, PRICES.add.updatePackPerDay);
    PRICES.add.checkin = num(p.ADD_CHECKIN, PRICES.add.checkin);

    PRICES.add.medsPerDay = num(p.ADD_ORAL_MEDS_PER_DAY, PRICES.add.medsPerDay);
    PRICES.add.puppyCarePerDay = num(p.ADD_PUPPY_CARE_PER_DAY, PRICES.add.puppyCarePerDay);
    PRICES.add.homecarePerDay = num(p.ADD_HOMECARE_PER_DAY, PRICES.add.homecarePerDay);
    PRICES.add.foodSuppliesCreditPerDay = num(p.ADD_FOOD_SUPPLIES_CREDIT_PER_DAY, PRICES.add.foodSuppliesCreditPerDay);

    PRICES.add.extraDogPerDay = num(p.ADD_EXTRA_DOG_PER_DAY, PRICES.add.extraDogPerDay);
    PRICES.add.extraCatPerDay = num(p.ADD_EXTRA_CAT_PER_DAY, PRICES.add.extraCatPerDay);

    PRICES.add.keyTrip = num(p.ADD_KEYTRIP_ONE_TIME, PRICES.add.keyTrip);
    PRICES.add.petTaxi = num(p.ADD_PETTAXI_ONE_TIME, PRICES.add.petTaxi);
  }

  function fetchPricing(){
    if (!CONFIG.apiBaseUrl) return;
    const old = document.getElementById("jsonpPricing");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    url.searchParams.set("action", "pricing");
    url.searchParams.set("reqId", String(Date.now()));
    url.searchParams.set("callback", "pgPricingCallback");
    if (CONFIG.apiKey) url.searchParams.set("apiKey", CONFIG.apiKey);

    const script = document.createElement("script");
    script.id = "jsonpPricing";
    script.src = url.toString();
    script.onerror = () => { el("pricingStatus").textContent = "Pricing: using defaults (could not load)"; calc(); };
    document.body.appendChild(script);
  }

  function fetchAvailability() {
    if (!CONFIG.apiBaseUrl) {
      el("staffStatus").textContent = "API not connected";
      return;
    }
    el("staffStatus").textContent = "Checking availability‚Ä¶";
    el("chooseSitterBtn").disabled = true;

    const start = el("startDate").value;
    const end = el("endDate").value;
    const zone = el("zone").value;

    lastAvailabilityReqId += 1;
    const reqId = lastAvailabilityReqId;

    const old = document.getElementById("jsonpAvail");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    url.searchParams.set("action", "availability");
    url.searchParams.set("start", start);
    url.searchParams.set("end", end);
    url.searchParams.set("pkg", pkg);
    url.searchParams.set("zone", zone);
    url.searchParams.set("reqId", String(reqId));
    url.searchParams.set("callback", "pgAvailabilityCallback");
    if (CONFIG.apiKey) url.searchParams.set("apiKey", CONFIG.apiKey);

    const script = document.createElement("script");
    script.id = "jsonpAvail";
    script.src = url.toString();
    script.onerror = () => el("staffStatus").textContent = "Could not load availability";
    document.body.appendChild(script);
  }

  function renderSelectedSitterPreview(){
    const has = !!selectedStaff;
    el("selectedSitterPreview").classList.toggle("hidden", !has);

    if (!has) return;

    el("selPhoto").src = selectedStaff.photoUrl || "";
    el("selName").textContent = selectedStaff.name || "";
    el("selTitle").textContent = selectedStaff.title || "PetGuardian Care Sitter";
    el("selRating").textContent = String(selectedStaff.rating || "5.0");
    el("selBio").textContent = selectedStaff.bio || "";
  }

  function calc() {
    const start = el("startDate").value;
    const end = el("endDate").value;
    const days = daysBetween(start, end);
    el("daysOut").textContent = days;

    const zone = el("zone").value;
    const travel = Number(PRICES.travelPerDay[zone] || 0);

    const peakApplied = bookingHasPeak(start, end);
    const peakMult = peakApplied ? PRICES.peakMultiplier : 1;

    el("peakNote").textContent = peakApplied ? "(peak pricing applied)" : "";
    el("peakAppliedOut").textContent = peakApplied
      ? "Peak dates detected in your booking range (June to July, or Dec to 15 Jan)."
      : "No peak dates detected in your booking range.";

    // Long-stay is automatic, always on
    const wDays = weightedDays(days);

    const dogs = Math.max(0, parseInt(el("dogs").value || "0", 10));
    const cats = Math.max(0, parseInt(el("cats").value || "0", 10));
    const { incDogs, incCats } = includedPetCount(dogs, cats);
    const extraDogs = Math.max(0, dogs - incDogs);
    const extraCats = Math.max(0, cats - incCats);

    const hours = parseInt(el("hours").value || "1", 10);
    el("hoursOut").textContent = hours;

    const updates = parseInt(el("updates").value || "0", 10);
    el("updatesOut").textContent = updates;

    const checkins = parseInt(el("checkins").value || "0", 10);
    el("checkinsOut").textContent = checkins;

    const walkMin = parseInt(el("walkMinutes").value || "0", 10);
    el("walkMinOut").textContent = walkMin;

    const walkCostPerDay = walkMin * PRICES.add.walkPerMinute;
    el("walkCostOut").textContent = money(walkCostPerDay);

    const meds = el("meds").checked;
    const puppy = el("puppy").checked;
    const homecare = el("homecare").checked;

    const foodAllowed = el("foodSupplies").checked;
    el("foodNote").classList.toggle("hidden", !foodAllowed);

    const keys = Math.max(0, parseInt(el("keys").value || "0", 10));
    const taxi = Math.max(0, parseInt(el("taxi").value || "0", 10));

    let basePerDay = 0;
    if (pkg === "day") basePerDay = hours * PRICES.base.dayHourly;
    if (pkg === "night") basePerDay = PRICES.base.night;
    if (pkg === "full") basePerDay = PRICES.base.fullDay;

    const checkinUnit = PRICES.add.checkin + (travel > 0 ? travel : 0);

    const addOnsPerDay =
      (updates * PRICES.add.updatePackPerDay) +
      (checkins * checkinUnit) +
      walkCostPerDay +
      (meds ? PRICES.add.medsPerDay : 0) +
      (puppy ? PRICES.add.puppyCarePerDay : 0) +
      (homecare ? PRICES.add.homecarePerDay : 0) +
      (foodAllowed ? -PRICES.add.foodSuppliesCreditPerDay : 0) +
      (extraDogs * PRICES.add.extraDogPerDay) +
      (extraCats * PRICES.add.extraCatPerDay) +
      travel;

    const oneTime = (keys * PRICES.add.keyTrip) + (taxi * PRICES.add.petTaxi);

    const dailyAfterPeak = (basePerDay + addOnsPerDay) * peakMult;
    const stayTotal = dailyAfterPeak * wDays;
    const total = stayTotal + oneTime;

    const noDiscountTotal = dailyAfterPeak * days + oneTime;
    const discountAmt = Math.max(0, noDiscountTotal - total);

    const deposit = total * CONFIG.depositPercent;
    const balance = total - deposit;

    el("totalOut").textContent = money(total);
    el("depositOut").textContent = money(deposit);
    el("balanceOut").textContent = money(balance);

    el("baseOut").textContent = money((basePerDay * peakMult) * wDays);
    el("addonsOut").textContent = money((addOnsPerDay * peakMult) * wDays);
    el("oneTimeOut").textContent = money(oneTime);
    el("discountOut").textContent = "-" + money(discountAmt);

    return {
      total, deposit, balance, days, wDays, peakApplied,
      inputs: {
        pkg, start, end, zone,
        dogs, cats,
        hours,
        updates,
        checkins,
        walkMinutes: walkMin,
        meds,
        puppy,
        homecare,
        foodAllowed,
        keys,
        taxi
      }
    };
  }

  function openModal() {
    const pricing = calc();

    if (!selectedStaff && availableStaff.length) {
      alert("Please choose a sitter before requesting a booking.");
      return;
    }

    const staffText = selectedStaff ? `${selectedStaff.name} (selected)` : "Not selected";
    el("modalSummary").innerHTML =
      `Package: <b>${escapeHtml(pkgLabel())}</b><br>` +
      `Dates: <b>${escapeHtml(pricing.inputs.start)}</b> to <b>${escapeHtml(pricing.inputs.end)}</b> (${pricing.days} days)<br>` +
      `Zone: <b>${escapeHtml(zoneLabel())}</b><br>` +
      `Sitter: <b>${escapeHtml(staffText)}</b><br>` +
      `Walk time/day: <b>${pricing.inputs.walkMinutes} min</b><br>` +
      `<br>` +
      `Total: <b>${money(pricing.total)}</b><br>` +
      `Deposit (50%): <b>${money(pricing.deposit)}</b><br>` +
      `Balance: <b>${money(pricing.balance)}</b>`;

    el("submitStatus").textContent = "";
    el("modalWrap").classList.remove("hidden");
  }

  function closeModal() { el("modalWrap").classList.add("hidden"); }

  function validateBookingForm() {
    const name = el("custName").value.trim();
    const phone = el("custPhone").value.trim();
    const email = el("custEmail").value.trim();
    const hp = el("hpField").value.trim();

    if (hp) return { ok: false, msg: "Blocked." };
    if (!name) return { ok: false, msg: "Enter your name." };
    if (!phone) return { ok: false, msg: "Enter your phone number." };
    if (!email || !email.includes("@")) return { ok: false, msg: "Enter a valid email." };

    if (availableStaff.length && !selectedStaff) return { ok: false, msg: "Choose a sitter before submitting." };

    return { ok: true };
  }

  async function submitBooking() {
    const v = validateBookingForm();
    if (!v.ok) { el("submitStatus").textContent = v.msg; return; }

    const pricing = calc();
    const notes = el("custNotes").value.trim().slice(0, 800);

    el("submitStatus").textContent = "Sending‚Ä¶";

    const payload = {
      action: "booking",
      apiKey: CONFIG.apiKey || "",
      ts: new Date().toISOString(),

      customerName: el("custName").value.trim(),
      customerPhone: el("custPhone").value.trim(),
      customerEmail: el("custEmail").value.trim(),
      customerAddress: el("custAddress").value.trim(),
      customerNotes: notes,

      sitterId: selectedStaff ? (selectedStaff.id || "") : "",
      sitterName: selectedStaff ? (selectedStaff.name || "") : "",

      zone: el("zone").value,
      zoneLabel: zoneLabel(),

      pkg: pricing.inputs.pkg,
      start: pricing.inputs.start,
      end: pricing.inputs.end,
      days: String(pricing.days),

      total: String(Math.round(pricing.total)),
      deposit: String(Math.round(pricing.deposit)),
      balance: String(Math.round(pricing.balance)),

      selectionsJson: JSON.stringify(pricing.inputs)
    };

    const old = document.getElementById("jsonpBook");
    if (old) old.remove();

    const url = new URL(CONFIG.apiBaseUrl);
    Object.entries(payload).forEach(([k, v]) => url.searchParams.set(k, String(v)));
    url.searchParams.set("reqId", String(Date.now()));
    url.searchParams.set("callback", "pgBookingCallback");

    const script = document.createElement("script");
    script.id = "jsonpBook";
    script.src = url.toString();
    script.onerror = () => el("submitStatus").textContent = "Could not send. Please try again.";
    document.body.appendChild(script);
  }

  async function copyQuote() {
    const pricing = calc();
    const staffLine = selectedStaff ? `Sitter: ${selectedStaff.name}` : `Sitter: Not selected`;
    const peakLine = pricing.peakApplied ? `Peak: Yes (auto)` : `Peak: No`;
    const text =
`${CONFIG.businessName} Quote Estimate
Package: ${pkgLabel()}
Dates: ${pricing.inputs.start} to ${pricing.inputs.end} (${pricing.days} days)
Zone: ${zoneLabel()}
${staffLine}
${peakLine}
Walk time/day: ${pricing.inputs.walkMinutes} min

Total: ${money(pricing.total)}
Deposit (50%): ${money(pricing.deposit)}
Balance: ${money(pricing.balance)}

Note: Final price confirmed after screening and availability.`;

    try {
      await navigator.clipboard.writeText(text);
      el("copyBtn").textContent = "Copied";
      setTimeout(()=> el("copyBtn").textContent="Copy Quote",1200);
    } catch {
      alert(text);
    }
  }

  function openStaffModal(){
    el("staffModalWrap").classList.remove("hidden");
    renderStaffModal();
  }
  function closeStaffModal(){
    el("staffModalWrap").classList.add("hidden");
  }

  function renderStaffModal(){
    el("staffGrid").innerHTML = "";
    el("staffModalEmpty").classList.add("hidden");

    if (!availableStaff.length){
      el("staffModalStatus").textContent = "No sitters available.";
      el("staffModalEmpty").classList.remove("hidden");
      return;
    }

    el("staffModalStatus").textContent = "Select your sitter.";

    availableStaff.forEach((s) => {
      const card = document.createElement("button");
      card.type = "button";
      card.className = "staff-modal-card";
      if (selectedStaff && String(selectedStaff.id) === String(s.id)) {
        card.classList.add("selected");
      }

      const img = escapeHtml(s.photoUrl || "");
      const name = escapeHtml(s.name || "Sitter");
      const title = escapeHtml(s.title || "PetGuardian Care Sitter");
      const bio = escapeHtml(s.bio || "Professional sitter");
      const rating = escapeHtml(String(s.rating || "5.0"));

      card.innerHTML = `
        <div class="flex items-start gap-3">
          <img src="${img}" class="w-20 h-20 sm:w-24 sm:h-24 rounded-2xl object-cover border"
               style="border-color: rgba(176,141,87,0.28); background: rgba(0,0,0,0.2);" />
          <div class="min-w-0">
            <div class="font-lux font-semibold text-lg truncate">${name}</div>
            <div class="text-xs muted mt-1">${title}</div>
            <div class="text-xs muted mt-2">Rating: <span class="font-semibold">${rating}</span></div>
          </div>
        </div>
        <div class="text-sm mt-3 leading-relaxed">${bio}</div>
        <div class="mt-4 flex items-center justify-end">
          <div class="btn btn-primary" style="padding:8px 12px;">Select</div>
        </div>
      `;

      card.addEventListener("click", () => {
        selectedStaff = s;
        renderSelectedSitterPreview();
        closeStaffModal();
      });

      el("staffGrid").appendChild(card);
    });
  }

  function attach() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    el("startDate").value = `${yyyy}-${mm}-${dd}`;
    el("endDate").value = `${yyyy}-${mm}-${dd}`;

    document.querySelectorAll(".seg-btn").forEach(b => {
      b.addEventListener("click", () => {
        pkg = b.dataset.pkg;
        setPkgUI();
        calc();
        fetchAvailability();
      });
    });

    [
      "startDate","endDate","zone","dogs","cats",
      "updates","checkins","walkMinutes",
      "meds","puppy","homecare","keys","taxi","hours","foodSupplies"
    ].forEach(id => el(id).addEventListener("input", () => {
      calc();
      if (["startDate","endDate","zone"].includes(id)) fetchAvailability();
    }));

    el("copyBtn").addEventListener("click", copyQuote);
    el("requestBtn").addEventListener("click", openModal);
    el("closeModal").addEventListener("click", closeModal);
    el("modalWrap").addEventListener("click", (e) => { if (e.target === el("modalWrap")) closeModal(); });
    el("submitBooking").addEventListener("click", submitBooking);

    el("chooseSitterBtn").addEventListener("click", openStaffModal);
    el("closeStaffModal").addEventListener("click", closeStaffModal);
    el("staffModalWrap").addEventListener("click", (e) => { if (e.target === el("staffModalWrap")) closeStaffModal(); });

    setPkgUI();
    fetchPricing();
    calc();
    fetchAvailability();
  }

  attach();
</script>
</body>
</html>
