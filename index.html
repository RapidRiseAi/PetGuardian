<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetGuardian Care | Care Estimate</title>

  <!-- =========================
       CONFIG (EDIT ME)
       All editable variables live here.
       ========================= -->
  <script>
  const CONFIG = {
    // API base URL (recommended: Cloudflare Worker).
    apiBaseUrl: "https://petguardian-api.team-a6c.workers.dev",


    // Backup (direct Apps Script). Normally not used when Cloudflare Worker is running.
    appsScriptExecUrl: "https://script.google.com/macros/s/AKfycbzfqeIQFLpa155Gf-454kbaSQUEw9RpiqISwnPbSkfYPV-aU6LZlbTbkG5jv-sHe6jp/exec",
    // API timeout for each call (ms)
    apiTimeoutMs: 9000,

    // Assets (keep files in same GitHub folder as index.html)
    logoUrl: "logo.png",
    bgUrl: "bg.jpeg",
    facePreviews: ["face1.png", "face2.png", "face3.png"],

    // Deposit percent
    depositPercent: 0.50,

    // If true, show debug text in console
    debug: false
  };
  </script>


  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Design tokens */
      --bg: #07130f;
      --panel: rgba(10, 26, 20, 0.84);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --gold: #e8d2a2;
      --goldHover: #f2ddb4;
      --radiusSmall: 12px;
      --radiusMedium: 18px;
      --radiusLarge: 26px;
      --shadowSoft: 0 14px 36px rgba(0,0,0,0.34);
      --shadowMedium: 0 24px 60px rgba(0,0,0,0.48);
      --space1: 8px;
      --space2: 16px;
      --space3: 24px;
      --space4: 32px;
      --focusRing: rgba(232,210,162,0.4);
      --bg0: var(--bg);
      --bg1: #0b1e17;
      --card: var(--panel);
      --card2: rgba(9, 23, 18, 0.92);
      --stroke: rgba(225, 205, 160, 0.12);
      --stroke2: rgba(225, 205, 160, 0.2);
      --gold2: #caa96a;
      --txt: var(--text);
      --muted2: rgba(255,255,255,0.48);
      --shadow: var(--shadowMedium);
      --shadow2: var(--shadowSoft);
      --radius: var(--radiusLarge);
    }

    html, body{ height: 100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(170, 210, 185, 0.10), transparent 55%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(232, 210, 162, 0.08), transparent 50%),
                  linear-gradient(180deg, var(--bg0), #040b08 65%);
      overflow: auto; /* allow scroll when needed */
    }

    /* Texture image */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("bg.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.22;
      filter: saturate(0.85) contrast(1.08);
      transform: translateZ(0);
      pointer-events: none;
    }
    /* Soft vignette and grain */
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(0,0,0,0.15), transparent 55%),
        radial-gradient(1000px 800px at 50% 100%, rgba(0,0,0,0.55), transparent 65%),
        linear-gradient(90deg, rgba(0,0,0,0.35), transparent 18%, transparent 82%, rgba(0,0,0,0.35));
      pointer-events: none;
      mix-blend-mode: normal;
    }

    .shell{
      width: min(1360px, calc(100vw - 40px));
      min-height: min(92vh, 920px);
      height: auto;
      margin: 22px auto;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(11, 26, 19, 0.86), rgba(6, 16, 12, 0.92));
      box-shadow: var(--shadow);
      border: 1px solid rgba(232, 210, 162, 0.18);
      position: relative;
      overflow: hidden;
    }

    .shell::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 540px at 15% 10%, rgba(232, 210, 162, 0.10), transparent 60%),
        radial-gradient(700px 520px at 85% 25%, rgba(170, 210, 185, 0.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.06), transparent 30%);
      pointer-events:none;
    }

    .topbar{
      position: relative;
      z-index: 2;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 18px 20px 12px 20px;
      border-bottom: 1px solid rgba(232, 210, 162, 0.16);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }
    .logoWrap{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(232, 210, 162, 0.22);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .logoWrap img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .brandTitle{
      line-height:1.05;
    }
    .brandTitle h1{
      font-family: Cinzel, serif;
      font-size: 20px;
      letter-spacing: 0.02em;
      margin:0;
      color: rgba(255,255,255,0.95);
    }
    .brandTitle p{
      margin: 3px 0 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      border: 1px solid rgba(232, 210, 162, 0.20);
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(8px);
    }
    .pillBtn{ cursor:pointer; }
    .pillBtn:focus{ outline: none; box-shadow: 0 0 0 3px rgba(232,210,162,0.16); }


    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      height: 40px;
      padding: 0 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid rgba(232, 210, 162, 0.26);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.92);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.07); border-color: rgba(232,210,162,0.34); }
    .btn:active{ transform: translateY(0); }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(232,210,162,0.96), rgba(202,169,106,0.92));
      color: #1b160c;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .btnPrimary:hover{ background: linear-gradient(180deg, rgba(245,228,188,0.98), rgba(202,169,106,0.96)); }

    .main{
      position: relative;
      z-index: 2;
      height: auto;
      align-items: start;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      padding: 16px 16px 18px 16px;
    }

    .left{
      border-radius: var(--radius);
      border: 1px solid rgba(232, 210, 162, 0.14);
      background: rgba(255,255,255,0.03);
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .leftScroll{
      overflow: visible;
      padding: 14px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr;
      gap: 12px;
    }

    .card{
      border-radius: 18px;
      border: 1px solid rgba(232, 210, 162, 0.14);
      background: linear-gradient(180deg, rgba(7, 20, 15, 0.72), rgba(7, 20, 15, 0.52));
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      padding: 14px;
      position: relative;
      overflow: hidden;
    }
    .card h3{
      font-size: 13px;
      font-weight: 700;
      margin:0;
      color: rgba(255,255,255,0.92);
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      line-height:1.35;
    }
    .label{
      font-size: 11px;
      color: var(--muted2);
    }

    .stepTitle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .stepTitle .leftSide{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .stepBadge{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(232, 210, 162, 0.10);
      border: 1px solid rgba(232, 210, 162, 0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(232,210,162,0.96);
      font-size: 12px;
      font-weight: 700;
      flex: 0 0 auto;
    }

    .pkgRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .pkgBtn{
      border-radius: 16px;
      border: 1px solid rgba(232, 210, 162, 0.16);
      background: rgba(255,255,255,0.04);
      padding: 12px;
      cursor: pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      min-width: 0;
    }
    .pkgBtn:hover{ transform: translateY(-1px); border-color: rgba(232,210,162,0.28); background: rgba(255,255,255,0.06); }
    .pkgBtn.active{
      background: linear-gradient(180deg, rgba(232,210,162,0.20), rgba(255,255,255,0.04));
      border-color: rgba(232, 210, 162, 0.42);
      box-shadow: inset 0 0 0 1px rgba(232,210,162,0.10);
    }
    .pkgTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
    }
    .pkgName{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 700;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      min-width: 0;
    }
    .pkgDesc{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    input[type="range"]{
      width: 100%;
      accent-color: var(--gold);
    }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .field input, .field select, .field textarea{
      height: 42px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid rgba(232, 210, 162, 0.18);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.92);
      outline: none;
    }
    .field textarea{ height: 100px; padding: 12px; resize: none; }

    .smallRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(232,210,162,0.14);
      background: rgba(255,255,255,0.03);
    }
    .toggle .tText{ min-width:0; }
    .toggle .tTitle{ font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.90); }
    .toggle .tSub{ font-size: 11px; color: var(--muted); margin-top: 2px; line-height:1.3; }

    .numRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .stepper{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid rgba(232,210,162,0.18);
      background: rgba(0,0,0,0.14);
      border-radius: 999px;
      padding: 6px 8px;
    }
    .stepper button{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(232,210,162,0.20);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.9);
      font-weight: 800;
      transition: background .12s ease;
    }
    .stepper button:hover{ background: rgba(255,255,255,0.08); }
    .stepper input{
      width: 44px;
      text-align:center;
      border: 0;
      background: transparent;
      color: rgba(255,255,255,0.92);
      outline:none;
      font-weight: 700;
    }

    .chooseSitterBtn{
      min-height: 56px;
      padding: 10px 14px;
      border-radius: 18px;
      border: 1px solid rgba(232,210,162,0.26);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
    }
    .chooseSitterBtn:hover{ background: rgba(255,255,255,0.085); border-color: rgba(232,210,162,0.38); transform: translateY(-1px); }
    .chooseSitterBtn:active{ transform: translateY(0); }
    .chooseSitterLeft{ display:flex; align-items:center; gap: 12px; min-width: 0; }
    .avatarStack{ display:flex; align-items:center; gap: 10px; flex: 0 0 auto; }
    .avatarStack img{
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid rgba(6,16,12,0.92);
      object-fit: cover;
      background: rgba(255,255,255,0.10);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
    }
    .sitterBtnText{ min-width: 0; }
    .sitterBtnTitle{ font-size: 13px; font-weight: 900; line-height: 1.1; letter-spacing: .2px; }
    .sitterBtnSub{ font-size: 12px; opacity: 0.78; line-height: 1.15; margin-top: 3px; }
    .chooseSitterCta{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(232,210,162,0.28);
      background: rgba(0,0,0,0.16);
      color: rgba(232,210,162,0.98);
      flex: 0 0 auto;
    }
    @media (max-width: 420px){
      .chooseSitterBtn{ min-height: 52px; padding: 10px 12px; }
      .avatarStack{ gap: 8px; }
      .avatarStack img{ width: 30px; height: 30px; }
    }
    .right{
      color: rgba(255,255,255,0.88);
      border-radius: var(--radius);
      border: 1px solid rgba(232, 210, 162, 0.16);
      background: linear-gradient(180deg, rgba(7,20,15,0.72), rgba(7,20,15,0.54));
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      padding: 14px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .quoteTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .quoteTop h2{
      font-family: Cinzel, serif;
      font-size: 16px;
      margin:0;
      letter-spacing: 0.02em;
      color: rgba(255,255,255,0.92);
    }
    .bigTotal{
      font-family: Cinzel, serif;
      font-size: 44px;
      line-height: 1;
      margin-top: 6px;
      color: rgba(232,210,162,0.98);
      text-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }

    .rows{
      margin-top: 6px;
      border-top: 1px solid rgba(232,210,162,0.14);
      padding-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.82);
    }
    .row strong{ color: rgba(255,255,255,0.92); }
    .hint{
      font-size: 11px;
      color: var(--muted2);
      line-height: 1.35;
      margin-top: 10px;
    }

    .lineItems{
      margin-top: 10px;
      border: 1px solid rgba(232,210,162,0.12);
      border-radius: 16px;
      overflow: hidden;
      background: rgba(0,0,0,0.14);
      flex: 1 1 auto;
      min-height: 0;
    }
    .lineItemsHeader{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(232,210,162,0.12);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      background: rgba(255,255,255,0.03);
    }
    .lineItemsBody{
      max-height: 220px;
      overflow: auto;
      scrollbar-gutter: stable;
      padding: 10px 10px 12px 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .liRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:start;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
    }
    .liRow .liTitle{
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.90);
      margin:0;
    }
    .liRow .liMeta{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.35;
    }
    .liRow .liAmt{
      font-size: 12px;
      font-weight: 800;
      color: rgba(232,210,162,0.95);
      white-space: nowrap;
      align-self: center;
    }

    .depositBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(232,210,162,0.14);
      background: rgba(255,255,255,0.03);
    }
    .depositBox .k{ font-size: 11px; color: var(--muted2); }
    .depositBox .v{ font-size: 18px; font-weight: 800; color: rgba(255,255,255,0.92); margin-top: 2px; }

    .ctaRow{ margin-top: 12px; display:flex; flex-direction: column; gap: 10px; }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999; /* must be above everything */
      backdrop-filter: blur(10px);
    }
    .modalOverlay.active{ display:flex; }
    .modal{
      width: min(980px, 98vw);
      max-height: 90vh;
      border-radius: 24px;
      border: 1px solid rgba(232,210,162,0.18);
      background: linear-gradient(180deg, rgba(9,23,18,0.96), rgba(6,16,12,0.98));
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(232,210,162,0.14);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: rgba(255,255,255,0.03);
    }
    .modalHeader h3{
      margin:0;
      font-family: Cinzel, serif;
      font-size: 16px;
      color: rgba(255,255,255,0.92);
      letter-spacing: 0.02em;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
      max-height: calc(90vh - 58px);
    }

    .tabs{
      display:flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 2;
      padding: 8px;
      border-radius: 12px;
      background: rgba(8,20,15,0.95);
      border: 1px solid rgba(232,210,162,0.24);
    }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(232,210,162,0.42);
      background: rgba(0,0,0,0.4);
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.98);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, border-color .12s ease;
    }
    .tab.active{
      border-color: rgba(255,255,255,0.8);
      background: linear-gradient(180deg, rgba(232,210,162,0.96), rgba(202,169,106,0.92));
      color: #1d170d;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
    }

    .topbarActions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .petsGrid, .petsGrid .field{ min-width: 0; }
    .petsGrid input{ width: 100%; }
    .walkDays{ display:grid; grid-template-columns: repeat(7,minmax(0,1fr)); gap:8px; margin-top:8px; }
    .walkDayBtn{
      height: 38px; border-radius: 10px; border: 1px solid rgba(232,210,162,0.2);
      background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.86); font-size:12px; font-weight:700;
    }
    .walkDayBtn.active{ background: rgba(232,210,162,0.2); border-color: rgba(232,210,162,0.58); color: rgba(255,255,255,0.98); }

    .radioGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .radioCard{
      border-radius: 16px;
      border: 1px solid rgba(232,210,162,0.16);
      background: rgba(255,255,255,0.03);
      padding: 12px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, transform .12s ease;
      min-width: 0;
    }
    .radioCard:hover{ transform: translateY(-1px); border-color: rgba(232,210,162,0.28); background: rgba(255,255,255,0.05); }
    .radioCard.active{
      border-color: rgba(232,210,162,0.44);
      background: rgba(232,210,162,0.12);
    }
    .radioCard .t{ font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.92); }
    .radioCard .b{ font-size: 11px; color: var(--muted); margin-top: 4px; line-height:1.35; }
    .radioCard .p{ font-size: 12px; font-weight: 800; color: rgba(232,210,162,0.95); margin-top: 8px; }

    /* Sitter carousel */
    .carouselStage{
      border-radius: 20px;
      border: 1px solid rgba(232,210,162,0.14);
      background: rgba(0,0,0,0.18);
      padding: 14px;
      overflow: hidden;
    }
    .carouselViewport{
      position: relative;
      height: 430px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sCard{
      position:absolute;
      width: 270px;
      height: 400px;
      border-radius: 18px;
      border: 1px solid rgba(232,210,162,0.18);

      /* SOLID (non-transparent) luxury surface */
      background: linear-gradient(180deg, #0f1c17 0%, #0a1410 100%);

      overflow:hidden;
      box-shadow: 0 22px 70px rgba(0,0,0,0.55);

      transform: translateX(calc(var(--offset) * 240px)) scale(var(--scale));

      /* IMPORTANT: remove opacity so cards are not see-through */
      /* opacity: var(--opacity); */

      /* Dim side cards without transparency */
      filter: brightness(calc(0.70 + (var(--opacity) * 0.30)))
              saturate(calc(0.80 + (var(--opacity) * 0.20)));

      z-index: var(--z);
      transition: transform .22s ease, filter .22s ease;
      cursor:pointer;
      user-select:none;
    }
    .sCard .img{
      height: 64%;
      background: #0a1410; /* solid (no transparency) behind images */
    }

    .sCard img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .sCard .body{
      padding: 12px;
      height: 36%;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .sName{
      font-family: Cinzel, serif;
      font-size: 14px;
      letter-spacing: 0.01em;
      color: rgba(255,255,255,0.92);
    }
    .sMeta{
      font-size: 11px;
      color: rgba(255,255,255,0.68);
      line-height: 1.35;
    }
    .tags{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .tag{
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(232,210,162,0.18);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.78);
      white-space: nowrap;
    }

    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid rgba(232,210,162,0.14);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      background: rgba(255,255,255,0.03);
    }

    .statusDot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.25);
    }
    .statusDot.ok{ background: rgba(100, 255, 190, 0.60); }
    .statusDot.bad{ background: rgba(255, 120, 120, 0.70); }

    /* Responsive */
    @media (max-width: 820px){
      body{ overflow:auto; }
      .shell{ height: auto; margin: 14px auto; }
      .main{ grid-template-columns: 1fr; height: auto; }
      .left{ height: auto; }
      .leftScroll{ height: auto; }
      .right{ height: auto; }
      .lineItemsBody{ max-height: 240px; }
      .pkgRow{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
      .radioGrid{ grid-template-columns: 1fr; }
      .carouselViewport{ height: 460px; }
      .sCard{ width: 250px; transform: translateX(calc(var(--offset) * 210px)) scale(var(--scale)); }
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .btn, .pkgBtn, .radioCard, .sCard{ transition: none !important; }
    }

    /* Base stay button + modal */
    .stayBtn{
      width: 100%;
      min-height: 62px;
      padding: 12px 14px;
      border-radius: 20px;
      border: 1px solid rgba(232,210,162,0.26);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
      text-align:left;
    }
    .stayBtn:hover{ background: rgba(255,255,255,0.085); border-color: rgba(232,210,162,0.38); transform: translateY(-1px); }
    .stayBtn:active{ transform: translateY(0); }

    .stayBtnLeft{ display:flex; align-items:center; gap: 12px; min-width:0; }
    .stayIcon{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(232,210,162,0.22);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 16px 30px rgba(0,0,0,0.25);
      font-size: 16px;
      flex: 0 0 auto;
    }
    .stayBtnText{ min-width: 0; }
    .stayBtnTitle{ font-size: 13px; font-weight: 950; letter-spacing: .2px; line-height: 1.15; }
    .stayBtnSub{ font-size: 12px; opacity: 0.78; line-height: 1.2; margin-top: 3px; }
    .stayBtnRight{ display:flex; align-items:center; gap: 12px; flex: 0 0 auto; }
    .stayBtnRate{ font-size: 12px; font-weight: 900; opacity: .92; padding: 6px 10px; border-radius: 999px; border:1px solid rgba(232,210,162,0.18); background: rgba(0,0,0,0.12); }
    .stayBtnCta{ font-size: 12px; font-weight: 950; letter-spacing: .2px; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(232,210,162,0.28); background: rgba(0,0,0,0.16); color: rgba(232,210,162,0.98); }

    .modalWide{ max-width: 980px; }
    .stayGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    .stayCard{
      border-radius: 18px;
      border: 1px solid rgba(232,210,162,0.18);
      background: rgba(0,0,0,0.16);
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
      transition: border-color .12s ease, background .12s ease, transform .12s ease;
    }
    .stayCard.active{ border-color: rgba(232,210,162,0.38); background: rgba(255,255,255,0.06); }
    .stayCardTop{ display:flex; align-items:center; justify-content: space-between; gap: 10px; }
    .stayCardTitle{ font-size: 13px; font-weight: 950; letter-spacing: .2px; display:flex; align-items:center; gap: 8px; }
    .stayEmoji{ font-size: 14px; }
    .stayTag{ font-size: 11px; opacity: .85; padding: 5px 10px; border-radius: 999px; border:1px solid rgba(232,210,162,0.18); background: rgba(0,0,0,0.12); }

    .stayCardDesc{ font-size: 12px; opacity: .82; line-height: 1.35; }
    .stayFacts{ display:grid; grid-template-columns: 1fr; gap: 6px; }
    .stayFact{ display:flex; align-items:center; justify-content: space-between; gap: 10px; font-size: 12px; }
    .stayFact .k{ opacity: .72; }
    .stayFact .v{ font-weight: 850; opacity: .95; }

    .staySlider{ margin-top: 2px; padding-top: 10px; border-top: 1px solid rgba(232,210,162,0.12); }
    .staySliderTop{ display:flex; align-items:center; justify-content: space-between; gap: 10px; font-size: 12px; }
    .staySliderTop .k{ opacity: .75; }
    .staySliderTop .v{ font-weight: 900; }
    .staySliderHint{ font-size: 11px; opacity: .7; margin-top: 6px; line-height: 1.3; }
    .staySelect{ margin-top: auto; height: 40px; border-radius: 14px; }

    @media (max-width: 820px){
      .stayGrid{ grid-template-columns: 1fr; }
      .modalWide{ max-width: 720px; }
    }

/* layout: allow natural page scroll; no inner scroll traps */
    /* Step 4 action row */
    .actionRow{
      display:flex;
      gap: 12px;
      align-items: stretch;
      margin-top: 6px;
    }
    .actionRow .btnPrimary{ flex: 0 0 auto; min-width: 180px; height: 56px; border-radius: 18px; }
    .actionRow .chooseSitterBtn{ flex: 1 1 auto; }

    /* Selected sitter box */
    .selectedBox{
      border-radius: 16px;
      border: 1px solid rgba(232,210,162,0.14);
      background: rgba(0,0,0,0.16);
      padding: 12px;
    }
    .selectedTop{ display:flex; align-items:center; justify-content: space-between; gap: 12px; }
    .selectedName{ font-size: 12px; font-weight: 950; }
    .selectedMeta{ font-size: 11px; opacity: .72; margin-top: 2px; line-height: 1.25; }

    @media (max-width: 520px){
      .actionRow{ flex-direction: column; }
      .actionRow .btnPrimary{ width: 100%; min-width: 0; }
    }


    .stayHoursPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(232,210,162,0.16);
      background: rgba(0,0,0,0.12);
      font-weight: 850;
      opacity: .92;
      margin-left: 8px;
      white-space: nowrap;
    }
    .stayHoursPill.isHidden{ display:none; }

/* --- Desktop layout enforcement (prevents right panel dropping below) --- */
@media (min-width: 981px){
  .main{ display: grid !important; grid-template-columns: minmax(640px, 1fr) 420px !important; }
  .right{ position: sticky; top: 14px; align-self: start; }
  .actionRow{ display:flex !important; flex-direction: row !important; gap: 12px !important; align-items: stretch !important; }
  #btnOpenAddons{ flex: 0 0 240px; }
  .chooseSitterBtn{ flex: 1 1 auto; min-width: 0; }
}
/* Stack only on genuinely narrow viewports */
@media (max-width: 980px){
  .main{ grid-template-columns: 1fr; }
  .right{ position: relative; top: auto; width: 100%; }
  .actionRow{ flex-direction: column; }
  #btnOpenAddons{ width: 100%; }
}

/* Prevent clipped helper lines in Step 4 */
.muted{ line-height: 1.25; }
.miniSitterCard, .miniSitterCard *{ min-width: 0; }



    /* Mobile polish (keeps desktop exactly as-is) */
    @media (max-width: 680px){
      .topbar{flex-direction:column; align-items:flex-start; gap:10px;}
      .brand{width:100%; min-width:0;}
      .brandTitle h1{font-size:18px;}
      .topbarActions{width:100%; display:grid; grid-template-columns:1fr 1fr; gap:10px;}
      .topbarActions > *{width:100%;}
      #btnOpenBooking{grid-column:1 / -1; height:44px;}
      #apiPillBtn{grid-column:1 / -1; justify-content:center;}
    }
    @media (max-width: 520px){
      .shell{padding:12px;}
      .card{padding:14px;}
      .title{font-size:22px;}
      .subtitle{font-size:13px;}
      .stayBtn{flex-direction:column; align-items:stretch; gap:10px;}
      .stayBtnMain{gap:10px;}
      .stayBtnRight{width:100%; justify-content:space-between;}
      .stayHoursPill{align-self:flex-start;}
      .stayBtnRate{min-width:auto;}
      .grid2{grid-template-columns:1fr;}
      .grid3{grid-template-columns:1fr;}
      .walkDays{grid-template-columns: repeat(4,minmax(0,1fr));}
      .sitterRow{flex-direction:column; gap:10px; align-items:stretch;}
      .sitterPill{justify-content:center;}
      .sitterBrowse{width:100%;}
      .chooseSitterBtn{flex-wrap:wrap; gap:10px;}
      .chooseSitterLeft{flex:1 1 100%;}
      .chooseSitterCta{flex:1 1 100%; width:100%; justify-content:center;}
      .stayBtnTitle{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
      .btnWide{width:100%;}
    }
    @media (max-width: 420px){
      #apiPillBtn{padding:8px 10px;}
      #apiStatus{font-size:12px;}
      .pillDot{width:8px;height:8px;}
      .stayBtnIcon{width:34px;height:34px;}
      .modal{padding:14px;}
      .modalBody{padding:14px;}
    }

    .brandTitle h1,.quoteTop h2,.bigTotal{ font-family: 'Playfair Display', serif; }
    .leftScroll{ display:flex; flex-direction:column; gap:var(--space2); }
    .grid2.mt-3{ margin-top: 0; }
    .stepCard{ padding: 0; overflow: hidden; border: none; box-shadow: var(--shadowSoft); background: linear-gradient(180deg, rgba(10, 24, 18, 0.84), rgba(7, 19, 14, 0.88)); }
    .stepHeaderBtn{ width:100%; background:transparent; border:none; color:inherit; padding:16px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; text-align:left; }
    .stepHeaderBtn:focus-visible, .btn:focus-visible, .field input:focus-visible, .field select:focus-visible, .field textarea:focus-visible, .toggle:focus-within, .chip:focus-visible, .accordionBtn:focus-visible{ outline:none; box-shadow: 0 0 0 3px var(--focusRing); }
    .stepSummary{ display:none; font-size:12px; color:var(--muted); margin-top:4px; }
    .stepCard.completed .stepSummary{ display:block; }
    .stepBody{ padding: 0 18px 18px; border-top: 1px solid rgba(232,210,162,0.08); }
    .stepCard.collapsed .stepBody{ display:none; }
    .stepHeaderActions{ display:flex; align-items:center; gap:10px; }
    .changeLink{ border:none; background:none; color:var(--gold); font-size:12px; padding:0; text-decoration:underline; cursor:pointer; }
    .stepCard.active{ transform: translateY(-1px); }
    .card:hover{ transform: translateY(-2px); transition: transform .2s ease; }
    .btn{ transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease; }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btnSecondary{ background: rgba(255,255,255,0.02); border-color: rgba(232,210,162,0.16); }
    .chip{ border-radius:999px; border:1px solid rgba(232,210,162,0.24); padding:8px 12px; background:rgba(255,255,255,0.04); font-size:12px; }
    .tabs .tab{ border-radius: 999px; }
    .quoteTop{ flex-direction:column; gap:8px; }
    .bigTotal{ font-size:58px; }
    .quoteDisclaimer{ font-size:11px; color:var(--muted); }
    .lineItems{ border:none; background: rgba(0,0,0,0.1); }
    .accordionBtn{ width:100%; display:flex; align-items:center; justify-content:space-between; border:none; background:rgba(255,255,255,0.03); color:inherit; padding:10px 12px; border-radius:14px; }
    .lineItems.collapsed .lineItemsBody{ display:none; }
    .depositBox{ border:1px solid rgba(232,210,162,0.10); background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); }
    .trustStrip{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px; }
    .trustItem{ font-size:11px; color:var(--muted); padding:6px 10px; border-radius:12px; background:rgba(255,255,255,0.03); }
    .mobileStickyBar{ display:none; }
    @media (max-width: 820px){
      body{ padding-bottom: 90px; }
      .topbarActions{ grid-template-columns:1fr 1fr; }
      .mobileStickyBar{ display:flex; position:fixed; left:12px; right:12px; bottom:12px; z-index:20; border-radius:18px; padding:10px; gap:10px; align-items:center; justify-content:space-between; background:rgba(8,20,15,0.96); box-shadow:var(--shadowSoft); }
      .mobileStickyBar .btnPrimary{ height:42px; }
      .bigTotal{ font-size:50px; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
</style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="logoWrap"><img src="logo.png" alt="PetGuardian logo" /></div>
        <div class="brandTitle">
          <h1>PetGuardian Care Estimate</h1>
          <p>Transparent pricing, verified sitters, secure booking.</p>
        </div>
      </div>

      <div class="topbarActions">
        <button class="pill pillBtn" id="apiPillBtn" type="button" title="Tap to test the API URL">
          <span class="statusDot" id="apiDot"></span>
          <span id="apiStatus">API: checking</span>
        </button>

        <button class="btn" id="btnPricingInfo">How pricing works</button>
        <button class="btn" id="btnCopy">Copy Quote</button>
        <button class="btn btnPrimary" id="btnOpenBooking">Request Booking</button>
      </div>
    </div>

    <div class="main">
      <section class="left">
        <div class="leftScroll">
          <!-- Step 1 -->
          <div class="card">
            <div class="stepTitle">
              <div class="leftSide">
                <div class="stepBadge">1</div>
                <div>
                  <h3>Product options</h3>
                  <div class="sub">Choose the product option. Add-ons apply on top.</div>
                </div>
              </div>
              <div class="pill" id="peakNote"></div>
            </div>

            <button class="stayBtn" id="btnOpenStay" type="button" aria-haspopup="dialog">
              <div class="stayBtnLeft">
                <div class="stayIcon" id="stayIcon" aria-hidden="true">‚è±</div>
                <div class="stayBtnText">
                  <div class="stayBtnTitle" id="stayTitle">Day Visits</div>
                  <div class="stayBtnSub" id="staySub"><span id="staySubText">Hourly care.</span> <span class="stayHoursPill" id="stayHoursPill"><span class="muted">Hours:</span> <span id="hoursOut">4</span></span></div>
                </div>
              </div>
              <div class="stayBtnRight">
                <div class="stayBtnRate" id="stayRate">R60/hour</div>
                <div class="stayBtnCta">Change</div>
              </div>
            </button>

              <div class="smallRow mt-2">
              <div class="label" id="discountHint">Long-stay discount applies automatically</div>
              <div class="label" id="dayOnlyHint">Day Visits: travel is charged per day (separate from check-ins)</div>
            </div>
          </div>

<div class="grid2 mt-3">
            <!-- Step 2 -->
            <div class="card">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">2</div>
                  <div>
                    <h3 id="scheduleTitle">Schedule</h3>
                    <div class="sub" id="scheduleSub">Peak dates and long-stay discounts are calculated automatically.</div>
                  </div>
                </div>
                <div class="label"><span id="daysLabel">Days</span>: <span id="daysOut">1</span></div>
              </div>

              <div class="grid2" id="dateRangeFields">
                <label class="field">
                  <span class="label">Start date</span>
                  <input type="date" id="startDate">
                </label>
                <label class="field">
                  <span class="label">End date</span>
                  <input type="date" id="endDate">
                </label>
              </div>

              <div id="walkScheduleFields" style="display:none;">
                <div class="grid2">
                  <label class="field">
                    <span class="label">Start date</span>
                    <input type="date" id="walkStartDate">
                  </label>
                  <label class="field">
                    <span class="label">Billing option</span>
                    <select id="walkBillingOption">
                      <option value="once_off">Once-off</option>
                      <option value="weekly_recurring">Weekly recurring</option>
                      <option value="monthly_subscription">Monthly subscription</option>
                    </select>
                  </label>
                </div>
                <div class="grid2 mt-3">
                  <label class="field" id="walkWeeksField" style="display:none;">
                    <span class="label">Weeks</span>
                    <input type="number" id="walkWeeks" min="1" max="12" step="1" value="1">
                  </label>
                </div>
                <div class="mt-3">
                  <div class="label">Days of week</div>
                  <div class="walkDays" id="walkDays"></div>
                </div>
                <div class="grid2 mt-3">
                  <label class="field">
                    <span class="label">Walks per selected day</span>
                    <input type="number" id="walksPerDay" min="1" max="8" step="1" value="1">
                  </label>
                  <label class="field">
                    <span class="label">Time window</span>
                    <select id="walkTimeWindow">
                      <option value="morning">Morning</option>
                      <option value="midday">Midday</option>
                      <option value="afternoon">Afternoon</option>
                      <option value="evening">Evening</option>
                    </select>
                  </label>
                </div>
                <div class="card mt-3" style="padding:12px;">
                  <div class="stepTitle" style="margin-bottom:8px;">
                    <div class="leftSide"><h3>Minutes per walk</h3></div>
                    <div class="label"><span id="walkMinutesPerWalkOut">30</span> min/walk</div>
                  </div>
                  <input id="walkMinutesPerWalk" type="range" min="5" max="120" step="5" value="30">
                </div>
                <div class="hint mt-2">End date auto-calculated: <span id="walkEndDateOut">--</span>. <span id="walkTotalsSummary">Total walks: <span id="walkTotalOut">0</span>.</span></div>
              </div>

              <label class="field mt-3">
                <span class="label">Zone</span>
                <select id="zone">
                  <option value="sabie">Sabie (Zone A)</option>
                  <option value="wr">White River (Zone B)</option>
                  <option value="nel">Nelspruit (Zone C)</option>
                </select>
              </label>

              <div class="hint" id="peakAppliedOut">No peak dates detected in your booking range.</div>
            </div>

            <!-- Step 3 -->
            <div class="card">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">3</div>
                  <div>
                    <h3>Pets</h3>
                    <div class="sub">First pet included. Extra pets add a daily care fee.</div>
                  </div>
                </div>
                <div class="label"><span id="travelLabel">Travel per day</span>: R<span id="travelOut">0</span></div>
              </div>

              <div class="grid2 petsGrid">
                <div class="field">
                  <span class="label">Dogs</span>
                  <input id="dogs" type="number" min="0" step="1" value="1">
                </div>
                <div class="field" id="catsField">
                  <span class="label">Cats</span>
                  <input id="cats" type="number" min="0" step="1" value="0">
                </div>
              </div>

              <div class="field mt-3" id="walkTravelEstimateField" style="display:none;">
                <div class="stepTitle" style="margin-bottom:8px;">
                  <div class="leftSide"><h3>Travel estimate per walk</h3></div>
                  <div class="label">R<span id="walkTravelEstimateOut">25</span></div>
                </div>
                <input id="walkTravelEstimatePerWalk" type="range" min="0" max="50" step="1" value="25">
                <div class="hint mt-2">Travel estimate ranges from R0 to R50 per walk depending on location and will be confirmed afterwards.</div>
              </div>

              <div class="grid2 mt-3">
                <label class="toggle">
                  <div class="tText">
                    <div class="tTitle">Puppy care</div>
                    <div class="tSub">Extra supervision and routine.</div>
                  </div>
                  <input id="puppy" type="checkbox">
                </label>

                <label class="toggle">
                  <div class="tText">
                    <div class="tTitle">Oral meds needed?</div>
                    <div class="tSub">We administer meds per instructions.</div>
                  </div>
                  <input id="meds" type="checkbox">
                </label>
              </div>

              <div class="hint">More add-ons (walks, updates, plants, chores, transport) are in Customize add-ons.</div>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="card">
            <div class="stepTitle">
              <div class="leftSide">
                <div class="stepBadge">4</div>
                <div>
                  <h3>Extras and sitter</h3>
                  <div class="sub">Customize add-ons, then choose a verified sitter to submit your request.</div>
                </div>
              </div>
              <div class="pill" id="sittersCountPill">Sitters: --</div>
            </div>

            <div class="actionRow">
              <button class="btn btnPrimary" id="btnOpenAddons" type="button">Customize add-ons</button>

              <button class="chooseSitterBtn" id="btnOpenSitters" type="button" aria-haspopup="dialog">
                <div class="chooseSitterLeft">
                  <div class="avatarStack" aria-hidden="true">
                    <img id="facePrev0" src="face1.png" onerror="this.style.display='none'">
                    <img id="facePrev1" src="face2.png" onerror="this.style.display='none'">
                    <img id="facePrev2" src="face3.png" onerror="this.style.display='none'">
                  </div>
                  <div class="sitterBtnText">
                    <div class="sitterBtnTitle" id="sitterBtnTitle">Choose sitter</div>
                    <div class="sitterBtnSub" id="sitterBtnSub">Verified selection required</div>
                  </div>
                </div>
                <div class="chooseSitterCta">Browse</div>
              </button>
            </div>

            <div class="selectedBox mt-3">
              <div class="selectedTop">
                <div>
                  <div class="selectedName" id="selectedSitterName">No sitter selected</div>
                  <div class="selectedMeta" id="selectedSitterMeta">Choose a sitter to continue</div>
                </div>
                <button class="btn" id="btnChangeSitter" type="button" style="height:36px; padding:0 12px;">Change</button>
              </div>
              <div class="hint mt-2" id="availabilityHint">Availability loads automatically based on your dates, zone, and product option.</div>
            </div>
          </div>

<div class="card">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">5</div>
                  <div>
                    <h3>Safety and transparency</h3>
                    <div class="sub">Built for trust: clear pricing, verified staff, secure booking flow.</div>
                  </div>
                </div>
                <div class="pill">Premium standard</div>
              </div>

              <ul class="text-[12px] opacity-80 leading-relaxed list-disc pl-5">
                <li>Verified sitter selection required</li>
                <li>Peak dates and long-stay discounts auto apply</li>
                <li>Deposit secures booking, remaining balance after service</li>
                <li>Final price confirmed after screening and availability</li>
              </ul>

              <div class="hint mt-3">Pricing loads from your Google Sheet via API. If anything fails, the API status pill at the top will show it.</div>
            </div>
          </div>
      </section>

      <aside class="right">
        <div class="quoteTop">
          <div>
            <h2>Your Care Quote</h2>
            <div class="bigTotal" id="totalOut">R0</div>
            <div class="quoteDisclaimer">Final price confirmed after sitter match and address review.</div>
          </div>
          <div class="pill">Pricing loaded from sheet</div>
        </div>
        <div class="hint" id="quoteWarnings"></div>

        <div class="rows">
          <div class="row"><span id="baseRowLabel">Base stay</span><strong id="baseOut">R0.00</strong></div>
          <div class="row"><span>Add-ons + travel</span><strong id="addonsOut">R0.00</strong></div>
          <div class="row"><span id="discountRowLabel">Long-stay discount</span><strong id="discountOut">R0.00</strong></div>
          <div class="row"><span>One-time fees</span><strong id="oneTimeOut">R0.00</strong></div>
        </div>
        <div class="hint mt-2" id="monthlyEstimateNote" style="display:none;">Monthly subscription is estimated using 4.3 weeks per month. Actual calendar months vary.</div>

        <div class="lineItems collapsed" id="lineItemsWrap">
          <button class="accordionBtn" type="button" id="btnToggleBreakdown" aria-expanded="false">
            <span>View breakdown</span>
            <span class="text-[11px] opacity-70">Unit x multiplier</span>
          </button>
          <div class="lineItemsBody" id="lineItemsBody">
            <div class="text-[12px] opacity-70">No add-ons selected yet.</div>
          </div>
        </div>

        <div class="depositBox">
          <div class="row"><span class="k">Deposit required</span><span class="v" id="depositOut">R0</span></div>
          <div class="row mt-1"><span class="k">Balance after service</span><span class="v" id="balanceOut">R0</span></div>
          <div class="hint mt-2">50% deposit secures booking. Remaining 50% due after service.</div>
        </div>

        <div class="trustStrip">
          <div class="trustItem">Verified sitters</div>
          <div class="trustItem">Secure booking</div>
          <div class="trustItem">Transparent pricing</div>
        </div>

        <div class="ctaRow">
          <button class="btn btnPrimary" id="btnRequestBooking">Request Booking</button>
          <div class="smallRow">
            <button class="btn btnSecondary" id="btnPricingInfoPanel" type="button">How pricing works</button>
            <button class="btn btnSecondary" id="btnCopyPanel" type="button">Copy Quote</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="mobileStickyBar" id="mobileStickyBar">
    <div>
      <div class="label">Current total</div>
      <div class="font-semibold" id="mobileTotalOut">R0</div>
    </div>
    <button class="btn btnPrimary" id="btnMobileBooking" type="button">Request Booking</button>
  </div>

  <!-- Pricing info modal -->
  <div class="modalOverlay" id="modalPricing">
    <div class="modal">
      <div class="modalHeader">
        <h3>How pricing works</h3>
        <button class="btn" id="btnClosePricing" style="height:36px;">Close</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <h3>What you see is transparent</h3>
          <div class="sub">
            Product options + travel + selected add-ons are calculated per day (or per hour for Day Visits).
            Peak dates apply a multiplier. Long-stay discounts apply automatically in blocks.
          </div>
        </div>

        <div class="grid2 mt-3">
          <div class="card">
            <h3>Peak dates</h3>
            <div class="sub">
              Peak dates are detected automatically (seasonal rule in this calculator).
              If peak applies, the daily subtotal is multiplied.
            </div>
          </div>
          <div class="card">
            <h3>Long-stay discount</h3>
            <div class="sub">
              Discount applies per 10-day block: first 10 days full price, next 10 days 10% less,
              then 19% less after that. After two discount steps, the rate stays at 81%.
            </div>
          </div>
        </div>

        <div class="grid2 mt-3">
          <div class="card">
            <h3>Travel</h3>
            <div class="sub">
              Travel is charged per day based on your zone. Extra visits can be added as add-ons.
            </div>
          </div>
          <div class="card">
            <h3>Booking</h3>
            <div class="sub">
              A sitter must be selected to submit a booking request. The deposit secures your dates.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Product options modal -->
  <div class="modalOverlay" id="modalStay">
    <div class="modal modalWide">
      <div class="modalHeader">
        <h3>Choose product option</h3>
        <button class="btn" id="btnCloseStay" style="height:36px;">Close</button>
      </div>

      <div class="modalBody">
        <div class="stayGrid">
          <div class="stayCard active" data-pkg="day" id="stayCardDay">
            <div class="stayCardTop">
              <div class="stayCardTitle"><span class="stayEmoji" aria-hidden="true">‚è±</span> Day Visits</div>
              <div class="stayTag">Hourly</div>
            </div>
            <div class="stayCardDesc">Ideal for daytime supervision. You choose the hours needed. Travel is charged per day by zone.</div>

            <div class="stayFacts">
              <div class="stayFact"><span class="k">Rate</span><span class="v">R<span id="dayHourlyOut">60</span>/hour</span></div>
              <div class="stayFact"><span class="k">Travel</span><span class="v">Per day by zone</span></div>
            </div>

            <div class="staySlider">
              <div class="staySliderTop">
                <div class="k">Hours per day</div>
                <div class="v"><span id="hoursModalOut">4</span> hours</div>
              </div>
              <input id="hours" type="range" min="1" max="12" step="1" value="4">
              <div class="staySliderHint">Tip: Keep it realistic. We plan staff capacity from this.</div>
            </div>

            <button class="btn btnPrimary staySelect" data-select="day" type="button">Use Day Visits</button>
          </div>

          <div class="stayCard" data-pkg="night" id="stayCardNight">
            <div class="stayCardTop">
              <div class="stayCardTitle"><span class="stayEmoji" aria-hidden="true">üåô</span> Overnight</div>
              <div class="stayTag">12h</div>
            </div>
            <div class="stayCardDesc">Overnight care from 6pm to 6am. Best for pets that need presence and comfort overnight.</div>

            <div class="stayFacts">
              <div class="stayFact"><span class="k">Base</span><span class="v">R<span id="nightOut">200</span>/night</span></div>
              <div class="stayFact"><span class="k">Coverage</span><span class="v">6pm to 6am</span></div>
              <div class="stayFact"><span class="k">Travel</span><span class="v">Per day by zone</span></div>
            </div>

            <button class="btn btnPrimary staySelect" data-select="night" type="button">Use Overnight</button>
          </div>

          <div class="stayCard" data-pkg="full" id="stayCardFull">
            <div class="stayCardTop">
              <div class="stayCardTitle"><span class="stayEmoji" aria-hidden="true">üè†</span> Full-time</div>
              <div class="stayTag">24h</div>
            </div>
            <div class="stayCardDesc">24-hour presence. Premium option for high-care pets, multiple routines, or full house-sitting.</div>

            <div class="stayFacts">
              <div class="stayFact"><span class="k">Base</span><span class="v">R<span id="fullOut">320</span>/day</span></div>
              <div class="stayFact"><span class="k">Coverage</span><span class="v">24h presence</span></div>
              <div class="stayFact"><span class="k">Travel</span><span class="v">Per day by zone</span></div>
            </div>

            <button class="btn btnPrimary staySelect" data-select="full" type="button">Use Full-time</button>
          </div>

          <div class="stayCard" data-pkg="walk" id="stayCardWalk">
            <div class="stayCardTop">
              <div class="stayCardTitle"><span class="stayEmoji" aria-hidden="true">üêï</span> Dog Walks</div>
              <div class="stayTag">Scheduled</div>
            </div>
            <div class="stayCardDesc">Recurring walk schedule with selected weekdays, time window, and minutes per walk. Travel is charged per walk.</div>
            <div class="stayFacts">
              <div class="stayFact"><span class="k">Rate</span><span class="v">R1/min per walk per dog</span></div>
              <div class="stayFact"><span class="k">Travel</span><span class="v">Per walk by zone</span></div>
              <div class="stayFact"><span class="k">Discount</span><span class="v">No long-stay discounts</span></div>
            </div>
            <button class="btn btnPrimary staySelect" data-select="walk" type="button">Use Dog Walks</button>
          </div>
        </div>

        <div class="hint" style="margin-top:12px;">
          Add-ons (walks, updates, plants, transport) can be added next. Peak and long-stay pricing applies automatically.
        </div>
      </div>
    </div>
  </div>

<!-- Add-ons modal -->
  <div class="modalOverlay" id="modalAddons">
    <div class="modal">
      <div class="modalHeader">
        <h3>Customize add-ons</h3>
        <button class="btn" id="btnCloseAddons" style="height:36px;">Close</button>
      </div>
      <div class="modalBody">
        <div class="tabs" id="addonTabs">
          <div class="tab active" data-tab="care">Care</div>
          <div class="tab" data-tab="home" data-walk-hide="1">Home</div>
          <div class="tab" data-tab="transport" data-walk-hide="1">Transport</div>
          <div class="tab" data-tab="discounts" data-walk-hide="1">Discounts</div>
        </div>

        <!-- CARE TAB -->
        <div id="tab-care">
          <div class="card">
            <div class="stepTitle">
              <div class="leftSide">
                <div class="stepBadge">A</div>
                <div>
                  <h3>Update method</h3>
                  <div class="sub">Choose one update option for the whole booking.</div>
                </div>
              </div>
              <div class="label">Per day</div>
            </div>

            <div class="radioGrid" id="updatesGrid">
              <div class="radioCard active" data-upd="basic">
                <div class="t">Daily message</div>
                <div class="b">One message per day. Included.</div>
                <div class="p">R<span id="updBasicOut">0</span>/day</div>
              </div>
              <div class="radioCard" data-upd="photos">
                <div class="t">2 photos per day</div>
                <div class="b">Photo updates beyond included.</div>
                <div class="p">R<span id="updPhotosOut">10</span>/day</div>
              </div>
              <div class="radioCard" data-upd="logbook">
                <div class="t">Full logbook</div>
                <div class="b">Detailed notes for key events.</div>
                <div class="p">R<span id="updLogOut">25</span>/day</div>
              </div>
            </div>
          </div>

          <div class="grid2 mt-3">
            <div class="card" id="walkMinutesCard" data-walk-hide="1">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">B</div>
                  <div>
                    <h3>Walk time per day</h3>
                    <div class="sub">R1 per minute. Slider in 5-minute steps.</div>
                  </div>
                </div>
                <div class="label"><span id="walkMinutesOut">0</span> min/day</div>
              </div>
              <input id="walkMinutes" type="range" min="0" max="120" step="5" value="0">
              <div class="smallRow mt-2">
                <div class="label">Rate: R<span id="walkRateOut">1</span>/min</div>
                <div class="label">Cost/day: <span id="walkCostOut">R0</span></div>
              </div>
            </div>

            <div class="card" id="cardCheckins">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">C</div>
                  <div>
                    <h3>Extra check-ins per day</h3>
                    <div class="sub">Short extra visit for feed, water, toilet check, quick play.</div>
                  </div>
                </div>
                <div class="label">Qty: <span id="checkinsOut">0</span></div>
              </div>

              <div class="numRow">
                <div class="label">Check-ins/day</div>
                <div class="stepper">
                  <button type="button" data-stepper="checkins" data-dir="-1">-</button>
                  <input id="checkins" value="0" inputmode="numeric">
                  <button type="button" data-stepper="checkins" data-dir="1">+</button>
                </div>
              </div>

              <div class="smallRow mt-3">
                <div class="label">Unit: R<span id="checkinPriceOut">50</span>/day</div>
                <div class="label">Note: travel is charged per day</div>
              </div>
            </div>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">High-care medical routine</div>
                <div class="tSub">More frequent checks and monitoring.</div>
              </div>
              <input id="highcare" type="checkbox">
            </label>
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Reactive or high-risk handling</div>
                <div class="tSub">Extra risk management and protocols.</div>
              </div>
              <input id="reactive" type="checkbox">
            </label>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Play and enrichment</div>
                <div class="tSub">Focused play and enrichment session.</div>
              </div>
              <input id="play" type="checkbox">
            </label>
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Training reinforcement</div>
                <div class="tSub">Reinforce owner-approved cues.</div>
              </div>
              <input id="train" type="checkbox">
            </label>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Brush and coat care</div>
                <div class="tSub">Brushing and quick coat check.</div>
              </div>
              <input id="brush" type="checkbox">
            </label>
            <div class="card">
              <h3>Tip</h3>
              <div class="sub">These add-ons are calculated per day and will reflect in the breakdown on the right.</div>
            </div>
          </div>
        </div>

        <!-- HOME TAB -->
        <div id="tab-home" style="display:none;" data-walk-hide="1">
          <div class="grid2">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Plants and chores pack</div>
                <div class="tSub">Plants, bins, lights, mail, basic chores.</div>
              </div>
              <input id="homecare" type="checkbox">
            </label>
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Home concierge</div>
                <div class="tSub">Small errands or supply runs (excludes purchase cost).</div>
              </div>
              <input id="concierge" type="checkbox">
            </label>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Pool or water feature check</div>
                <div class="tSub">Quick visual check and top-up if instructed.</div>
              </div>
              <input id="pool" type="checkbox">
            </label>
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Pet camera setup or check</div>
                <div class="tSub">Help set up or check camera placement.</div>
              </div>
              <input id="camera" type="checkbox">
            </label>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Bath (basic)</div>
                <div class="tSub">Simple bath. Excludes grooming trim.</div>
              </div>
              <input id="bath" type="checkbox">
            </label>
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Light clean and linen refresh</div>
                <div class="tSub">Basic tidy and linen change if provided.</div>
              </div>
              <input id="clean" type="checkbox">
            </label>
          </div>
        </div>

        <!-- TRANSPORT TAB -->
        <div id="tab-transport" style="display:none;" data-walk-hide="1">
          <div class="grid2">
            <div class="card">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">T</div>
                  <div>
                    <h3>Key pickup or drop-off</h3>
                    <div class="sub">Per trip (pickup or drop-off).</div>
                  </div>
                </div>
                <div class="label">Qty: <span id="keysOut">0</span></div>
              </div>
              <div class="numRow">
                <div class="label">Trips</div>
                <div class="stepper">
                  <button type="button" data-stepper="keys" data-dir="-1">-</button>
                  <input id="keys" value="0" inputmode="numeric">
                  <button type="button" data-stepper="keys" data-dir="1">+</button>
                </div>
              </div>
              <div class="smallRow mt-3">
                <div class="label">Unit: R<span id="keyPriceOut">50</span></div>
                <div class="label">One-time</div>
              </div>
            </div>

            <div class="card">
              <div class="stepTitle">
                <div class="leftSide">
                  <div class="stepBadge">T</div>
                  <div>
                    <h3>Pet taxi</h3>
                    <div class="sub">Base fee per trip plus optional per-km.</div>
                  </div>
                </div>
                <div class="label">Trips: <span id="taxiOut">0</span></div>
              </div>

              <div class="numRow">
                <div class="label">Trips</div>
                <div class="stepper">
                  <button type="button" data-stepper="taxi" data-dir="-1">-</button>
                  <input id="taxi" value="0" inputmode="numeric">
                  <button type="button" data-stepper="taxi" data-dir="1">+</button>
                </div>
              </div>

              <div class="field mt-3">
                <span class="label">Optional distance (km)</span>
                <input id="taxiKm" type="number" min="0" step="1" value="0">
              </div>

              <div class="smallRow mt-3">
                <div class="label">Base: R<span id="taxiPriceOut">150</span>/trip</div>
                <div class="label">KM: R<span id="taxiKmPriceOut">5</span>/km</div>
              </div>
            </div>
          </div>

          <div class="grid2 mt-3">
            <label class="toggle">
              <div class="tText">
                <div class="tTitle">Meet and greet</div>
                <div class="tSub">Optional onboarding for first-time clients.</div>
              </div>
              <input id="meet" type="checkbox">
            </label>
            <div class="card">
              <h3>Note</h3>
              <div class="sub">Transport items are one-time fees, not multiplied by days.</div>
            </div>
          </div>
        </div>

        <!-- DISCOUNTS TAB -->
        <div id="tab-discounts" style="display:none;" data-walk-hide="1">
          <label class="toggle">
            <div class="tText">
              <div class="tTitle">Pantry use credit</div>
              <div class="tSub">If owner allows sitter to use food, apply daily credit.</div>
            </div>
            <input id="pantry" type="checkbox">
          </label>

          <div class="card mt-3">
            <h3>Discount note</h3>
            <div class="sub">Credits reduce the daily subtotal. Long-stay discount still applies automatically.</div>
          </div>
        </div>

        <div class="card mt-3">
          <h3>Saved</h3>
          <div class="sub">Close this panel to see updated totals and the itemized breakdown on the right.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sitters modal -->
  <div class="modalOverlay" id="modalSitters">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="pill">PetGuardian Care <span style="opacity:.6">|</span> Sitters</div>
          <h3 style="margin-top:8px;">Choose your sitter</h3>
          <div class="sub" style="margin-top:6px;">3-card carousel. Center card is focus. Click center to select.</div>
        </div>
        <button class="btn" id="btnCloseSitters" style="height:36px;">Close</button>
      </div>

      <div class="modalBody">
        <div class="carouselStage">
          <div class="carouselViewport" id="carouselViewport">
            <!-- cards injected -->
          </div>

          <div class="modalFooter">
            <button class="btn" id="btnPrev">Prev</button>
            <button class="btn btnPrimary" id="btnSelectCenter">Select Center</button>
            <button class="btn" id="btnNext">Next</button>
          </div>

          <div class="hint text-center mt-3" id="carouselHint">Loading sitters...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking modal -->
  <div class="modalOverlay" id="modalBooking">
    <div class="modal">
      <div class="modalHeader">
        <h3>Request booking</h3>
        <button class="btn" id="btnCloseBooking" style="height:36px;">Close</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <label class="field">
            <span class="label">Full name</span>
            <input id="customerName" placeholder="Your name">
          </label>
          <label class="field">
            <span class="label">Phone</span>
            <input id="customerPhone" placeholder="e.g. 081 000 0000">
          </label>
        </div>
        <div class="grid2 mt-3">
          <label class="field">
            <span class="label">Email</span>
            <input id="customerEmail" placeholder="you@email.com">
          </label>
          <label class="field">
            <span class="label">Address</span>
            <input id="customerAddress" placeholder="Street, town">
          </label>
        </div>

        <label class="field mt-3">
          <span class="label">Notes (optional)</span>
          <textarea id="customerNotes" placeholder="Anything we should know?"></textarea>
        </label>

        <div class="card mt-3">
          <div class="row"><span>Selected sitter</span><strong id="bookingSitterOut">None</strong></div>
          <div class="row mt-1"><span>Total estimate</span><strong id="bookingTotalOut">R0</strong></div>
          <div class="row mt-1"><span>Deposit required</span><strong id="bookingDepositOut">R0</strong></div>
        </div>

        <div class="ctaRow mt-3">
          <button class="btn btnPrimary" id="btnSubmitBooking">Submit booking request</button>
          <div class="hint" id="bookingResult"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    /********************
     * DEFAULT PRICES (overridden by sheet pricing)
     ********************/
    const PRICES = {
      base: { dayHourly: 60, night: 200, fullDay: 320 },
      travelPerDay: { sabie: 0, wr: 30, nel: 60 },
      peakMultiplier: 1.15,
      longStay: { blockDays: 10, factor: 0.9, capBlocks: 2 },
      controls: { includedPets: 1, maxDailyCap: 600 },
      add: {
        extraDogPerDay: 20,
        extraCatPerDay: 10,
        checkinPerDay: 50,

        updatesBasicPerDay: 0,
        updatesPhotosPerDay: 10,
        updatesLogbookPerDay: 25,

        medsPerDay: 30,
        puppyCarePerDay: 30,
        highcarePerDay: 100,
        reactivePerDay: 50,

        homecarePerDay: 30,
        conciergePerDay: 50,

        playPerDay: 10,
        trainPerDay: 25,
        brushPerDay: 15,
        poolPerDay: 30,

        walkPerMinute: 1,

        pantryCreditPerDay: 50,

        meetOneTime: 0,
        keyTripOneTime: 50,
        petTaxiTripOneTime: 150,
        petTaxiKm: 5,
        bathOneTime: 150,
        cameraOneTime: 100,
        cleanOneTime: 150
      }
    };

    /********************
     * STATE
     ********************/
    const state = {
      pkg: "day",
      walkDays: ["mon","wed","fri"],
      selectedSitter: null,
      sitters: [],
      carouselIndex: 0,
      apiOk: false,
      pricingLoaded: false
    };

    const el = (id) => document.getElementById(id);

    function money(n){
      const v = Math.round(Number(n || 0));
      const s = v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return "R" + s;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function daysBetween(start, end){
      if (!start || !end) return 1;
      const s = new Date(start);
      const e = new Date(end);
      s.setHours(0,0,0,0); e.setHours(0,0,0,0);
      const diff = Math.round((e - s) / (1000*60*60*24)) + 1;
      return Math.max(1, diff);
    }

    function isWalkMode(){ return state.pkg === "walk"; }
    function addDaysIso(startStr, daysToAdd){
      const dt = new Date(startStr);
      dt.setDate(dt.getDate() + daysToAdd);
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, "0");
      const d = String(dt.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function selectedWalkDaysCount(){ return Math.max(0, state.walkDays.length); }
    function getWalkBillingOption(){
      const raw = el("walkBillingOption")?.value || "once_off";
      return ["once_off","weekly_recurring","monthly_subscription"].includes(raw) ? raw : "once_off";
    }

    function isPeakDate(dateObj){
      // Peak rule (can be upgraded later to fully custom ranges)
      const m = dateObj.getMonth(); // 0=Jan
      const d = dateObj.getDate();
      if (m === 5 || m === 6) return true; // Jun, Jul
      if (m === 11) return true;           // Dec
      if (m === 0 && d <= 15) return true; // Jan 1-15
      return false;
    }

    function bookingHasPeak(startStr, endStr){
      if (!startStr || !endStr) return false;
      const s = new Date(startStr);
      const e = new Date(endStr);
      s.setHours(0,0,0,0); e.setHours(0,0,0,0);
      for (let dt = new Date(s); dt <= e; dt.setDate(dt.getDate()+1)){
        if (isPeakDate(dt)) return true;
      }
      return false;
    }

    function weightedDays(days){
      const block = Math.max(1, Number(PRICES.longStay.blockDays || 10));
      const factor = Number(PRICES.longStay.factor || 0.9);
      const capBlocks = Math.max(0, Number(PRICES.longStay.capBlocks ?? 2));

      let remaining = days;
      let total = 0;
      let i = 0;

      while (remaining > 0){
        const chunk = Math.min(block, remaining);
        const exp = Math.min(i, capBlocks); // cap at 2 steps: 1, 0.9, 0.81, then stays at 0.81
        const mult = Math.pow(factor, exp);
        total += chunk * mult;
        remaining -= chunk;
        i += 1;
      }
      return total;
    }

    function includedPetCount(dogs, cats){
      // Included pet is 1 total. Allocate inclusion to dogs first if any.
      const inc = Math.max(0, Number(PRICES.controls.includedPets || 1));
      if (inc <= 0) return { incDogs: 0, incCats: 0 };
      if (dogs > 0) return { incDogs: Math.min(dogs, inc), incCats: 0 };
      return { incDogs: 0, incCats: Math.min(cats, inc) };
    }

    function normalizeBaseUrl(raw){
      return String(raw || "").trim().replace(/\/+$/,"");
    }

    function expandApiBase(raw){
      const base = normalizeBaseUrl(raw);
      if(!base) return [];
      const out = [base];

      // If it's the standard Apps Script web app URL, add /u/{n}/ variants
      const m = base.match(/^https:\/\/script\.google\.com\/macros\/s\/([^\/]+)\/exec(?:\?.*)?$/i);
      if(m){
        const id = m[1];
        for(let i=0;i<=2;i++){
          out.push(`https://script.google.com/macros/u/${i}/s/${id}/exec`);
        }
        // Sometimes an account-bound cookie causes redirects; authuser=-1 can force anonymous
        out.push(`https://script.google.com/macros/s/${id}/exec?authuser=-1`);
        out.push(`https://script.google.com/macros/u/0/s/${id}/exec?authuser=-1`);
      }
      return out;
    }

    function buildApiBaseCandidates(){
      const bases = [
        ...expandApiBase(CONFIG.apiBaseUrl),
        ...expandApiBase(CONFIG.appsScriptExecUrl)
      ];

      // Dedupe while preserving order
      return bases.filter((v, i) => v && bases.indexOf(v) === i);
    }

    const API_BASE_CACHE_KEY = "pg_api_base_working_v2";
    const LEGACY_API_BASE_CACHE_KEY = "pg_api_base_working";
    const API_BASE_CACHE_MAX_AGE_MS = 1000 * 60 * 60 * 24 * 7; // 7 days

    function getApiBaseCacheSignature(){
      return buildApiBaseCandidates().map(normalizeBaseUrl).join("|");
    }

    let _apiBaseWorking = null;
    function getApiBaseWorking(){
      if(_apiBaseWorking) return _apiBaseWorking;
      try{
        const raw = localStorage.getItem(API_BASE_CACHE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          const ageMs = Date.now() - Number(parsed?.savedAt || 0);
          const cachedSignature = String(parsed?.signature || "");
          const currentSignature = getApiBaseCacheSignature();
          const cachedUrl = normalizeBaseUrl(parsed?.url || "");

          if(cachedUrl && cachedSignature === currentSignature && ageMs >= 0 && ageMs <= API_BASE_CACHE_MAX_AGE_MS){
            _apiBaseWorking = cachedUrl;
          }
        }
      }catch(e){}

      // One-time cleanup of older cache format to prevent stale API URLs from breaking normal tabs.
      try{ localStorage.removeItem(LEGACY_API_BASE_CACHE_KEY); }catch(e){}

      return _apiBaseWorking || normalizeBaseUrl(CONFIG.apiBaseUrl);
    }
    function setApiBaseWorking(url){
      const normalized = normalizeBaseUrl(url);
      _apiBaseWorking = normalized;
      try{
        localStorage.setItem(API_BASE_CACHE_KEY, JSON.stringify({
          url: normalized,
          signature: getApiBaseCacheSignature(),
          savedAt: Date.now()
        }));
      }catch(e){}
    }

    function jsonpOnce(baseUrl, params){
      return new Promise((resolve, reject) => {
        const cb = "pgCb_" + Math.random().toString(36).slice(2);
        const timeoutMs = CONFIG.apiTimeoutMs || 8000;
        const cacheBuster = Date.now().toString(36) + Math.random().toString(36).slice(2);

        const url = new URL(baseUrl);
        Object.entries(params || {}).forEach(([k,v]) => {
          if (v === undefined || v === null) return;
          url.searchParams.set(k, String(v));
        });
        url.searchParams.set("callback", cb);
        url.searchParams.set("_", cacheBuster);

        let done = false;
        const script = document.createElement("script");
        script.async = true;
        script.crossOrigin = "anonymous";
        script.referrerPolicy = "no-referrer";
        script.src = url.toString();

        const cleanup = () => {
          try { delete window[cb]; } catch (e) { window[cb] = undefined; }
          if (script && script.parentNode) script.parentNode.removeChild(script);
        };

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("Network error loading: " + url.toString()));
        };

        (document.head || document.documentElement).appendChild(script);
      });
    }

    async function jsonp(params){
      const candidates = buildApiBaseCandidates();

      // Prefer cached working base first, but ignore stale/old values that no longer exist in candidates
      let preferred = getApiBaseWorking();
      if(preferred){
        try {
          const prefNorm = normalizeBaseUrl(preferred);
          const match = candidates.some(c => normalizeBaseUrl(c) === prefNorm);
          if(!match) preferred = null;
        } catch(e){ preferred = null; }
      }
      if(preferred && !candidates.includes(preferred)) candidates.unshift(preferred);

      let lastErr = null;
      for(const base of candidates){
        try{
          const res = await jsonpOnce(base, params);
          setApiBaseWorking(base);
          return res;
        }catch(err){
          lastErr = err;
        }
      }
      throw (lastErr || new Error("API request failed"));
    }

    function setApiStatus(ok, msg){
      const dot = el("apiDot");
      const label = el("apiStatus");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      label.textContent = msg;
    }

    async function pingApi(){
      try{
        const res = await jsonp({}); // no action returns online message
        state.apiOk = !!res && res.ok !== false;
        setApiStatus(true, "API: online");
      }catch(err){
        state.apiOk = false;
        setApiStatus(false, "API: check URL");
        try{ const b = document.getElementById("apiPillBtn"); if(b) b.title = String(err && err.message ? err.message : "API request failed"); }catch(e){}
        if (CONFIG.debug) console.error(err);
      }
    }

    function applyPricingFromSheet(p){
      const num = (v, fallback) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : fallback;
      };

      // Base
      PRICES.base.dayHourly = num(p.BASE_DAY_HOURLY, PRICES.base.dayHourly);
      PRICES.base.night = num(p.BASE_NIGHT, PRICES.base.night);
      PRICES.base.fullDay = num(p.BASE_FULLDAY, PRICES.base.fullDay);

      // Travel
      PRICES.travelPerDay.sabie = num(p.TRAVEL_SABIE, PRICES.travelPerDay.sabie);
      PRICES.travelPerDay.wr = num(p.TRAVEL_WR, PRICES.travelPerDay.wr);
      PRICES.travelPerDay.nel = num(p.TRAVEL_NEL, PRICES.travelPerDay.nel);

      // Controls
      PRICES.controls.includedPets = num(p.INCLUDED_PETS, PRICES.controls.includedPets);
      PRICES.controls.maxDailyCap = num(p.MAX_DAILY_CAP, PRICES.controls.maxDailyCap);
      PRICES.peakMultiplier = num(p.PEAK_MULTIPLIER, PRICES.peakMultiplier);

      PRICES.longStay.blockDays = num(p.DISCOUNT_BLOCK_DAYS, PRICES.longStay.blockDays);
      PRICES.longStay.factor = num(p.DISCOUNT_FACTOR, PRICES.longStay.factor);

      // Add-ons and fees
      PRICES.add.extraDogPerDay = num(p.ADD_EXTRA_DOG_PER_DAY, PRICES.add.extraDogPerDay);
      PRICES.add.extraCatPerDay = num(p.ADD_EXTRA_CAT_PER_DAY, PRICES.add.extraCatPerDay);

      PRICES.add.checkinPerDay = num(p.ADD_CHECKIN, PRICES.add.checkinPerDay);

      PRICES.add.updatesBasicPerDay = num(p.ADD_UPDATES_BASIC_PER_DAY, PRICES.add.updatesBasicPerDay);
      PRICES.add.updatesPhotosPerDay = num(p.ADD_UPDATES_PHOTOS_PER_DAY, PRICES.add.updatesPhotosPerDay);
      PRICES.add.updatesLogbookPerDay = num(p.ADD_UPDATES_LOGBOOK_PER_DAY, PRICES.add.updatesLogbookPerDay);

      PRICES.add.medsPerDay = num(p.ADD_ORAL_MEDS_PER_DAY, PRICES.add.medsPerDay);
      PRICES.add.puppyCarePerDay = num(p.ADD_PUPPY_CARE_PER_DAY, PRICES.add.puppyCarePerDay);
      PRICES.add.highcarePerDay = num(p.ADD_HIGHCARE_PER_DAY, PRICES.add.highcarePerDay);
      PRICES.add.reactivePerDay = num(p.ADD_REACTIVE_PER_DAY, PRICES.add.reactivePerDay);

      PRICES.add.homecarePerDay = num(p.ADD_HOMECARE_PER_DAY, PRICES.add.homecarePerDay);
      PRICES.add.conciergePerDay = num(p.ADD_HOME_CONCIERGE_PER_DAY, PRICES.add.conciergePerDay);

      PRICES.add.playPerDay = num(p.ADD_PLAY_PER_DAY, PRICES.add.playPerDay);
      PRICES.add.trainPerDay = num(p.ADD_TRAIN_PER_DAY, PRICES.add.trainPerDay);
      PRICES.add.brushPerDay = num(p.ADD_GROOM_BRUSH_PER_DAY, PRICES.add.brushPerDay);
      PRICES.add.poolPerDay = num(p.ADD_POOL_PER_DAY, PRICES.add.poolPerDay);

      PRICES.add.walkPerMinute = num(p.ADD_WALK_PER_MINUTE, PRICES.add.walkPerMinute);

      PRICES.add.pantryCreditPerDay = num(p.PANTRY_CREDIT_PER_DAY, PRICES.add.pantryCreditPerDay);

      PRICES.add.meetOneTime = num(p.ONE_MEET_AND_GREET, PRICES.add.meetOneTime);
      PRICES.add.keyTripOneTime = num(p.ADD_KEYTRIP_ONE_TIME, PRICES.add.keyTripOneTime);
      PRICES.add.petTaxiTripOneTime = num(p.ADD_PETTAXI_ONE_TIME, PRICES.add.petTaxiTripOneTime);
      PRICES.add.petTaxiKm = num(p.ADD_PETTAXI_PER_KM, PRICES.add.petTaxiKm);

      PRICES.add.bathOneTime = num(p.ADD_BATH_ONE_TIME, PRICES.add.bathOneTime);
      PRICES.add.cameraOneTime = num(p.ADD_CAMERA_ONE_TIME, PRICES.add.cameraOneTime);
      PRICES.add.cleanOneTime = num(p.ADD_CLEAN_ONE_TIME, PRICES.add.cleanOneTime);
    }

    async function fetchPricing(){
      try{
        const res = await jsonp({ action: "pricing" });
        if (res && res.ok && res.pricing){
          applyPricingFromSheet(res.pricing);
          state.pricingLoaded = true;
          renderPriceHints();
          recalc();
        }
      }catch(err){
        if (CONFIG.debug) console.error(err);
        state.pricingLoaded = false;
      }
    }

    async function fetchAvailability(){
      const start = el("startDate").value;
      const end = el("endDate").value;
      const zone = el("zone").value;
      const pkg = state.pkg;
      const availabilityPkg = (pkg === "walk") ? "day" : pkg;

      el("availabilityHint").textContent = "Checking sitter availability...";
      el("carouselHint").textContent = "Checking sitter availability...";

      try{
        const res = await jsonp({ action:"availability", start, end, zone, pkg: availabilityPkg });
        const staff = (res && res.ok && Array.isArray(res.staff)) ? res.staff : [];
        state.sitters = staff;
        state.carouselIndex = 0;

        if (!staff.length){
          el("sittersCountPill").textContent = "Sitters: 0";
          el("availabilityHint").textContent = "No sitters available for this range. Adjust dates, zone, or product option.";
          el("carouselHint").textContent = "No sitters available for this range.";
        } else {
          el("sittersCountPill").textContent = "Sitters: " + staff.length;
          el("availabilityHint").textContent = staff.length + " sitters available. Choose a sitter to continue.";
          el("carouselHint").textContent = "Use Prev/Next. Click the center card to select.";
        }

        // If current sitter not in list, clear selection
        if (state.selectedSitter && !staff.some(s => String(s.id) === String(state.selectedSitter.id))){
          state.selectedSitter = null;
          renderSelectedSitter();
        }

        renderCarousel();
      }catch(err){
        el("availabilityHint").textContent = "Availability could not load. Check API status at the top.";
        el("carouselHint").textContent = "Availability could not load. Check API status.";
        if (CONFIG.debug) console.error(err);
      }
    }

    function renderPriceHints(){
      el("dayHourlyOut").textContent = Math.round(PRICES.base.dayHourly);
      el("nightOut").textContent = Math.round(PRICES.base.night);
      el("fullOut").textContent = Math.round(PRICES.base.fullDay);

      el("travelOut").textContent = Math.round(PRICES.travelPerDay[el("zone").value] || 0);

      el("updBasicOut").textContent = Math.round(PRICES.add.updatesBasicPerDay);
      el("updPhotosOut").textContent = Math.round(PRICES.add.updatesPhotosPerDay);
      el("updLogOut").textContent = Math.round(PRICES.add.updatesLogbookPerDay);

      el("walkRateOut").textContent = Math.round(PRICES.add.walkPerMinute);
      el("checkinPriceOut").textContent = Math.round(PRICES.add.checkinPerDay);

      el("keyPriceOut").textContent = Math.round(PRICES.add.keyTripOneTime);
      el("taxiPriceOut").textContent = Math.round(PRICES.add.petTaxiTripOneTime);
      el("taxiKmPriceOut").textContent = Math.round(PRICES.add.petTaxiKm);
       syncConditionalAddOns();
      renderStaySummary();
   }

    function renderWalkDays(){
      const holder = el("walkDays");
      if (!holder) return;
      const days = [
        ["mon","Mon"],["tue","Tue"],["wed","Wed"],["thu","Thu"],["fri","Fri"],["sat","Sat"],["sun","Sun"]
      ];
      holder.innerHTML = "";
      days.forEach(([value, label]) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "walkDayBtn" + (state.walkDays.includes(value) ? " active" : "");
        btn.textContent = label;
        btn.addEventListener("click", () => {
          if (state.walkDays.includes(value)) {
            state.walkDays = state.walkDays.filter(d => d !== value);
          } else {
            state.walkDays = [...state.walkDays, value];
          }
          renderWalkDays();
          recalc();
        });
        holder.appendChild(btn);
      });
    }

    function renderStaySummary(){
      const pkg = state.pkg;
      const hours = clamp(parseInt(el("hours")?.value || "4", 10), 1, 12);

      // Mirror hours in the stay modal label + main pill
      if (el("hoursModalOut")) el("hoursModalOut").textContent = String(hours);
      if (el("hoursOut")) el("hoursOut").textContent = String(hours);

      const iconEl = el("stayIcon");
      const titleEl = el("stayTitle");
      const subTextEl = el("staySubText");
      const hoursPill = el("stayHoursPill");
      const rateEl = el("stayRate");

      if (pkg === "day"){
        if (iconEl) iconEl.textContent = "‚è±";
        if (titleEl) titleEl.textContent = "Day Visits";
        if (subTextEl) subTextEl.textContent = "Hourly care.";
        if (hoursPill) hoursPill.classList.remove("isHidden");
        if (rateEl) rateEl.textContent = `R${Math.round(PRICES.base.dayHourly)}/hour`;
        if (el("dayOnlyHint")) el("dayOnlyHint").textContent = "Day Visits: travel is charged per day (separate from check-ins)";
      } else if (pkg === "night"){
        if (iconEl) iconEl.textContent = "üåô";
        if (titleEl) titleEl.textContent = "Overnight";
        if (subTextEl) subTextEl.textContent = "6pm to 6am (12 hours).";
        if (hoursPill) hoursPill.classList.add("isHidden");
        if (rateEl) rateEl.textContent = `R${Math.round(PRICES.base.night)}/night`;
        if (el("dayOnlyHint")) el("dayOnlyHint").textContent = "Travel is charged per day by zone.";
      } else if (pkg === "full") {
        if (iconEl) iconEl.textContent = "üè†";
        if (titleEl) titleEl.textContent = "Full-time";
        if (subTextEl) subTextEl.textContent = "24h presence.";
        if (hoursPill) hoursPill.classList.add("isHidden");
        if (rateEl) rateEl.textContent = `R${Math.round(PRICES.base.fullDay)}/day`;
        if (el("dayOnlyHint")) el("dayOnlyHint").textContent = "Travel is charged per day by zone.";
      } else {
        if (iconEl) iconEl.textContent = "üêï";
        if (titleEl) titleEl.textContent = "Dog Walks";
        if (subTextEl) subTextEl.textContent = "Scheduled walks by week/day/time.";
        if (hoursPill) hoursPill.classList.add("isHidden");
        if (rateEl) rateEl.textContent = "R1/min/walk/dog";
        if (el("dayOnlyHint")) el("dayOnlyHint").textContent = "Travel estimate ranges from R0 to R50 per walk and is confirmed afterwards.";
      }
    }




    // UI behavior: guided step accordion with editable summaries.
    function setupStepAccordion(){
      const cards = Array.from(document.querySelectorAll('.leftScroll > .card')).slice(0,5);
      cards.forEach((card, idx) => {
        if (card.querySelector('.stepHeaderBtn')) return;
        card.classList.add('stepCard');
        card.dataset.step = String(idx + 1);
        const title = card.querySelector('h3') ? card.querySelector('h3').textContent.trim() : `Step ${idx+1}`;
        const titleRow = card.querySelector('.stepTitle');
        if (!titleRow) return;
        titleRow.style.display = 'none';
        const body = document.createElement('div');
        body.className = 'stepBody';
        while (card.children.length) {
          const node = card.children[0];
          if (node === titleRow) { card.removeChild(node); continue; }
          body.appendChild(node);
        }
        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'stepHeaderBtn';
        header.setAttribute('aria-expanded', idx === 0 ? 'true' : 'false');
        header.innerHTML = `<div><div class="stepBadge">${idx+1}</div></div><div style="flex:1"><div style="font-weight:700; font-size:14px">${escapeHtml(title)}</div><div class="stepSummary" id="stepSummary${idx+1}"></div></div><div class="stepHeaderActions"><span class="label">Step ${idx+1}</span><span class="changeLink">Change</span></div>`;
        header.addEventListener('click', () => setActiveStep(idx+1));
        card.appendChild(header);
        card.appendChild(body);
      });
      setActiveStep(1);
    }

    function setActiveStep(step){
      document.querySelectorAll('.stepCard').forEach(card => {
        const active = Number(card.dataset.step) === step;
        card.classList.toggle('active', active);
        card.classList.toggle('collapsed', !active && card.classList.contains('completed'));
        const btn = card.querySelector('.stepHeaderBtn');
        if (btn) btn.setAttribute('aria-expanded', active ? 'true' : 'false');
      });
    }

    function updateStepSummaries(){
      const pkg = el('stayTitle')?.textContent || 'Not selected';
      const days = el('daysOut')?.textContent || '1';
      const dogs = el('dogs')?.value || '0';
      const cats = el('cats')?.value || '0';
      const sitter = state.selectedSitter ? state.selectedSitter.name : 'No sitter selected';
      const data = [
        pkg,
        `${days} ${el('daysLabel')?.textContent || 'Days'}`,
        `${dogs} dog(s), ${cats} cat(s)`,
        sitter,
        'Verified booking standards'
      ];
      document.querySelectorAll('.stepCard').forEach((card, idx) => {
        const s = card.querySelector('.stepSummary');
        if (s) s.textContent = data[idx] || '';
        if (data[idx] && idx > 0) card.classList.add('completed');
      });
    }

    // UI behavior: quote breakdown accordion + mobile sticky CTA sync.
    function setupQuoteUI(){
      const t = el('btnToggleBreakdown');
      if (t){
        t.addEventListener('click', () => {
          const wrap = el('lineItemsWrap');
          wrap.classList.toggle('collapsed');
          t.setAttribute('aria-expanded', wrap.classList.contains('collapsed') ? 'false' : 'true');
        });
      }
    }

    function syncMobileBar(totalText){
      if (el('mobileTotalOut')) el('mobileTotalOut').textContent = totalText;
    }

    function currentUpdateTier(){
      const active = document.querySelector(".radioCard.active[data-upd]");
      return active ? active.getAttribute("data-upd") : "basic";
    }

    function setUpdateTier(tier){
      document.querySelectorAll(".radioCard[data-upd]").forEach(c => {
        c.classList.toggle("active", c.getAttribute("data-upd") === tier);
      });
      recalc();
    }

    function getUpdatePerDay(){
      const tier = currentUpdateTier();
      if (tier === "photos") return PRICES.add.updatesPhotosPerDay;
      if (tier === "logbook") return PRICES.add.updatesLogbookPerDay;
      return PRICES.add.updatesBasicPerDay;
    }

    function getNumber(id){
      const v = Number(el(id).value);
      return Number.isFinite(v) ? v : 0;
    }

    function recalc(){
      const walkMode = isWalkMode();
      const zone = el("zone").value;
      const travel = Number(PRICES.travelPerDay[zone] || 0);
      const billingOption = getWalkBillingOption();
      syncWalkBillingUI();

      // schedule values
      let start = el("startDate").value;
      let end = el("endDate").value;
      let days = daysBetween(start, end);
      let peakApplied = bookingHasPeak(start, end);
      let peakMult = peakApplied ? Number(PRICES.peakMultiplier || 1) : 1;

      const walkWeeksInput = clamp(parseInt(el("walkWeeks")?.value || "1", 10), 1, 12);
      const walkWeeks = (billingOption === "weekly_recurring") ? walkWeeksInput : 1;
      const walksPerDay = clamp(parseInt(el("walksPerDay")?.value || "1", 10), 1, 8);
      const walkMinutesPerWalk = clamp(parseInt(el("walkMinutesPerWalk")?.value || "30", 10), 5, 120);
      const walkTravelEstimatePerWalk = clamp(parseInt(el("walkTravelEstimatePerWalk")?.value || "25", 10), 0, 50);
      const selectedDays = selectedWalkDaysCount();
      const weeklyWalks = selectedDays * walksPerDay;
      const totalWalks = walkWeeks * weeklyWalks;
      const billedWalks = (billingOption === "monthly_subscription") ? (weeklyWalks * 4.3) : totalWalks;

      if (walkMode){
        start = el("walkStartDate").value || el("startDate").value;
        const autoEnd = addDaysIso(start, (walkWeeks * 7) - 1);
        end = autoEnd;
        el("startDate").value = start;
        el("endDate").value = end;
        days = Math.max(1, walkWeeks * 7);
        peakApplied = false;
        peakMult = 1;
        if (el("cats")) el("cats").value = "0";
        if (el("walkEndDateOut")) el("walkEndDateOut").textContent = end;
        if (el("walkTotalOut")) el("walkTotalOut").textContent = (billingOption === "monthly_subscription") ? billedWalks.toFixed(1) : String(totalWalks);
        if (el("walkTotalsSummary")) {
          el("walkTotalsSummary").textContent = (billingOption === "monthly_subscription")
            ? `Weekly walks: ${weeklyWalks}. Billed walks (4.3 weeks): ${billedWalks.toFixed(1)}.`
            : `Total walks: ${totalWalks}.`;
        }
        if (el("walkMinutesPerWalkOut")) el("walkMinutesPerWalkOut").textContent = String(walkMinutesPerWalk);
        if (el("walkTravelEstimateOut")) el("walkTravelEstimateOut").textContent = String(walkTravelEstimatePerWalk);
        if (el("walkWeeks")) el("walkWeeks").value = String(walkWeeks);
      }

      el("daysOut").textContent = String(walkMode ? ((billingOption === "monthly_subscription") ? billedWalks.toFixed(1) : totalWalks) : days);
      el("travelOut").textContent = String(Math.round(walkMode ? walkTravelEstimatePerWalk : travel));
      el("peakNote").textContent = walkMode ? "Walk schedule" : (peakApplied ? "Peak pricing" : "Standard dates");
      el("peakAppliedOut").textContent = walkMode
        ? "Walk mode: end date is auto-calculated from your billing option and schedule. Long-stay discounts are disabled."
        : (peakApplied ? "Peak dates detected in your booking range (June to July, or Dec to 15 Jan)." : "No peak dates detected in your booking range.");

      const dogs = Math.max(0, parseInt(el("dogs").value || "0", 10));
      const cats = walkMode ? 0 : Math.max(0, parseInt(el("cats").value || "0", 10));
      const { incDogs, incCats } = includedPetCount(dogs, cats);
      const extraDogs = Math.max(0, dogs - incDogs);
      const extraCats = Math.max(0, cats - incCats);
      const hours = clamp(parseInt(el("hours").value || "1", 10), 1, 12);
      el("hoursOut").textContent = String(hours);

      const puppy = !!el("puppy").checked;
      const meds = !!el("meds").checked;
      const walkMinRaw = clamp(parseInt(el("walkMinutes").value || "0", 10), 0, 600);
      const walkMin = walkMode ? 0 : walkMinRaw;
      el("walkMinutesOut").textContent = String(walkMin);
      const walkCostPerDay = walkMin * Number(PRICES.add.walkPerMinute || 0);
      el("walkCostOut").textContent = money(walkCostPerDay);
      const checkins = clamp(parseInt(el("checkins").value || "0", 10), 0, 20);
      el("checkinsOut").textContent = String(checkins);

      const highcare = !!el("highcare").checked;
      const reactive = !!el("reactive").checked;
      const play = !!el("play").checked;
      const train = !!el("train").checked;
      const brush = !!el("brush").checked;
      const homecare = !!el("homecare").checked;
      const concierge = !!el("concierge").checked;
      const pool = !!el("pool").checked;
      const camera = !!el("camera").checked;
      const bath = !!el("bath").checked;
      const clean = !!el("clean").checked;
      const pantry = !!el("pantry").checked;
      const keys = clamp(parseInt(el("keys").value || "0", 10), 0, 20);
      el("keysOut").textContent = String(keys);
      const taxi = clamp(parseInt(el("taxi").value || "0", 10), 0, 20);
      el("taxiOut").textContent = String(taxi);
      const taxiKm = Math.max(0, parseInt(el("taxiKm").value || "0", 10));
      const meet = !!el("meet").checked;

      let total = 0, deposit = 0, balance = 0, discountAmt = 0, baseTotal = 0, addonsTotal = 0, oneTime = 0;

      if (walkMode){
        const perWalkBase = dogs * walkMinutesPerWalk * 1;
        baseTotal = perWalkBase * billedWalks;
        addonsTotal = walkTravelEstimatePerWalk * billedWalks;
        oneTime = 0;
        total = baseTotal + addonsTotal;
      } else {
        let basePerDay = 0;
        if (state.pkg === "day") basePerDay = hours * Number(PRICES.base.dayHourly || 0);
        if (state.pkg === "night") basePerDay = Number(PRICES.base.night || 0);
        if (state.pkg === "full") basePerDay = Number(PRICES.base.fullDay || 0);

        const updatePerDay = getUpdatePerDay();
        const perDayAddOns =
          (updatePerDay) + (checkins * Number(PRICES.add.checkinPerDay || 0)) + walkCostPerDay +
          (meds ? Number(PRICES.add.medsPerDay || 0) : 0) + (puppy ? Number(PRICES.add.puppyCarePerDay || 0) : 0) +
          (highcare ? Number(PRICES.add.highcarePerDay || 0) : 0) + (reactive ? Number(PRICES.add.reactivePerDay || 0) : 0) +
          (play ? Number(PRICES.add.playPerDay || 0) : 0) + (train ? Number(PRICES.add.trainPerDay || 0) : 0) +
          (brush ? Number(PRICES.add.brushPerDay || 0) : 0) + (homecare ? Number(PRICES.add.homecarePerDay || 0) : 0) +
          (concierge ? Number(PRICES.add.conciergePerDay || 0) : 0) + (pool ? Number(PRICES.add.poolPerDay || 0) : 0) +
          (pantry ? -Number(PRICES.add.pantryCreditPerDay || 0) : 0) +
          (extraDogs * Number(PRICES.add.extraDogPerDay || 0)) + (extraCats * Number(PRICES.add.extraCatPerDay || 0));

        const perDaySubtotalPrePeak = basePerDay + travel + perDayAddOns;
        const perDayAfterPeak = perDaySubtotalPrePeak * peakMult;
        const cap = Number(PRICES.controls.maxDailyCap || 0);
        const cappedPerDay = (cap > 0) ? Math.min(cap, perDayAfterPeak) : perDayAfterPeak;
        const wDays = weightedDays(days);
        const stayTotal = cappedPerDay * wDays;

        oneTime = (meet ? Number(PRICES.add.meetOneTime || 0) : 0) + (keys * Number(PRICES.add.keyTripOneTime || 0)) +
          (taxi * Number(PRICES.add.petTaxiTripOneTime || 0)) + (taxiKm * Number(PRICES.add.petTaxiKm || 0)) +
          (bath ? Number(PRICES.add.bathOneTime || 0) : 0) + (camera ? Number(PRICES.add.cameraOneTime || 0) : 0) +
          (clean ? Number(PRICES.add.cleanOneTime || 0) : 0);

        total = stayTotal + oneTime;
        const noDiscountTotal = cappedPerDay * days + oneTime;
        discountAmt = Math.max(0, noDiscountTotal - total);
        baseTotal = (basePerDay * peakMult) * wDays;
        addonsTotal = ((perDayAddOns + travel) * peakMult) * wDays;
      }

      deposit = total * Number(CONFIG.depositPercent || 0.5);
      balance = total - deposit;
      const totalText = money(total);
      el("totalOut").textContent = totalText;
      el("depositOut").textContent = money(deposit);
      el("balanceOut").textContent = money(balance);
      el("baseOut").textContent = money(baseTotal);
      el("addonsOut").textContent = money(addonsTotal);
      el("discountOut").textContent = discountAmt > 0 ? ("-" + money(discountAmt)) : money(0);
      el("oneTimeOut").textContent = money(oneTime);
      if (el("monthlyEstimateNote")) {
        el("monthlyEstimateNote").style.display = (walkMode && billingOption === "monthly_subscription") ? "" : "none";
      }
      el("bookingTotalOut").textContent = money(total);
      el("bookingDepositOut").textContent = money(deposit);
      el("bookingSitterOut").textContent = state.selectedSitter ? state.selectedSitter.name : "None";

      const warns = [];
      if (!state.selectedSitter) warns.push("Select a sitter to submit booking.");
      el("quoteWarnings").textContent = warns.join(" ");

      updateStepSummaries();
      syncMobileBar(totalText);

      renderLineItems({
        walkMode, days, peakMult, discountAmt, travel, extraDogs, extraCats,
        updateTier: currentUpdateTier(), updatePerDay: getUpdatePerDay(), checkins, walkMin,
        meds, puppy, highcare, reactive, play, train, brush, homecare, concierge, pool, pantry,
        keys, taxi, taxiKm, meet, bath, camera, clean,
        walkWeeks, walksPerDay, walkMinutesPerWalk, totalWalks, dogs,
        billingOption, weeklyWalks, billedWalks, walkTravelEstimatePerWalk
      });
    }


    function renderLineItems(ctx){
      const body = el("lineItemsBody");
      body.innerHTML = "";

      if (ctx.walkMode){
        const walkCountLabel = (ctx.billingOption === "monthly_subscription")
          ? `Billed walks (4.3 weeks): ${ctx.billedWalks.toFixed(1)}`
          : `${ctx.totalWalks} walk(s)`;
        const lines = [
          {
            title: "Dog walks base",
            meta: `${ctx.dogs} dog(s) x ${ctx.walkMinutesPerWalk} min x ${walkCountLabel}`,
            total: ctx.dogs * ctx.walkMinutesPerWalk * ctx.billedWalks
          },
          {
            title: "Estimated travel (R0‚ÄìR50 per walk)",
            meta: `R${ctx.walkTravelEstimatePerWalk} per walk x ${walkCountLabel}`,
            total: ctx.walkTravelEstimatePerWalk * ctx.billedWalks
          }
        ];
        lines.forEach(li => {
          const wrap = document.createElement("div");
          wrap.className = "liRow";
          wrap.innerHTML = `<div><div class="liTitle">${escapeHtml(li.title)}</div><div class="liMeta">${escapeHtml(li.meta)}</div></div><div class="liAmt">${money(li.total)}</div>`;
          body.appendChild(wrap);
        });
        return;
      }

      const peakMult = ctx.peakMult || 1;
      const days = ctx.days || 1;

      const lines = [];

      // Per-day items
      const addLinePerDay = (title, unit, meta, total) => {
        if (!total || Math.abs(total) < 0.0001) return;
        lines.push({ title, meta, total });
      };

      const addLineOneTime = (title, meta, total) => {
        if (!total || Math.abs(total) < 0.0001) return;
        lines.push({ title, meta, total });
      };

      // Travel
      addLinePerDay(
        "Travel fee (zone)",
        ctx.travel,
        money(ctx.travel) + " x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
        (ctx.travel * days * peakMult)
      );

      // Extra pets
      if (ctx.extraDogs > 0){
        addLinePerDay(
          "Additional dogs",
          PRICES.add.extraDogPerDay,
          "R" + Math.round(PRICES.add.extraDogPerDay) + "/day x " + ctx.extraDogs + " dog(s) x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (ctx.extraDogs * PRICES.add.extraDogPerDay * days * peakMult)
        );
      }
      if (ctx.extraCats > 0){
        addLinePerDay(
          "Additional cats",
          PRICES.add.extraCatPerDay,
          "R" + Math.round(PRICES.add.extraCatPerDay) + "/day x " + ctx.extraCats + " cat(s) x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (ctx.extraCats * PRICES.add.extraCatPerDay * days * peakMult)
        );
      }

      // Updates
      const updLabel = ctx.updateTier === "photos" ? "Updates: 2 photos per day" : (ctx.updateTier === "logbook" ? "Updates: full logbook" : "Updates: daily message");
      addLinePerDay(
        updLabel,
        ctx.updatePerDay,
        money(ctx.updatePerDay) + "/day x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
        (ctx.updatePerDay * days * peakMult)
      );

      // Check-ins
      if (ctx.checkins > 0){
        const unit = Number(PRICES.add.checkinPerDay || 0);
        addLinePerDay(
          "Extra check-ins",
          unit,
          "R" + Math.round(unit) + "/day x " + ctx.checkins + " per day x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (unit * ctx.checkins * days * peakMult)
        );
      }

      // Walks
      if (ctx.walkMin > 0){
        const unit = Number(PRICES.add.walkPerMinute || 0);
        addLinePerDay(
          "Walk time",
          unit,
          "R" + Math.round(unit) + "/min x " + ctx.walkMin + " min/day x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (unit * ctx.walkMin * days * peakMult)
        );
      }

      // Toggles per day
      const togglePerDay = [
        ["Oral meds", ctx.meds, PRICES.add.medsPerDay],
        ["Puppy care", ctx.puppy, PRICES.add.puppyCarePerDay],
        ["High-care routine", ctx.highcare, PRICES.add.highcarePerDay],
        ["Reactive handling", ctx.reactive, PRICES.add.reactivePerDay],
        ["Play and enrichment", ctx.play, PRICES.add.playPerDay],
        ["Training reinforcement", ctx.train, PRICES.add.trainPerDay],
        ["Brush and coat care", ctx.brush, PRICES.add.brushPerDay],
        ["Plants and chores pack", ctx.homecare, PRICES.add.homecarePerDay],
        ["Home concierge", ctx.concierge, PRICES.add.conciergePerDay],
        ["Pool check", ctx.pool, PRICES.add.poolPerDay],
      ];
      togglePerDay.forEach(([label, on, price]) => {
        if (!on) return;
        const unit = Number(price || 0);
        addLinePerDay(
          label,
          unit,
          money(unit) + "/day x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (unit * days * peakMult)
        );
      });

      // Pantry credit (negative)
      if (ctx.pantry){
        const unit = Number(PRICES.add.pantryCreditPerDay || 0);
        addLinePerDay(
          "Pantry use credit",
          -unit,
          "-" + money(unit) + "/day x " + days + " day(s)" + (peakMult !== 1 ? " x peak" : ""),
          (-unit * days * peakMult)
        );
      }

      // One-time items
      if (ctx.meet){
        addLineOneTime(
          "Meet and greet",
          money(Number(PRICES.add.meetOneTime || 0)) + " one-time",
          Number(PRICES.add.meetOneTime || 0)
        );
      }
      if (ctx.keys > 0){
        const unit = Number(PRICES.add.keyTripOneTime || 0);
        addLineOneTime(
          "Key pickup/drop-off",
          money(unit) + " x " + ctx.keys + " trip(s)",
          unit * ctx.keys
        );
      }
      if (ctx.taxi > 0){
        const unit = Number(PRICES.add.petTaxiTripOneTime || 0);
        addLineOneTime(
          "Pet taxi (base)",
          money(unit) + " x " + ctx.taxi + " trip(s)",
          unit * ctx.taxi
        );
      }
      if (ctx.taxiKm > 0){
        const unit = Number(PRICES.add.petTaxiKm || 0);
        addLineOneTime(
          "Pet taxi (distance)",
          "R" + Math.round(unit) + "/km x " + ctx.taxiKm + " km",
          unit * ctx.taxiKm
        );
      }
      if (ctx.bath){
        addLineOneTime(
          "Bath (basic)",
          money(Number(PRICES.add.bathOneTime || 0)) + " one-time",
          Number(PRICES.add.bathOneTime || 0)
        );
      }
      if (ctx.camera){
        addLineOneTime(
          "Pet camera setup/check",
          money(Number(PRICES.add.cameraOneTime || 0)) + " one-time",
          Number(PRICES.add.cameraOneTime || 0)
        );
      }
      if (ctx.clean){
        addLineOneTime(
          "Light clean and linen",
          money(Number(PRICES.add.cleanOneTime || 0)) + " one-time",
          Number(PRICES.add.cleanOneTime || 0)
        );
      }

      // Long stay discount line is already shown above, but user asked breakdown - so include here too
      if (ctx.discountAmt > 0){
        addLineOneTime(
          "Long-stay discount",
          "Auto applied by day blocks",
          -ctx.discountAmt
        );
      }

      if (!lines.length){
        body.innerHTML = '<div class="text-[12px] opacity-70">No add-ons selected yet.</div>';
        return;
      }

      lines.forEach(li => {
        const wrap = document.createElement("div");
        wrap.className = "liRow";
        const left = document.createElement("div");
        left.innerHTML = '<div class="liTitle"></div><div class="liMeta"></div>';
        left.querySelector(".liTitle").textContent = li.title;
        left.querySelector(".liMeta").textContent = li.meta;

        const amt = document.createElement("div");
        amt.className = "liAmt";
        const n = Number(li.total || 0);
        amt.textContent = (n < 0) ? ("-" + money(Math.abs(n))) : money(n);

        wrap.appendChild(left);
        wrap.appendChild(amt);
        body.appendChild(wrap);
      });
    }

    function openModal(id){ el(id).classList.add("active"); }
    function closeModal(id){ el(id).classList.remove("active"); }

    function resetWalkMinutesAddon(){
      const walkSlider = el("walkMinutes");
      if (walkSlider) walkSlider.value = "0";
      if (el("walkMinutesOut")) el("walkMinutesOut").textContent = "0";
      if (el("walkCostOut")) el("walkCostOut").textContent = money(0);
    }

    function syncModeUI(){
      const walkMode = isWalkMode();
      if (el("dateRangeFields")) el("dateRangeFields").style.display = walkMode ? "none" : "";
      if (el("walkScheduleFields")) el("walkScheduleFields").style.display = walkMode ? "" : "none";
      syncWalkBillingUI();
      if (el("catsField")) el("catsField").style.display = walkMode ? "none" : "";
      if (el("travelLabel")) el("travelLabel").textContent = walkMode ? "Travel estimate per walk" : "Travel per day";
      if (el("daysLabel")) el("daysLabel").textContent = walkMode ? "Walks" : "Days";
      if (el("baseRowLabel")) el("baseRowLabel").textContent = walkMode ? "Walks base" : "Base stay";
      if (el("discountRowLabel")) el("discountRowLabel").textContent = walkMode ? "Discount" : "Long-stay discount";
      if (el("discountHint")) el("discountHint").textContent = walkMode ? "Discounts are disabled for Dog Walks" : "Long-stay discount applies automatically";
      document.querySelectorAll("[data-walk-hide='1']").forEach(node => {
        node.style.display = walkMode ? "none" : "";
      });
      if (walkMode && (el("tab-home")?.style.display !== "none" || el("tab-transport")?.style.display !== "none" || el("tab-discounts")?.style.display !== "none")){
        setTab("care");
      }
    }

    function syncWalkBillingUI(){
      const walkMode = isWalkMode();
      const billingOption = getWalkBillingOption();
      if (el("walkWeeksField")) el("walkWeeksField").style.display = (walkMode && billingOption === "weekly_recurring") ? "" : "none";
      if (el("walkTravelEstimateField")) el("walkTravelEstimateField").style.display = walkMode ? "" : "none";
      if (billingOption !== "weekly_recurring" && el("walkWeeks")) el("walkWeeks").value = "1";
    }

    function syncConditionalAddOns(){
      const show = (state.pkg === "day" || state.pkg === "night");
      const card = el("cardCheckins");
      if (card) card.style.display = show ? "" : "none";

      if (!show){
        const inp = el("checkins");
        if (inp) inp.value = "0";
        if (el("checkinsOut")) el("checkinsOut").textContent = "0";
      }
    }

    function setPkg(pkg){
      state.pkg = pkg;

      // Highlight stay cards inside the stay modal
      document.querySelectorAll(".stayCard").forEach(c => c.classList.toggle("active", c.getAttribute("data-pkg") === pkg));

      // Hour slider only relevant for day visits
      const hoursEl = el("hours");
      if (hoursEl){
        hoursEl.disabled = (pkg !== "day");
        hoursEl.style.opacity = (pkg === "day") ? "1" : "0.35";
      }

      if (pkg === "walk") resetWalkMinutesAddon();

      syncModeUI();
      syncConditionalAddOns();
      renderStaySummary();
      fetchAvailability();
      recalc();
    }

    function renderSelectedSitter(){
      const sitter = state.selectedSitter;
      if (!sitter){
        el("selectedSitterName").textContent = "No sitter selected";
        el("selectedSitterMeta").textContent = "Choose a sitter to continue";
        el("sitterBtnTitle").textContent = "Choose sitter";
        el("sitterBtnSub").textContent = "Verified selection required";
        return;
      }
      el("selectedSitterName").textContent = sitter.name || "Selected sitter";
      const rating = sitter.rating ? ("Rating " + sitter.rating) : "Verified sitter";
      el("selectedSitterMeta").textContent = rating;
      el("sitterBtnTitle").textContent = "Sitter selected";
      el("sitterBtnSub").textContent = sitter.name || "Change sitter";
      recalc();
    }

    function normalizedSitter(s){
      return {
        id: s.id ?? s.staffId ?? s.email ?? s.name,
        name: s.name ?? s.fullName ?? "Sitter",
        rating: s.rating ?? s.score ?? "",
        role: s.role ?? s.title ?? "Pet Sitter",
        verified: (s.verified ?? s.idVerified ?? true),
        background: (s.backgroundChecked ?? s.background ?? false),
        bio: s.bio ?? s.description ?? s.notes ?? "Calm, reliable care with safety-first routines.",
        photoUrl: s.photoUrl ?? s.photo ?? s.image ?? ""
      };
    }

    function renderCarousel(){
      const vp = el("carouselViewport");
      vp.innerHTML = "";

      const staff = (state.sitters || []).map(normalizedSitter);
      if (!staff.length){
        el("carouselHint").textContent = "No sitters available for this range.";
        return;
      }

      const idx = clamp(state.carouselIndex, 0, staff.length - 1);
      state.carouselIndex = idx;

      // Prepare 3 cards: prev, current, next
      const positions = [
        { offset: -1, scale: 0.86, opacity: 0.50, z: 1, index: (idx - 1 + staff.length) % staff.length },
        { offset: 0,  scale: 1.00, opacity: 1.00, z: 3, index: idx },
        { offset: 1,  scale: 0.86, opacity: 0.50, z: 1, index: (idx + 1) % staff.length }
      ];

      positions.forEach(pos => {
        const sitter = staff[pos.index];
        const card = document.createElement("div");
        card.className = "sCard";
        card.style.setProperty("--offset", String(pos.offset));
        card.style.setProperty("--scale", String(pos.scale));
        card.style.setProperty("--opacity", String(pos.opacity));
        card.style.setProperty("--z", String(pos.z));

        card.innerHTML = `
          <div class="img">
            ${sitter.photoUrl
              ? `<img src="${sitter.photoUrl}" alt="${escapeHtml(sitter.name)}">`
              : `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.55); font-weight:800;">No photo</div>`
            }
          </div>
          <div class="body">
            <div class="sName">${escapeHtml(sitter.name)}</div>
            <div class="sMeta">${escapeHtml(sitter.role)}${sitter.rating ? " ¬∑ Rating " + escapeHtml(String(sitter.rating)) : ""}</div>
            <div class="sMeta" style="opacity:.88;">${escapeHtml(sitter.bio).slice(0, 90)}${sitter.bio && sitter.bio.length > 90 ? "..." : ""}</div>
            <div class="tags">
              <span class="tag">Verified</span>
              ${sitter.background ? '<span class="tag">Background checked</span>' : '<span class="tag">Safe booking</span>'}
            </div>
          </div>
        `;

        card.addEventListener("click", () => {
          if (pos.offset === 0){
            state.selectedSitter = sitter;
            renderSelectedSitter();
            closeModal("modalSitters");
          } else {
            // Move carousel
            if (pos.offset < 0) prevSitter();
            if (pos.offset > 0) nextSitter();
          }
        });

        vp.appendChild(card);
      });

      el("carouselHint").textContent = "Click the center card to select. Use Prev/Next to browse.";
    }

    function prevSitter(){
      if (!state.sitters || !state.sitters.length) return;
      state.carouselIndex = (state.carouselIndex - 1 + state.sitters.length) % state.sitters.length;
      renderCarousel();
    }
    function nextSitter(){
      if (!state.sitters || !state.sitters.length) return;
      state.carouselIndex = (state.carouselIndex + 1) % state.sitters.length;
      renderCarousel();
    }

    function escapeHtml(str){
      return String(str || "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function setTab(tab){
      document.querySelectorAll("#addonTabs .tab").forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === tab));
      ["care","home","transport","discounts"].forEach(name => {
        const pane = el("tab-" + name);
        if (pane) pane.style.display = (name === tab) ? "" : "none";
      });
    }

    function stepperAdjust(id, dir){
      const input = el(id);
      const v = clamp(parseInt(input.value || "0", 10) + dir, 0, 999);
      input.value = String(v);
      // mirror output text
      if (id === "checkins") el("checkinsOut").textContent = String(v);
      if (id === "keys") el("keysOut").textContent = String(v);
      if (id === "taxi") el("taxiOut").textContent = String(v);
      recalc();
    }

    function copyQuote(){
      const start = el("startDate").value;
      const end = el("endDate").value;
      const zone = el("zone").value;
      const dogs = el("dogs").value;
      const cats = el("cats").value;
      const total = el("totalOut").textContent;
      const sitter = state.selectedSitter ? state.selectedSitter.name : "None";

      const text =
`PetGuardian Care Quote
Product options: ${state.pkg}
Dates: ${start} to ${end}
Zone: ${zone}
Pets: Dogs ${dogs}${isWalkMode() ? "" : `, Cats ${cats}`}
Sitter: ${sitter}
Total estimate: ${total}`;

      navigator.clipboard.writeText(text).then(() => {
        el("btnCopy").textContent = "Copied";
        setTimeout(() => el("btnCopy").textContent = "Copy Quote", 1100);
      }).catch(() => {
        alert("Copy failed. Your browser may block clipboard access.");
      });
    }

    function openBooking(){
      el("bookingResult").textContent = "";
      openModal("modalBooking");
      recalc();
    }

    async function submitBooking(){
      const sitter = state.selectedSitter;
      if (!sitter){
        el("bookingResult").textContent = "Please select a sitter first.";
        return;
      }

      const customerName = el("customerName").value.trim();
      const customerPhone = el("customerPhone").value.trim();
      const customerEmail = el("customerEmail").value.trim();
      const customerAddress = el("customerAddress").value.trim();
      const customerNotes = el("customerNotes").value.trim();

      if (!customerName || !customerPhone || !customerEmail){
        el("bookingResult").textContent = "Please fill name, phone, and email.";
        return;
      }

      // Build selections JSON (small, but informative)
      const selections = {
        pkg: state.pkg,
        hours: Number(el("hours").value || 0),
        zone: el("zone").value,
        pets: { dogs: Number(el("dogs").value||0), cats: isWalkMode() ? 0 : Number(el("cats").value||0) },
        updateTier: currentUpdateTier(),
        checkinsPerDay: Number(el("checkins").value||0),
        walkMinutesPerDay: isWalkMode() ? 0 : Number(el("walkMinutes").value||0),
        toggles: {
          meds: el("meds").checked,
          puppy: el("puppy").checked,
          highcare: el("highcare").checked,
          reactive: el("reactive").checked,
          play: el("play").checked,
          train: el("train").checked,
          brush: el("brush").checked,
          homecare: el("homecare").checked,
          concierge: el("concierge").checked,
          pool: el("pool").checked,
          pantry: el("pantry").checked
        },
        transport: {
          keys: Number(el("keys").value||0),
          taxiTrips: Number(el("taxi").value||0),
          taxiKm: Number(el("taxiKm").value||0),
          meet: el("meet").checked,
          bath: el("bath").checked,
          camera: el("camera").checked,
          clean: el("clean").checked
        }
      };
      if (isWalkMode()){
        const billingOption = getWalkBillingOption();
        const selectedDaysCount = selectedWalkDaysCount();
        const walksPerSelectedDay = Number(el("walksPerDay").value || 1);
        const weeklyWalks = selectedDaysCount * walksPerSelectedDay;
        const weeks = billingOption === "weekly_recurring" ? Number(el("walkWeeks").value || 1) : 1;
        const billedWalks = billingOption === "monthly_subscription" ? (weeklyWalks * 4.3) : (weeklyWalks * weeks);
        selections.walkSchedule = {
          billingOption,
          startDate: el("walkStartDate").value || el("startDate").value,
          weeks,
          daysSelected: state.walkDays,
          walksPerSelectedDay,
          timeWindow: el("walkTimeWindow").value,
          minutesPerWalk: Number(el("walkMinutesPerWalk").value || 30),
          weeklyWalks,
          billedWalks,
          totalWalks: billedWalks,
          travelEstimatePerWalk: Number(el("walkTravelEstimatePerWalk").value || 25)
        };
      }

      const start = el("startDate").value;
      const end = el("endDate").value;
      const days = daysBetween(start, end);

      const totalNum = Number(el("totalOut").textContent.replace(/[^0-9]/g,"")) || 0;
      const depositNum = Number(el("depositOut").textContent.replace(/[^0-9]/g,"")) || 0;
      const balanceNum = Number(el("balanceOut").textContent.replace(/[^0-9]/g,"")) || 0;

      el("bookingResult").textContent = "Submitting booking request...";

      try{
        const walkSchedule = isWalkMode() ? (selections.walkSchedule || {}) : {};
        const res = await jsonp({
          action: "booking",
          ts: new Date().toISOString(),
          customerName, customerPhone, customerEmail,
          customerAddress, customerNotes,
          sitterId: sitter.id,
          sitterName: sitter.name,
          zone: el("zone").value,
          zoneLabel: el("zone").value,
          pkg: state.pkg,
          start, end,
          days,
          billingOption: walkSchedule.billingOption || "",
          weeklyWalks: walkSchedule.weeklyWalks ?? "",
          billedWalks: walkSchedule.billedWalks ?? "",
          travelEstimatePerWalk: walkSchedule.travelEstimatePerWalk ?? "",
          minutesPerWalk: walkSchedule.minutesPerWalk ?? "",
          walkDaysSelected: (walkSchedule.daysSelected || []).join(","),
          walksPerSelectedDay: walkSchedule.walksPerSelectedDay ?? "",
          weeks: walkSchedule.weeks ?? "",
          total: totalNum,
          deposit: depositNum,
          balance: balanceNum,
          selectionsJson: JSON.stringify(selections),
          walkScheduleJson: isWalkMode() ? JSON.stringify(walkSchedule) : ""
        });

        if (res && res.ok){
          el("bookingResult").textContent = "Booking request sent successfully.";
          // refresh availability (sitters may be blocked automatically)
          fetchAvailability();
        } else {
          el("bookingResult").textContent = "Booking failed: " + (res && res.error ? res.error : "Unknown error");
        }
      }catch(err){
        el("bookingResult").textContent = "Booking failed. Check API status and try again.";
        if (CONFIG.debug) console.error(err);
      }
    }

    function wire(){
      // Top buttons
      el("btnPricingInfo").addEventListener("click", () => openModal("modalPricing"));
      el("btnClosePricing").addEventListener("click", () => closeModal("modalPricing"));

      // API status pill test (helps diagnose mobile issues)
      const apiBtn = document.getElementById("apiPillBtn");
      if (apiBtn){
        apiBtn.addEventListener("click", () => {
          const baseRaw = getApiBaseWorking() || (CONFIG.apiBaseUrl || "").trim();
          if (!baseRaw) return;
          const base = baseRaw.startsWith("http") ? baseRaw : ("https://" + baseRaw);
          const u = new URL(base);
          u.searchParams.set("action", "pricing");
          u.searchParams.set("_", Date.now().toString(36));
          // Open a simple JSON response (no callback) so it's easy to verify on any device
          const testUrl = u.toString();
          try {
            const w = window.open(testUrl, "_blank");
            if (!w) window.location.href = testUrl;
          } catch(e){
            window.location.href = testUrl;
          }
        });
      }

      el("btnOpenStay").addEventListener("click", () => openModal("modalStay"));
      el("btnCloseStay").addEventListener("click", () => closeModal("modalStay"));
      document.querySelectorAll(".staySelect").forEach(btn => {
        btn.addEventListener("click", () => {
          const pkg = btn.getAttribute("data-select");
          if (pkg) setPkg(pkg);
          closeModal("modalStay");
        });
      });


      el("btnOpenAddons").addEventListener("click", () => openModal("modalAddons"));
      el("btnCloseAddons").addEventListener("click", () => closeModal("modalAddons"));

      el("btnOpenSitters").addEventListener("click", () => openModal("modalSitters"));
      el("btnCloseSitters").addEventListener("click", () => closeModal("modalSitters"));

      el("btnPrev").addEventListener("click", prevSitter);
      el("btnNext").addEventListener("click", nextSitter);
      el("btnSelectCenter").addEventListener("click", () => {
        const staff = (state.sitters || []).map(normalizedSitter);
        if (!staff.length) return;
        const sitter = normalizedSitter(state.sitters[state.carouselIndex] || staff[0]);
        state.selectedSitter = sitter;
        renderSelectedSitter();
        closeModal("modalSitters");
      });

      el("btnCopy").addEventListener("click", copyQuote);
      if (el("btnCopyPanel")) el("btnCopyPanel").addEventListener("click", copyQuote);
      if (el("btnPricingInfoPanel")) el("btnPricingInfoPanel").addEventListener("click", () => openModal("modalPricing"));
      el("btnOpenBooking").addEventListener("click", openBooking);
      el("btnRequestBooking").addEventListener("click", openBooking);
      if (el("btnMobileBooking")) el("btnMobileBooking").addEventListener("click", openBooking);

      el("btnCloseBooking").addEventListener("click", () => closeModal("modalBooking"));
      el("btnSubmitBooking").addEventListener("click", submitBooking);

      // Change sitter shortcut
      el("btnChangeSitter").addEventListener("click", () => openModal("modalSitters"));

      // Package selection
      document.querySelectorAll(".pkgBtn").forEach(b => {
        b.addEventListener("click", () => setPkg(b.getAttribute("data-pkg")));
      });

      // Inputs that change availability
      ["startDate","endDate","zone","walkStartDate","walkWeeks","walksPerDay","walkTimeWindow","walkBillingOption"].forEach(id => {
        el(id).addEventListener("change", () => {
          renderPriceHints();
          recalc();
          fetchAvailability();
        });
      });

      // Inputs that affect price
      ["hours","dogs","cats","walkMinutes","taxiKm","walkMinutesPerWalk","walkTravelEstimatePerWalk"].forEach(id => {
        el(id).addEventListener("input", () => {
          if (id === "hours"){
            el("hoursOut").textContent = el("hours").value;
            if (el("hoursModalOut")) el("hoursModalOut").textContent = el("hours").value;
            renderStaySummary();
          }
          if (id === "walkMinutes"){
            el("walkMinutesOut").textContent = el("walkMinutes").value;
            el("walkCostOut").textContent = money(Number(el("walkMinutes").value) * Number(PRICES.add.walkPerMinute||0));
          }
          if (id === "walkMinutesPerWalk"){
            el("walkMinutesPerWalkOut").textContent = el("walkMinutesPerWalk").value;
          }
          recalc();
        });
      });

      ["puppy","meds","highcare","reactive","play","train","brush","homecare","concierge","pool","camera","bath","clean","pantry","meet"].forEach(id => {
        el(id).addEventListener("change", recalc);
      });

      // Add-on tabs
      document.querySelectorAll("#addonTabs .tab").forEach(t => {
        t.addEventListener("click", () => setTab(t.getAttribute("data-tab")));
      });

      // Update method selection
      document.querySelectorAll(".radioCard[data-upd]").forEach(c => {
        c.addEventListener("click", () => setUpdateTier(c.getAttribute("data-upd")));
      });

      // Steppers
      document.querySelectorAll("[data-stepper]").forEach(btn => {
        btn.addEventListener("click", () => stepperAdjust(btn.getAttribute("data-stepper"), Number(btn.getAttribute("data-dir"))));
      });

      // Numeric stepper input manual typing
      ["checkins","keys","taxi"].forEach(id => {
        el(id).addEventListener("input", () => {
          el(id).value = String(clamp(parseInt(el(id).value || "0", 10), 0, 999));
          if (id === "checkins") el("checkinsOut").textContent = el(id).value;
          if (id === "keys") el("keysOut").textContent = el(id).value;
          if (id === "taxi") el("taxiOut").textContent = el(id).value;
          recalc();
        });
      });

      // Close modals when clicking outside modal content
      ["modalPricing","modalAddons","modalSitters","modalBooking"].forEach(mid => {
        el(mid).addEventListener("click", (e) => {
          if (e.target === el(mid)) closeModal(mid);
        });
      });
    }

    function setDefaultDates(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      const today = `${yyyy}-${mm}-${dd}`;
      el("startDate").value = today;
      el("endDate").value = today;
      if (el("walkStartDate")) el("walkStartDate").value = today;
    }

    async function boot(){
      // Ensure logo is used
      document.querySelector(".logoWrap img").src = CONFIG.logoUrl;

      // Preview faces on button
      (CONFIG.facePreviews || []).slice(0,3).forEach((src, i) => {
        const img = document.getElementById("facePrev" + i);
        if (img) img.src = src;
      });

      setDefaultDates();
      renderWalkDays();
      setupStepAccordion();
      setupQuoteUI();
      wire();

      await pingApi();
      await fetchPricing();
      renderPriceHints();
      await fetchAvailability();
      syncModeUI();
      renderSelectedSitter();
      recalc();
    }

    boot();
  </script>
</body>
</html>
